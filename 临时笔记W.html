<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Janvy's blog | Janvy's blog</title><meta name="author" content="Janvy Sun"><meta name="copyright" content="Janvy Sun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文档链接Java8 新特性https:&#x2F;&#x2F;www.jianshu.com&#x2F;nb&#x2F;27231419 https:&#x2F;&#x2F;www.runoob.com&#x2F;java&#x2F;java8-new-features.html 设计模式https:&#x2F;&#x2F;www.coonote.com&#x2F;cpp-design-pattern&#x2F;how-to-learn-cpp-design-patterns.html (C++) https:&#x2F;&#x2F;"><meta property="og:type" content="website"><meta property="og:title" content="Janvy&#39;s blog"><meta property="og:url" content="https://janvysun.github.io/%E4%B8%B4%E6%97%B6%E7%AC%94%E8%AE%B0W.html"><meta property="og:site_name" content="Janvy&#39;s blog"><meta property="og:description" content="文档链接Java8 新特性https:&#x2F;&#x2F;www.jianshu.com&#x2F;nb&#x2F;27231419 https:&#x2F;&#x2F;www.runoob.com&#x2F;java&#x2F;java8-new-features.html 设计模式https:&#x2F;&#x2F;www.coonote.com&#x2F;cpp-design-pattern&#x2F;how-to-learn-cpp-design-patterns.html (C++) https:&#x2F;&#x2F;"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://janvysun.github.io/images/hexo.png"><meta property="article:published_time" content="2024-06-18T07:40:37.918Z"><meta property="article:modified_time" content="2024-06-18T07:40:37.918Z"><meta property="article:author" content="Janvy Sun"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://janvysun.github.io/images/hexo.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://janvysun.github.io/%E4%B8%B4%E6%97%B6%E7%AC%94%E8%AE%B0W"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: [object Object]
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Janvy's blog",isPost:!1,isHome:!1,isHighlightShrink:!1,isToc:!1,postUpdate:"2024-06-18 15:40:37"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">154</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="not-home-page" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Janvy's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="page-site-info"><h1 id="site-title">Janvy's blog</h1></div></header><main class="layout" id="content-inner"><div id="page"><div id="article-container"><h1 id="文档链接"><a href="#文档链接" class="headerlink" title="文档链接"></a>文档链接</h1><h2 id="Java8-新特性"><a href="#Java8-新特性" class="headerlink" title="Java8 新特性"></a>Java8 新特性</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/nb/27231419">https://www.jianshu.com/nb/27231419</a></p><p><a target="_blank" rel="noopener" href="https://www.runoob.com/java/java8-new-features.html">https://www.runoob.com/java/java8-new-features.html</a></p><h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><p><a target="_blank" rel="noopener" href="https://www.coonote.com/cpp-design-pattern/how-to-learn-cpp-design-patterns.html">https://www.coonote.com/cpp-design-pattern/how-to-learn-cpp-design-patterns.html</a> (C++)</p><p><a target="_blank" rel="noopener" href="https://www.runoob.com/design-pattern/design-pattern-resources.html">https://www.runoob.com/design-pattern/design-pattern-resources.html</a> (Java)</p><h2 id="CPP-源码解析"><a href="#CPP-源码解析" class="headerlink" title="CPP 源码解析"></a>CPP 源码解析</h2><p>libevent 分析系列文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/sparkliang/category_660506.html">https://blog.csdn.net/sparkliang/category_660506.html</a></p><h2 id="Github-美化"><a href="#Github-美化" class="headerlink" title="Github 美化"></a>Github 美化</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/533850515">https://zhuanlan.zhihu.com/p/533850515</a></p><h2 id="QT"><a href="#QT" class="headerlink" title="QT"></a>QT</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_73443478/category_12075511.html">https://blog.csdn.net/m0_73443478/category_12075511.html</a></p><h2 id="CLION"><a href="#CLION" class="headerlink" title="CLION"></a>CLION</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7184793007302901820">https://juejin.cn/post/7184793007302901820</a></p><h2 id="STL"><a href="#STL" class="headerlink" title="STL"></a>STL</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/junxuezheng/category_12212735.html">https://blog.csdn.net/junxuezheng/category_12212735.html</a></p><h2 id="极客时间"><a href="#极客时间" class="headerlink" title="极客时间"></a>极客时间</h2><p>极客时间合集：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/zVMrsNmFRJ9">https://www.aliyundrive.com/s/zVMrsNmFRJ9</a> 提取码: ie92</p><h2 id="小说"><a href="#小说" class="headerlink" title="小说"></a>小说</h2><p>1、飞卢小说<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/Hw6oYcQRDqj">https://www.aliyundrive.com/s/Hw6oYcQRDqj</a></p><p>2、精校200W字以上长篇小说100部<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/1gzxPWV932t">https://www.aliyundrive.com/s/1gzxPWV932t</a></p><p>3、5300本小说<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/mxepq5iJohZ">https://www.aliyundrive.com/s/mxepq5iJohZ</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/SzT27JUwWmn">https://www.aliyundrive.com/s/SzT27JUwWmn</a></p><p>4、玄幻小说<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/h1tjV3Q8tw8">https://www.aliyundrive.com/s/h1tjV3Q8tw8</a></p><p>5、仙侠小说<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/npk655nhAKM">https://www.aliyundrive.com/s/npk655nhAKM</a></p><p>6、500男频VIP<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/tByCCQby8Yc">https://www.aliyundrive.com/s/tByCCQby8Yc</a></p><p>7、TXT电子书全集打包（70000本）<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/TcXvTVpKo8M">https://www.aliyundrive.com/s/TcXvTVpKo8M</a></p><p>8、2013~2019年万本小说合集<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/pWUjjpi9kcs">https://www.aliyundrive.com/s/pWUjjpi9kcs</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/UvG8YtvmjmZ">https://www.aliyundrive.com/s/UvG8YtvmjmZ</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/i2DzCM2cJbz">https://www.aliyundrive.com/s/i2DzCM2cJbz</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/WRBDU43HVMq">https://www.aliyundrive.com/s/WRBDU43HVMq</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/m5b12NyPj2S">https://www.aliyundrive.com/s/m5b12NyPj2S</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/YnBA71ATYnS">https://www.aliyundrive.com/s/YnBA71ATYnS</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/Zb4SC4T9VFB">https://www.aliyundrive.com/s/Zb4SC4T9VFB</a></p><p>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/XTfcM18FpPi">https://www.aliyundrive.com/s/XTfcM18FpPi</a></p><p>“2013~2019年万本小说合集”目录<br>链接：<a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/nsD77PwDkUB">https://www.aliyundrive.com/s/nsD77PwDkUB</a></p><p>书荒的朋友可以看看。</p><h2 id="黑马-Java"><a href="#黑马-Java" class="headerlink" title="黑马 Java"></a>黑马 Java</h2><p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1fZTAyjQGM4j58CX2vVGf2w?pwd=hrnc">https://pan.baidu.com/s/1fZTAyjQGM4j58CX2vVGf2w?pwd=hrnc</a></p><p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/11fK8vOyGYiZefHGb9hl9DA?pwd=jtkx">https://pan.baidu.com/s/11fK8vOyGYiZefHGb9hl9DA?pwd=jtkx</a></p><br><h2 id="CAS-相关"><a href="#CAS-相关" class="headerlink" title="CAS 相关"></a>CAS 相关</h2><p><a target="_blank" rel="noopener" href="http://www.ibloger.net/tags-1641.html">http://www.ibloger.net/tags-1641.html</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010475041/category_7156505.html">https://blog.csdn.net/u010475041/category_7156505.html</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/anumbrella/category_7765386.html">https://blog.csdn.net/anumbrella/category_7765386.html</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhuwei_clark/article/details/90450316">https://blog.csdn.net/zhuwei_clark/article/details/90450316</a></p><h3 id="https-www-javaxks-com-cat-177"><a href="#https-www-javaxks-com-cat-177" class="headerlink" title="https://www.javaxks.com/?cat=177"></a><a target="_blank" rel="noopener" href="https://www.javaxks.com/?cat=177">https://www.javaxks.com/?cat=177</a></h3><h4 id="cas安装篇"><a href="#cas安装篇" class="headerlink" title="cas安装篇"></a>cas安装篇</h4><ul><li>CAS之5.2x版本单点登录服务安装-yellowcong</li></ul><h4 id="cas-进阶篇"><a href="#cas-进阶篇" class="headerlink" title="cas 进阶篇"></a>cas 进阶篇</h4><ul><li>CAS之5.2x版本自定义登录页面-yellowcong</li><li>CAS之5.2x版本自定义返回消息-yellowcong</li><li>CAS之5.2x版本自定义错误信息-yellowcong</li><li>CAS之5.2x版本之服务器开发调试&amp;#xff08;eclipse调试cas&amp;#xff09;-yellowcong</li><li>CAS之5.1.x版本自定义表单信息-yellowcong</li><li>CAS之5.2.x版本自定义表单信息-yellowcong</li><li>CAS之 5.2x版本配置数据库认证-yellowcong</li><li>Cas5.2之存储Service信息到数据库-yellowcong</li><li>Cas5.2之用户密码邮箱找回-yellowcong</li><li>CAS之5.2x版本之OAuth2.0-yellowcong</li><li>CAS之5.2x版本之REST验证ticket&amp;#xff08;跨系统访问资源&amp;#xff09;-yellowcong</li><li>CAS之5.2x版本之Ajax方式提交表单-yellowcong</li><li>CAS之5.2x版本登录验证码-yellowcong</li><li>CAS之5.2x版本存储Ticket到redis-yellowcong</li><li>CAS5.2之通过Rest来动态访问子系统资源-yellowcong</li><li>CAS之5.2x版本之服务管理-yellowcong</li><li>CAS之5.2x版本之单点登录退出-yellowcong</li><li>CAS之5.2x版本自定义登录&amp;#xff0c;多数据源登录-yellowcong</li><li>Shiro之CAS单点登录-yellowcong</li><li>Cas之5.2.x版本单点登录自定义REST认证-yellowcong</li><li>CAS之5.2x版本自定义密码验证-yellowcong</li><li>Cas5.2之管理登录后一直显示Lodding-yellowcong</li><li>Cas5.2之Management 通过Mysql管理服务-yellowcong</li><li>Cas5.2之Cas的java客户端-yellowcong</li><li>CAS之5.2x版本配置密码加密(MD5和SHA)-yellowcong</li><li>CAS之5.2x版本自定义密码验证-yellowcong</li></ul><h4 id="集成篇"><a href="#集成篇" class="headerlink" title="集成篇"></a>集成篇</h4><ul><li>CAS之5.2x版本之Gerrit单点登录-yellowcong</li><li>Cas5.2之Gerrit创建用户并关联-yellowcnog</li><li>CAS之5.2x版本之Jenkins单点登录-yellowcong</li><li>CAS之5.2x版本之Gitlab单点登录-yellowcong</li><li>CAS之5.2x版本之Confluence单点登录-yellowcong</li><li>CAS之5.2x版本之Jira单点登录(7.2)版本-yellowcong</li><li>CAS之5.2x版本之Jira单点登录(8.x)版本-yellowcong</li><li>CAS之5.2x版本之客户端集成&amp;#xff08;Springboot&amp;#xff09;-yellowcong</li><li>CAS之5.2x版本之客户端集成&amp;#xff08;传统web项目&amp;#xff09;-yellowcong</li><li>graylog接入cas-yelowcong</li><li>Cas之Sonar接入sso-yellowcong</li><li>Grafana与cas集成-yellowcong</li><li>Grafana与cas集成-yellowcong</li><li>ldap和cas整合|第七章-yellowcong</li></ul><h1 id="WT"><a href="#WT" class="headerlink" title="WT"></a>WT</h1><h2 id="去除右击打开-WT（Win10）"><a href="#去除右击打开-WT（Win10）" class="headerlink" title="去除右击打开 WT（Win10）"></a>去除右击打开 WT（Win10）</h2><p>Windows Terminal 安装完成之后，在桌面鼠标右击会显示「在 Windows Terminal 中打开」的一个选项，可以修改注册表来关闭它。</p><p>新建一个 <code>.reg</code> 文件，在其中写入如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Shell Extensions\Blocked]</span><br><span class="line">&quot;&#123;9F156763-7844-4DC4-B2B1-901F640F5155&#125;&quot;=&quot;WindowsTerminal&quot;</span><br></pre></td></tr></table></figure><p>然后双击运行它，之后重启电脑或者注销用户即可生效。</p><br><h1 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h1><p>TIMESTAMPDIFF定义：函数日期或日期时间表达式之间的整数差</p><p>DB2中采用TIMESTAMPDIFF方法<br><code>TIMESTAMPDIFF( n , CHAR(TIMESTAMP(&#39;2021-05-08-11.07.22&#39;)-TIMESTAMP(&#39;2021-05-08-11.08.22&#39;)))</code></p><p>其中的 n 可以使用其他的值来代替，看需要的是哪些结果的时间单位</p><ul><li>1：毫秒</li><li>2：秒</li><li>4：分</li><li>8：时</li><li>16：天</li><li>32：周</li><li>64：月</li><li>128：季度</li><li>256：年</li></ul><p>MYSQL中采用TIMESTAMPDIFF方法： <code>TIMESTAMPDIFF(n，datetime1，datetime2)</code>，需要将n的值改成以下格式</p><ul><li>FRAC_SECOND：毫秒</li><li>SECOND：秒</li><li>MINUTE：分钟</li><li>HOUR：小时</li><li>DAY：天</li><li>WEEK：星期</li><li>MONTH：月</li><li>QUARTER：季度</li><li>YEAR：年</li></ul><br><h1 id="on-my-posh"><a href="#on-my-posh" class="headerlink" title="on my posh"></a>on my posh</h1><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>1、字体安装：</p><p>可能出现乱码，字体安装推荐像Cascadia Code的字体，Caskaydia Cove Nerd Font | 下载</p><p>2、安装oh-my-posh</p><p>winget install oh-my-posh<br>3、配置主题，其中xxx.omp.json为你想要的主题名称，样式预览 oh-my-posh3主题预览 - 久漫 - 博客园 (cnblogs.com) ，其中查看主题位置可以使用命令 $env:POSH_THEMES_PATH</p><p>notepad $PROFILE<br>#最后一行输入<br>oh-my-posh init pwsh –config “$env:POSH_THEMES_PATH\paradox.omp.json” | Invoke-Expression<br>4、其中PowerShell文件图标需要额外的安装</p><p>Install-Module -Name Terminal-Icons -Repository PSGallery<br>Import-Module -Name Terminal-Icons<br>Get-ChildItem -Path . -Force ##查看效果<br>每次重启PowerShell都要重新导入模块 Import-Module -Name Terminal-Icons，为了避免这种情况，在配置文件中加入即可，每次启动都会自动使用这个命令了。</p><p>notepad $PROFILE<br>#最后一行输入<br>Import-Module -Name Terminal-Icons</p><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><p>1、字体安装教程 ： ubuntu安装字体</p><p>2、安装oh-my-posh</p><p>参考链接： Linux | Oh My Posh</p><p>sudo wget <a target="_blank" rel="noopener" href="https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/posh-linux-amd64">https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/posh-linux-amd64</a> -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;oh-my-posh<br>sudo chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;oh-my-posh<br>3、载入them</p><p>mkdir <del>&#x2F;.poshthemes<br>wget <a target="_blank" rel="noopener" href="https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/themes.zip">https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/themes.zip</a> -O ~&#x2F;.poshthemes&#x2F;themes.zip<br>unzip ~&#x2F;.poshthemes&#x2F;themes.zip -d ~&#x2F;.poshthemes<br>chmod u+rw ~&#x2F;.poshthemes&#x2F;<em>.omp.</em><br>rm ~&#x2F;.poshthemes&#x2F;themes.zip<br>主题可以直接在Themes | Oh My Posh 查看，找到喜欢的json名字，在</del>&#x2F;.poshthemes下查看是否存在。</p><p>4、启用主题，xxx.omp.json为你想要的主题（如果要默认启动就在etc&#x2F;profile最后一行加入这个）</p><p>eval “$(oh-my-posh –init –shell bash –config ~&#x2F;.poshthemes&#x2F;clean-detailed.omp.json)”</p><br><h1 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h1><p>Hash 函数是一种将集合 S 转换成具有固定长度的、不可逆的的集合 U 的单射，它的值一般为数字合字母的组合，Hash 函数拥有无限的输入空间，却只有有限的输出空间，这意味着 Hash 函数一定会产生碰撞，一个好的 Hash 函数可以显著的降低碰撞概率。Hash 函数一般有一下特征：</p><p>一致性。Hash 函数可以接受任意大小的数据，并输出固定长度的散列值，同时输出不同值的概率应该尽可能一致。如 CityHash128，不管原始数据有多大，计算得到的 hash 值总是 128 bit。<br>雪崩效应。原始数据哪怕只有一个字节的修改，得到的 hash 值都会发生巨大的变化。<br>单向。只能从原始数据计算得到 hash 值，不能从 hash 值计算得到原始数据。所以散列算法不是加密解密算法，加密解密是可逆的，散列算法是不可逆的。<br>避免冲突。几乎不可能找到一个数据和当前计算的这个数据计算出一样的 hash 值，因此散列函数能够确保数据的唯一性。在 Hash 函数保证不同值出现的概率一致的情况下，CityHash128 出现碰撞的概率只有 2 ^ -128。因为不同 Key 的碰撞概率很小，所以在某些情况下我们可以直接使用较短的 Hash 值代替较长原始数据存储。</p><p>常见的 Hash 函数有：</p><ul><li>CRC32 (Cyclic Redundancy Check 32)：循环冗余校验，能够快速的生成 32 位 Hash 值，主要用于数据完整性校验。</li><li>SipHash: SipHash 并不是为了速度设计的，与其他 Hash 函数相比速度上不占优势，而提供了 HashDoS 保护，是 Rust 中的 Hash 函数的默认实现，最新 Redis 中也在使用 SipHash；</li><li>MurMurHash：经典快速的 Hash 函数，目前最新的版本是 MurMurHash3，可以生成 32 位或者 128 位 Hash 值；</li><li>CityHash: 来自于 Google 实现，受到 MurmurHash 启发，但是比 MurmurHash 更快，可以输出 64 位、128 位或者 256 位 Hash 值。ClickHouse 内置；</li><li>XXHash: 针对小数据集速度非常快，支持输出 32 位、64 位、128 位 Hash 值，Github 开源，SSE 支持。ClickHouse 内置。</li><li>MD5 (Message Digest Algorithm 5)：将输入数据分成固定大小的块，并生成一个固定长度的哈希值作为摘要。</li><li>SHA-1 (Secure Hash Algorithm 1)：将输入数据转换为160位的哈希值，具有较好的安全性和广泛应用。</li><li>SHA-256 (Secure Hash Algorithm 256-bit)：SHA-2系列中的一种，生成256位哈希值，安全性更高。</li><li>SHA-512 (Secure Hash Algorithm 512-bit)：SHA-2系列中的一种，生成512位哈希值，安全性更高。</li><li>SHA-3 (Secure Hash Algorithm 3)：基于Keccak算法，生成哈希值的长度可以选择，具有高度的安全性。</li><li>RIPEMD-160 (RACE Integrity Primitives Evaluation Message Digest 160)：生成160位哈希值，主要应用于数字签名等领域。</li><li>Tiger：基于三个独立的部分进行哈希计算，生成长度为192位的哈希值。</li><li>Whirlpool：使用Merkle-Damgård结构，生成512位哈希值，适用于密码学和数字签名等领域。</li><li>Blake2：一种高度并行的哈希函数，支持不同的输出长度，安全性高且速度快。</li><li>GOST (GOST R 34.11-94)：俄罗斯标准的哈希算法，生成256位哈希值，广泛应用于俄罗斯的加密标准。</li><li>SM3：中国国家密码管理局发布的密码杂凑算法标准，生成256位哈希值。</li><li>MurmurHash：一种快速非加密哈希函数，主要用于散列映射和数据查找。</li><li>FNV (Fowler-Noll-Vo) Hash：一种快速非加密哈希函数，适用于散列和校验和计算。</li><li>Jenkins Hash：一种非加密哈希函数，被广泛用于哈希表和散列映射算法。</li><li>Adler-32：通过使用Adler校验和算法生成32位哈希值，常用于快速校验数据完整性。</li><li>SipHash：一种快速、安全的哈希算法，特别适用于防止哈希碰撞和DoS攻击。</li><li>BLAKE3：一种高度并行的哈希函数，基于BLAKE2，具有出色的速度和安全性。</li><li>PBKDF2 (Password-Based Key Derivation Function 2)：基于密码的键派生函数，通过迭代应用一个伪随机函数来生成密钥。</li><li>bcrypt：一种基于Blowfish密码算法的哈希函数，特点是慢速且可调节的计算成本，用于密码存储和验证。</li><li>scrypt：一种基于密码学的派生函数，旨在提供对硬件攻击的抵抗力，适用于密码存储和密钥派生。</li><li>Argon2：密码哈希函数的一种变体，旨在提供更高的抗击穷举攻击和侧信道攻击的安全性。</li><li>WPA&#x2F;WPA2：Wi-Fi Protected Access协议使用的哈希算法，通过预共享密钥生成会话密钥，用于保护Wi-Fi网络。</li><li>HMAC (Hash-based Message Authentication Code)：基于哈希函数和密钥的消息认证码，用于验证消息的完整性和真实性。</li><li>GHash：用于加密算法中的哈希函数，如AES-GCM模式中的消息认证码。</li><li>Poly1305：一种用于消息认证码的快速且安全的哈希函数，广泛用于加密协议中。</li><li>BLAKE2b：BLAKE2家族中的一种变体，生成更长的哈希值，具有出色的性能和安全性。</li><li>Salsa20：一种流密码算法，可以通过哈希函数生成伪随机流，用于加密和消息完整性校验。</li><li>Keccak：作为SHA-3标准的基础，它是一个全新的哈希函数家族，提供更高的安全性和灵活性。</li><li>Rabin：一种基于整数因子分解的哈希算法，用于数据完整性校验和数字签名。</li><li>Snefru：将输入数据分成不同大小的块，并通过迭代压缩函数生成哈希值。</li><li>Whirlwind：一种快速的哈希算法，将输入数据分成不同大小的块，然后通过迭代处理生成哈希值。</li><li>TTH (Tiger Tree Hash)：基于Tiger哈希算法的树状哈希函数，用于文件完整性校验。</li><li>GOST R 34.11-2012：俄罗斯标准的更新版本，生成256位哈希值，用于数字签名和数据完整性校验。</li><li>Skein：与SHA-3竞争的候选算法之一，通过迭代计算生成哈希值，支持可变的输出长度。</li><li>HAVAL：一种变长的哈希算法，通过迭代变换生成哈希值，可生成不同长度的摘要。</li><li>LM Hash (LAN Manager Hash)：用于旧版Windows密码存储的哈希函数，现已被弃用。</li><li>RipeMD：一系列变种的哈希函数，生成不同长度的哈希值，用于数据完整性校验和消息认证。</li><li>ECOH (Extendable Collision Resistant Hash)：一种可扩展抗碰撞哈希算法，能够在不改变已有哈希值的情况下追加新数据。</li><li>FSB (Fast Syndrome Based Hash)：一种快速的哈希算法，通过使用纠错码的编码和解码过程生成哈希值。</li><li>HAMS (Hashed Message Syntax)：一种基于哈希值的消息语法，将消息和哈希值组合成结构化的数据。</li><li>PHOTON：基于SPONGENT置换和置换网络的轻量级哈希算法，适用于低功耗设备和受限环境。</li><li>QSH (Quantum Secure Hash)：一种针对量子计算机攻击的安全哈希算法，具有抗量子算法的特性。</li><li>Kupyna：乌克兰标准的哈希函数，生成256位和512位哈希值，适用于密码学和安全领域。</li><li>SWIFFT (Strongly Universal Weighing-Independent Families of Fast Transformations)：基于置换和线性变换的哈希函数，具有强大的安全性和快速性能。</li><li>Farfalle：一种快速的伪随机函数和哈希函数，基于SP-network结构，适用于密码学和协议设计。</li><li>High-DS (Highly Distributed System)：一种用于分布式系统的哈希函数，将数据映射到节点以实现负载均衡。</li><li>Tangle：一种基于有向无环图（DAG）的哈希函数，用于IOTA加密货币的事务验证和存储。</li><li>Streebog：俄罗斯标准的哈希函数，生成256位和512位哈希值，广泛应用于密码学和安全领域。</li><li>Poly1305-AES：使用AES加密算法和Poly1305消息认证码生成哈希值，用于身份验证和数据完整性校验。</li><li>GGM (Gill, Gong, and Micali)：一种基于伪随机生成器的哈希函数，具有随机性和抗碰撞特性。</li><li>HAS-160 (HAsh Secure-160)：一种生成160位哈希值的哈希算法，主要用于数据完整性校验和数字签名。</li><li>SWIFFTX：SWIFFT算法的扩展版本，具有更高的安全性和性能，适用于密码学和通信协议。</li><li>SPHINCS (SPHINCS+ and SPHINCS-256)：基于哈希函数的签名方案，提供抗量子攻击和前向保密性。</li><li>BLAKE-I：BLAKE哈希函数的改进版本，通过增加迭代次数提高安全性。</li><li>SipHash-2-4: SipHash算法的变种，使用2轮和4轮的置换和混合操作生成哈希值。</li><li>JH：SHA-3竞争中的候选算法之一，使用置换和置换网络生成哈希值，具有良好的安全性和性能。</li><li>TTS (Two-Track-SHA)：一种双轨哈希函数，通过两个独立的哈希路径生成哈希值，提供更高的安全性和抗碰撞能力。</li><li>DAGS (Directed Acyclic Graph-based Signature)：基于有向无环图的签名方案，通过哈希函数生成签名和验证。</li><li>LSH (Locality Sensitive Hashing)：一种用于近似最近邻搜索的哈希算法，将相似的数据映射到相邻的哈希桶中。</li><li>TurboHash：一种基于置换和混淆操作的哈希算法，提供高性能的哈希计算。</li><li>SeaHash：一种快速的哈希算法，通过混合位运算和乘法操作生成哈希值。</li><li>Cuckoo Hashing：一种使用两个哈希函数的哈希表实现，用于解决哈希冲突的方法。</li><li>TMH (Tree-based Merkle Hash)：一种基于Merkle树结构的哈希算法，用于数据完整性校验和验证。</li><li>Hamsi：一种基于SP-network结构的哈希函数，具有良好的安全性和高速性能。</li><li>Lesamnta：一种基于SP-network结构和差分运算的哈希算法，具有高度的安全性和性能。</li><li>SWIFFT-MD：SWIFFT算法的变种，通过迭代应用混淆和置换操作生成哈希值。</li><li>ABC (Another Bit Compression)：一种快速的哈希函数，使用位压缩技术生成哈希值。</li><li>QHash：基于量子力学原理的哈希算法，提供抗量子计算攻击的特性。</li><li>Khichidi-1：一种基于位级混洗和布尔运算的哈希算法，适用于低功耗设备和资源受限环境。</li><li>Buzhash：一种快速的滚动哈希算法，通过位运算和异或操作生成哈希值。</li><li>StepRightUp：一种递增哈希算法，每次迭代将输入数据向右移动一个位置，生成哈希值。</li><li>FarmHash：Google开发的一系列快速哈希函数，适用于广泛的用途，包括散列和校验和计算。</li><li>HalfSipHash：SipHash算法的变种，生成较短的哈希值，适用于快速的校验和计算。</li><li>CitiHash：一种基于CityHash算法的哈希函数，用于快速的哈希计算。</li><li>XXH3 (XXHash3)：XXHash算法的最新版本，提供高速的哈希计算和低碰撞概率。</li><li>XXH64 (XXHash64)：XXHash算法的64位版本，适用于64位哈希值的计算和校验。</li><li>HighwayHash：一种基于SIMD指令集的快速哈希算法，适用于高性能的哈希计算和校验。</li></ul><h2 id="FNV"><a href="#FNV" class="headerlink" title="FNV"></a>FNV</h2><p>由来：FNV哈希 算法全名为Fowler-Noll-Vo算法，是以三位发明人Glenn Fowler，Landon Curt Noll，Phong Vo的名字来命名的，最早在1991年提出。<br>特点和用途：FNV能快速hash大量数据并保持较小的冲突率，它的高度分散使它适用于hash一些非常相近的字符串，比如URL，hostname，文件名，text，IP地址等。</p><p>算法版本：FNV算法有三个版本：<code>FNV-0（已废弃）</code>、<code>FNV-1</code>和<code>FNV-1a</code></p><p><code>FNV-1</code> 和 <code>FNV-1a</code>算法对于最终生成的哈希值（hash）有一定限制<br>1，hash是无符号整型<br>2，hash的位数（bits），应该是2的n次方（32，64，128，256，512，1024），一般32位的就够用了。</p><h3 id="算法描述"><a href="#算法描述" class="headerlink" title="算法描述"></a>算法描述</h3><p>相关变量：</p><ul><li>hash 值：一个 n 位的 unsigned int 型 hash 值</li><li>offset_basis：初始的哈希值</li><li>FNV_prime：FNV 用于散列的质数</li><li>octet_of_data：8 位数据（即一个字节）</li></ul><p>FNV-1描述：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hash = offset_basis</span><br><span class="line">for each octet_of_data to be hashed</span><br><span class="line">hash = hash * FNV_prime</span><br><span class="line">hash = hash xor octet_of_data</span><br><span class="line">return hash</span><br></pre></td></tr></table></figure><p>FNV-1a描述：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hash = offset_basis </span><br><span class="line">for each octet_of_data to be hashed</span><br><span class="line">hash = hash xor octet_of_data</span><br><span class="line">hash = hash * FNV_prime</span><br><span class="line">return hash</span><br></pre></td></tr></table></figure><p>FNV-1a 和 FNV-1 的唯一区别就是 xor 和 multiply 的顺序不同，他们所采用的 FNV_prime 和 offset_basis 都相同，有人认为 FNV-1a 在进行小数据（小于4个字节）哈希时有更好的性能。<br>for each octet_of_data to be hashed 意思是对于你要算哈希值的数，它的每一个字节。<br>hash &#x3D; hash * FNV_prime，是包含取模运算的，具体看你采用多少位的哈希函数。例如，你用32为哈希，hash &#x3D; hash * FNV_prime % （2的32次方）；<br>hash &#x3D; hash xor octet_of_data，意思是把当前取来的字节和当前的 hash 值的第八位做异或运算。</p><p>FNV_prime的取值:<br>32 bit FNV_prime &#x3D; 2^24 + 2^8 + 0x93 &#x3D; 16777619<br>64 bit FNV_prime &#x3D; 2^40 + 2^8 + 0xb3 &#x3D; 1099511628211<br>128 bit FNV_prime &#x3D; 2^88 + 2^8 + 0x3b &#x3D; 309485009821345068724781371<br>256 bit FNV_prime &#x3D; 2^168 + 2^8 + 0x63 &#x3D;374144419156711147060143317175368453031918731002211<br>512 bit FNV_prime &#x3D; 2^344 + 2^8 + 0x57 &#x3D; 35835915874844867368919076489095108449946327955754392558399825615420669938882575<br>126094039892345713852759<br>1024 bit FNV_prime &#x3D; 2^680 + 2^8 + 0x8d &#x3D;<br>50164565101131186554345988110352789550307653454047907443030175238311120551081474<br>51509157692220295382716162651878526895249385292291816524375083746691371804094271<br>873160484737966720260389217684476157468082573</p><p>offset_basis的取值:<br>32 bit offset_basis &#x3D; 2166136261<br>64 bit offset_basis &#x3D; 14695981039346656037<br>128 bit offset_basis &#x3D; 144066263297769815596495629667062367629<br>256 bit offset_basis &#x3D; 100029257958052580907070968620625704837092796014241193945225284501741471925557<br>512 bit offset_basis &#x3D; 96593031294966694980094354007163104660904187456726378961083743294344626579945829<br>32197716438449813051892206539805784495328239340083876191928701583869517785<br>1024 bit offset_basis &#x3D; 14197795064947621068722070641403218320880622795441933960878474914617582723252296<br>73230371772215086409652120235554936562817466910857181476047101507614802975596980<br>40773201576924585630032153049571501574036444603635505054127112859663616102678680<br>82893823963790439336411086884584107735010676915</p><h3 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FNV1_32_INIT ((uint64_t) 0x811C9DC5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FNV1_64_INIT ((uint64_t) 0xCBF29CE484222325)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">fnv1A_32</span><span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *bp = (<span class="type">unsigned</span> <span class="type">char</span> *) buf;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *be = bp + len;</span><br><span class="line">    <span class="type">uint64_t</span> hval = FNV1_32_INIT;</span><br><span class="line">    <span class="keyword">while</span> (bp &lt; be) &#123;</span><br><span class="line">        hval ^= (<span class="type">uint64_t</span>) *bp++;</span><br><span class="line">        <span class="comment">// hval *= 16777619</span></span><br><span class="line">        hval += (hval &lt;&lt; <span class="number">1</span>) + (hval &lt;&lt; <span class="number">4</span>) + (hval &lt;&lt; <span class="number">7</span>) + (hval &lt;&lt; <span class="number">8</span>) + (hval &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint64_t</span> <span class="title function_">fnv1A_64</span><span class="params">(<span class="type">void</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *bp = (<span class="type">unsigned</span> <span class="type">char</span> *) buf;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *be = bp + len;</span><br><span class="line">    <span class="type">uint64_t</span> hval = FNV1_64_INIT;</span><br><span class="line">    <span class="keyword">while</span> (bp &lt; be) &#123;</span><br><span class="line">        hval ^= (<span class="type">uint64_t</span>) *bp++;</span><br><span class="line">        <span class="comment">// hval *= 1099511628211</span></span><br><span class="line">        hval += (hval &lt;&lt; <span class="number">1</span>) + (hval &lt;&lt; <span class="number">4</span>) + (hval &lt;&lt; <span class="number">5</span>) + (hval &lt;&lt; <span class="number">7</span>) + (hval &lt;&lt; <span class="number">8</span>) + (hval &lt;&lt; <span class="number">40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h1><h2 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此程序用于演示共享内存的基本用法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid;  <span class="comment">// 共享内存标识符</span></span><br><span class="line">    <span class="comment">// 创建共享内存，键值 0x5005，1024 字节，用 ipcs -m 命令可查看</span></span><br><span class="line">    <span class="keyword">if</span> ((shmid = <span class="built_in">shmget</span>((<span class="type">key_t</span>)<span class="number">0x5005</span>, <span class="number">1024</span>, <span class="number">0640</span>|IPC_CREAT)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;shmat(0x5005) failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> *ptext = <span class="number">0</span>;    <span class="comment">// 用于指向共享内存的指针</span></span><br><span class="line">    <span class="comment">// 将共享内存连接到当前进程的地址空间，由 ptext 指针指向它</span></span><br><span class="line">    ptext = (<span class="type">char</span> *)<span class="built_in">shmat</span>(shmid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 操作本程序的 ptext 指针，就是操作共享内存</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入前：%s\n&quot;</span>, ptext);</span><br><span class="line">    <span class="built_in">sprintf</span>(ptext, <span class="string">&quot;本程序的进程号是：%d&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;写入后：%s\n&quot;</span>, ptext);</span><br><span class="line">    <span class="comment">// 把共享内存从当前进程中分离</span></span><br><span class="line">    <span class="built_in">shmdt</span>(ptext);</span><br><span class="line">    <span class="comment">// 删除共享内存</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    if (shmctl(shmid, IPC_RMID, 0) == -1) &#123;</span></span><br><span class="line"><span class="comment">        printf(&quot;shmctl(0x5005) failed\n&quot;);</span></span><br><span class="line"><span class="comment">        return -1;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此程序用于演示信号量的使用方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CSEM</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 用于信号灯操作的共同体</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">semun</span>&#123;</span><br><span class="line">        <span class="type">int</span> val;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">semid_ds</span> *buf;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span> *arry;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> sem_id;     <span class="comment">// 信号灯描述符</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">init</span><span class="params">(<span class="type">key_t</span> key)</span></span>;   <span class="comment">// 如果信号灯已存在，获取信号灯，如果不存在，则创建信号灯</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">wait</span><span class="params">()</span></span>;            <span class="comment">// 等待信号灯挂出</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">post</span><span class="params">()</span></span>;            <span class="comment">// 挂出信号灯</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">destroy</span><span class="params">()</span></span>;         <span class="comment">// 销毁信号灯</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    CSEM sem;</span><br><span class="line">    <span class="comment">// 初始化信号灯</span></span><br><span class="line">    <span class="keyword">if</span> (sem.<span class="built_in">init</span>(<span class="number">0x5000</span>) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sem.init failed \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sem.init ok\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 等待信号灯挂出，等待成功后，将持有锁</span></span><br><span class="line">    <span class="keyword">if</span> (sem.<span class="built_in">wait</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;sem.wait failed. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sem.wait ok\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sleep 10s...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">10</span>);      <span class="comment">// 在sleep的过程中，运行其他的程序将等待锁</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂出信号灯，释放锁。</span></span><br><span class="line">    <span class="keyword">if</span> (sem.<span class="built_in">post</span>() == <span class="literal">false</span>)  &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;post failed \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;post ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 销毁信号灯</span></span><br><span class="line">    <span class="comment">//if (sem.destroy() == false) &#123;</span></span><br><span class="line">    <span class="comment">//    printf(&quot;destroy failed\n&quot;);</span></span><br><span class="line">    <span class="comment">//    return -1;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//printf(&quot;destroy ok\n&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CSEM::init</span><span class="params">(<span class="type">key_t</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取信号灯</span></span><br><span class="line">    <span class="keyword">if</span> ((sem_id=<span class="built_in">semget</span>(key, <span class="number">1</span>, <span class="number">0640</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果信号灯不存在，则创建</span></span><br><span class="line">        <span class="keyword">if</span> (errno == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sem_id=<span class="built_in">semget</span>(key, <span class="number">1</span>, <span class="number">0640</span>|IPC_CREAT)) == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">perror</span>(<span class="string">&quot;init 1 semget&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 信号灯创建成功后，还需要把它初始化成可用的状态</span></span><br><span class="line">            <span class="keyword">union</span> <span class="title class_">semun</span> sem_union;</span><br><span class="line">            sem_union.val = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">semctl</span>(sem_id, <span class="number">0</span>, SETVAL, sem_union) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">perror</span>(<span class="string">&quot;init semctl()&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;init 2 semget()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CSEM::destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">semctl</span>(sem_id, <span class="number">0</span>, IPC_RMID) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;destory semctl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CSEM::wait</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sembuf</span> sem_b;</span><br><span class="line">    sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">    sem_b.sem_op = <span class="number">-1</span>;</span><br><span class="line">    sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">semop</span>(sem_id, &amp;sem_b, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;wait semop()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CSEM::post</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sembuf</span> sem_b;</span><br><span class="line">    sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">    sem_b.sem_op = <span class="number">1</span>;</span><br><span class="line">    sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">semop</span>(sem_id, &amp;sem_b, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;post semop()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/junxuezheng/category_12080074.html">https://blog.csdn.net/junxuezheng/category_12080074.html</a></p><br><h1 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h1><h2 id="Spring-security-密码加密"><a href="#Spring-security-密码加密" class="headerlink" title="Spring security 密码加密"></a>Spring security 密码加密</h2><p>推荐使用 BCryptPasswordEncoder：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-crypto<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Mybatis-Plus"><a href="#Mybatis-Plus" class="headerlink" title="Mybatis-Plus"></a>Mybatis-Plus</h2><h3 id="执行DDL"><a href="#执行DDL" class="headerlink" title="执行DDL"></a>执行DDL</h3><p>1、mapper接口文件内容如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行备份数据库相关表的Mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BackupDataMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改数据库的表名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originalTableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newTableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">alterTableName</span><span class="params">(<span class="meta">@Param(&quot;originalTableName&quot;)</span> String originalTableName,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;newTableName&quot;)</span> String newTableName)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * truncate指定数据库表的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">truncateTable</span><span class="params">(<span class="meta">@Param(&quot;tableName&quot;)</span> String tableName)</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据传入的表明，创建新的表并且将原表的数据插入到新的Occur表中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newTableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originalTableName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createNewTableAndInsertData</span><span class="params">(<span class="meta">@Param(&quot;newTableName&quot;)</span> String newTableName,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;originalTableName&quot;)</span> String originalTableName)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计某张表中的总数据条数。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 指定表中的总记录条数。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getRecordCount</span><span class="params">(<span class="meta">@Param(&quot;tableName&quot;)</span> String tableName)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得当前数据库的名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getCurDataBaseName</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从指定数据库中，查询是否存在某张表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataBaseName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">isTargetTableExistInDB</span><span class="params">(<span class="meta">@Param(&quot;dataBaseName&quot;)</span> String dataBaseName, </span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;tableName&quot;)</span> String tableName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、mapper.xml文件内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.zjrodger.dao.iface.BackupDataMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;alterTableName&quot;</span>&gt;</span></span><br><span class="line">        alter table $&#123;originalTableName&#125; rename $&#123;newTableName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;truncateTable&quot;</span>&gt;</span></span><br><span class="line">        truncate table $&#123;tableName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;createNewTableAndInsertData&quot;</span>&gt;</span></span><br><span class="line">        create table $&#123;newTableName&#125; as select * from $&#123;originalTableName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRecordCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        select count(1) from $&#123;tableName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getCurDataBaseName&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;string&quot;</span>&gt;</span></span><br><span class="line">        select database();</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;isTargetTableExistInDB&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;string&quot;</span>&gt;</span></span><br><span class="line">        SELECT table_name FROM information_schema.tables WHERE table_schema = #&#123;dataBaseName&#125; and TABLE_NAME = #&#123;tableName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>注意点</strong>：在传入“表名”作为参数时，一定要使用 <code>$&#123;tableName&#125;</code> 的格式，而不能使用 <code>#&#123;tableName&#125;</code> 的格式。</p><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- SpringBoot集成mybatis框架 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>MyBatis 配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">    <span class="comment"># 搜索指定包别名</span></span><br><span class="line">    <span class="attr">typeAliasesPackage:</span> <span class="string">com.**.**.domain</span></span><br><span class="line">    <span class="comment"># 配置mapper的扫描，找到所有的mapper.xml映射文件</span></span><br><span class="line">    <span class="attr">mapperLocations:</span> <span class="string">classpath*:mapper/**/*Mapper.xml</span></span><br><span class="line">    <span class="comment"># 加载全局的配置文件</span></span><br><span class="line">    <span class="attr">configLocation:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br></pre></td></tr></table></figure><h3 id="id生成"><a href="#id生成" class="headerlink" title="id生成"></a>id生成</h3><p>使用 MybatisPlus 的 id 生成策略产生的 id 数太大，超过了JavaScript能够解析的最大范围，这样会导致精度丢失，前台获取到的id和后台数据库中不一致，从而导致无法进行增删改操作。当id定义为Long类型后，生成的id是一个19位数，而 js 能够支持解析的范围是在-9007199254740992到+9007199254740992之间，最大值才16位数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br><span class="line"><span class="keyword">private</span> Long id;</span><br></pre></td></tr></table></figure><p>其中的 IdType 是一个枚举类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">IdType</span> &#123;</span><br><span class="line">    AUTO(<span class="number">0</span>),        <span class="comment">// 默认为 AUTO，使用数据库设置的自增策略</span></span><br><span class="line">    NONE(<span class="number">1</span>),        <span class="comment">// 不设置生成策略</span></span><br><span class="line">    INPUT(<span class="number">2</span>),       <span class="comment">// 用户手动输入 id</span></span><br><span class="line">    ASSIGN_ID(<span class="number">3</span>),   <span class="comment">// 使用雪花算法生成 id</span></span><br><span class="line">    ASSIGN_UUID(<span class="number">4</span>), <span class="comment">// 使用 UUID 算法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解决方法：在 id 上边加这个注解 <code>@JsonSerialize(using = ToStringSerializer.class)</code></p><p>此时将对象转成 Json 对象时，id 会被转换成字符串，前端接收的 id 也是字符串，就可正常解析了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br><span class="line"><span class="meta">@JsonSerialize(using = ToStringSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> Long id;</span><br></pre></td></tr></table></figure><h3 id="分页插件"><a href="#分页插件" class="headerlink" title="分页插件"></a>分页插件</h3><p>在官网里对分页插件的讲解最重要的就是PaginationInnerInterceptor这个分页拦截器，玩过PageHelper的朋友都知道，分页它的本质就是内部封装了一个拦截器，对于满足满足条件的数据，起到一个过滤的作用🙋‍♀️这会和我们后续的自定义条件有关，毕竟也是同样的道理，你自定义一个条件来“筛选数据”，只展示满足条件的数据</p><p>创建分页配置类 MybatisPlusConfig，既然是配置类，别忘了加 @Configuration 注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>(); <span class="comment">//配置插件类</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL)); <span class="comment">//具体到配置哪一个插件</span></span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.方法剖析+测试分页[重]<br>其实如果你使用了 mybatis-plus，那么在 mapper 提供的 API 当中就有可以进行分页的方法 selectPage，这个方法需要两个参数，一个为 Page 对象，另一个为 wrapper对 象[也就是前面说到的将符合条件的数据查询出来,为null值则表示查询全部数据]，我们直接调用即可🙋‍♀️，在下一章节会使用到wrapper来自定义分页查询</p><p>示例代码[后]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: RuoYi-Vue-master</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: mybatisPlus分页插件测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xmonster_大魔王</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2022-07-28 11:48</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPageTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> ProductMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        Page&lt;Product&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        mapper.selectPage(page,<span class="literal">null</span>);</span><br><span class="line">        System.out.println(page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>自定义分页查询<br>这种场景非常常见，就是当前的查询语句是我们自定义的，想要在自己写的 sql 语句中通过分页插件来实现分页功能</li></ol><p>玩自定义分页必须掌握的神器就是：条件构造器wrapper、Lambda条件构造器如果还没有学会的朋友可以去官网先学习一波<br>前面说到，分页它的本质就是内部封装了一个拦截器，对于满足满足条件的数据，起到一个过滤的作用🙋‍♀️这会和我们后续的自定义条件有关，毕竟也是同样的道理，你自定义一个条件来“筛选数据”，只展示满足条件的数据</p><p>上一篇博文我们在mapper的selectPage函数当中将wrapper设为null，则是查询全部数据。</p><p>自定义分页的核心就是：参照selectPage函数</p><p>自定义分页的重点就是：自定义函数的返回值必须为Page对象，你所定义的函数的第一个参数类型必须为Page</p><p>例如：想要查询出价格大于某个值的产品并进行分页（这里为了测试sql定义了该值为1400）</p><p>自定义分页函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;SELECT * FROM `t_product` where price&gt;#&#123;price&#125;&quot;)</span></span><br><span class="line">Page&lt;Product&gt; <span class="title function_">selectPageByMyself</span><span class="params">(<span class="meta">@Param(&quot;page&quot;)</span> Page&lt;Product&gt; page, <span class="meta">@Param(&quot;price&quot;)</span> Integer price)</span>;</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPageTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> ProductMapper mapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        Page&lt;Product&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">10</span>);</span><br><span class="line">        mapper.selectPageByMyself(page,<span class="number">1400</span>);</span><br><span class="line">        System.out.println(page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自定义wrapper分页</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select(&quot;SELECT * FROM `t_product` $&#123;ew.customSqlSegment&#125;&quot;)</span></span><br><span class="line">Page&lt;Product&gt; <span class="title function_">selectPageByMyself2</span><span class="params">(<span class="meta">@Param(&quot;page&quot;)</span> Page&lt;Product&gt; page,<span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;Product&gt; wrapper)</span>;</span><br></pre></td></tr></table></figure><p>这里主要看 selectPageByMyself2方法啦，直接传wrapper即可，这里的sql语句当中使用了 ${ew.customSqlSegment}，那么它具体的用法是什么呢？<br><code>$&#123;ew.customSqlSegment&#125;</code> 拼接where后的语句（包括where，需注意在动态SQL中不处于标签内）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">    <span class="type">ProductParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductParam</span>().builder().name(<span class="string">&quot;x&quot;</span>).price(<span class="number">8000</span>).ishot(<span class="literal">true</span>).build();</span><br><span class="line">    Page&lt;Product&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">10</span>);</span><br><span class="line">    LambdaQueryWrapper&lt;Product&gt; wrapper = Wrappers.lambdaQuery(Product.class)</span><br><span class="line">            .like(Product::getName, param.getName())</span><br><span class="line">            .lt(Product::getPrice, param.getPrice())</span><br><span class="line">            .eq(Product::getIshot, param.getIshot());</span><br><span class="line">    mapper.selectPageByMyself2(page,wrapper);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;productList&quot;</span>,page.getRecords());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>四、自定义sql分页查询<br>有时候查询的数据难免会出现多表连接查询，或者是一些复杂的sql语句，但是这些语句也是需要支持分页查询的，</p><p>先定义查询接口，第一个参数要是分页的参数，小编这里演示就写简单的sql。</p><p>步骤一：在 mapper 文件中，编写对应的分页查询接口。</p><p>步骤二：在 xml 中编写对应的sql语句，小编这里演示的 “${ew.customSqlSegment}”，这个是如果你想自定义的sql语句，也想使用wrapper查询条件构造器，则需要在mapper接口中添加参数，以及xml中也要有固定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 自定义sql分页</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> queryWrapper 看这里看这里，如果自定义的方法中需要用到wrapper查询条件，需要这样写</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">IPage&lt;User&gt; <span class="title function_">selectMyPage</span><span class="params">(IPage&lt;User&gt; page, <span class="meta">@Param(Constants.WRAPPER)</span> Wrapper&lt;User&gt; queryWrapper)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.example.demo.mapper.UserMapper&quot;</span>&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;select id=<span class="string">&quot;selectMyPage&quot;</span> resultType=<span class="string">&quot;com.example.demo.model.User&quot;</span>&gt;</span><br><span class="line">        SELECT * FROM user $&#123;ew.customSqlSegment&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义sql分页查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectByMyPage</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>();</span><br><span class="line">    wrapper.like(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;雨&quot;</span>).lt(<span class="string">&quot;age&quot;</span>, <span class="number">40</span>);</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    IPage&lt;User&gt; mapIPage = userMapper.selectMyPage(page, wrapper);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;总页数&quot;</span>+mapIPage.getPages());</span><br><span class="line">    System.out.println(<span class="string">&quot;总记录数&quot;</span>+mapIPage.getTotal());</span><br><span class="line">    List&lt;User&gt; records = mapIPage.getRecords();</span><br><span class="line">    records.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>五、多表sql分页查询<br>多表连接查询怎么分页，其实道理都是一样的。</p><p>以简单的为主，sql如下： his_ipd_encounter、his_user 两张表</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.demo.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByHisName&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">        select u.realname from his_ipd_encounter e, his_user u where e.his_uid = u.his_uid</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>mapepr如下：需要传入分页的参数，返回的类型也需要是分页对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 用户 Mapper 接口</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> IT贱男</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-06-14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">MyMapper</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多表查询分页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    IPage&lt;String&gt; <span class="title function_">selectByHisName</span><span class="params">(IPage&lt;User&gt; page)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试如下：通过查看日志，执行的 sql 加了分页条件的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建分页参数</span></span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    IPage&lt;String&gt; result = userMapper.selectByHisName(page);</span><br><span class="line">    <span class="comment">// 获取数据</span></span><br><span class="line">    List&lt;String&gt; records = result.getRecords();</span><br><span class="line">    records.forEach(System.out::println);</span><br><span class="line">    System.out.println(<span class="string">&quot;总页数 = &quot;</span>+ result.getPages());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ARNWarn: Could not find @TableId in Class: com.example.demo.model.HisUser.</span><br><span class="line">INFOStarted UserMapperTest in 2.428 seconds (JVM running for 2.959)</span><br><span class="line">select u.realname from his_ipd_encounter e, his_user u where e.his_uid = u.his_uid</span><br><span class="line">DEBUG==&gt;  Preparing: SELECT COUNT(1) FROM his_ipd_encounter e, his_user u WHERE e.his_uid = u.his_uid </span><br><span class="line">DEBUG==&gt; Parameters: </span><br><span class="line">TRACE&lt;==    Columns: COUNT(1)</span><br><span class="line">TRACE&lt;==        Row: 117</span><br><span class="line">DEBUG==&gt;  Preparing: select u.realname from his_ipd_encounter e, his_user u where e.his_uid = u.his_uid LIMIT ?,? </span><br><span class="line">DEBUG==&gt; Parameters: 0(Long), 2(Long)</span><br><span class="line">TRACE&lt;==    Columns: realname</span><br><span class="line">TRACE&lt;==        Row: 胡伯云</span><br><span class="line">TRACE&lt;==        Row: 安元慧</span><br><span class="line">DEBUG&lt;==      Total: 2</span><br><span class="line"> Time：20 ms - ID：com.example.demo.mapper.UserMapper.selectByHisName</span><br><span class="line">Execute SQL：</span><br><span class="line">    com.p6spy.engine.wrapper.PreparedStatementWrapper@61bcbcce</span><br><span class="line"> </span><br><span class="line">胡伯云</span><br><span class="line">安元慧</span><br><span class="line">总页数 = 59</span><br></pre></td></tr></table></figure><h2 id="BeanUtils"><a href="#BeanUtils" class="headerlink" title="BeanUtils"></a>BeanUtils</h2><p>Bean 属性拷贝</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 src 对象中的属性全部拷贝到 t 中</span></span><br><span class="line"><span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> BeanUtils.instantiateClass(t.class);</span><br><span class="line">BeanUtils.copyProperties(src, t);</span><br><span class="line"><span class="keyword">return</span> t;</span><br></pre></td></tr></table></figure><h2 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h2><p>下载：<code>https://archive.apache.org/dist/tomcat/</code></p><p><code>https://mirrors.cnnic.cn/apache/tomcat/</code></p><h1 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h1><p>有一个需求，要将图片存储到阿里云上，实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliyunImageStore</span> &#123;</span><br><span class="line">    <span class="comment">//... 省略属性、构造函数等...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createBucketIfNotExisting</span><span class="params">(String bucketName)</span> &#123;</span><br><span class="line">    <span class="comment">// ... 创建 bucket 代码逻辑...</span></span><br><span class="line">    <span class="comment">// ... 失败会抛出异常..</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateAccessToken</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ... 根据 accesskey/secrectkey 等生成 access token</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadToAliyun</span><span class="params">(Image image, String bucketName, String accessTok</span></span><br><span class="line"><span class="params">    //... 上传图片到阿里云...</span></span><br><span class="line"><span class="params">    //... 返回图片存储在阿里云上的地址 (url）...</span></span><br><span class="line"><span class="params">    &#125;</span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> Image downloadFromAliyun(String url, String accessToken)</span> &#123;</span><br><span class="line">    <span class="comment">//... 从阿里云下载图片...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AliyunImageStore 类的使用举例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageProcessingJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUCKET_NAME</span> <span class="operator">=</span> <span class="string">&quot;ai_images_bucket&quot;</span>;</span><br><span class="line">    <span class="comment">//... 省略其他无关代码...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Image</span> <span class="variable">image</span> <span class="operator">=</span> ...; <span class="comment">// 处理图片，并封装为 Image 对象</span></span><br><span class="line">        <span class="type">AliyunImageStore</span> <span class="variable">imageStore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AliyunImageStore</span>(<span class="comment">/* 省略参数 */</span>);</span><br><span class="line">        imageStore.createBucketIfNotExisting(BUCKET_NAME);</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> imageStore.generateAccessToken();</span><br><span class="line">        imagestore.uploadToAliyun(image, BUCKET_NAME, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过了一段时间后，我们自建了私有云，不再将图片存储到阿里云了，而是将图片存储到自建私有云上。此时需要修改代码，为考虑后续私有云的变化，应该将代码抽象成接口，而可以确定的<strong>不变的功能</strong>就是<strong>上传和下载</strong>，因此可以将将两个功能抽象成接口，重构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImageStore</span> &#123;</span><br><span class="line">    String <span class="title function_">upload</span><span class="params">(Image image, String bucketName)</span>;</span><br><span class="line">    Image <span class="title function_">download</span><span class="params">(String url)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliyunImageStore</span> <span class="keyword">implements</span> <span class="title class_">ImageStore</span> &#123;</span><br><span class="line">    <span class="comment">//... 省略属性、构造函数等...</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(Image image, String bucketName)</span> &#123;</span><br><span class="line">        createBucketIfNotExisting(bucketName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> generateAccessToken();</span><br><span class="line">        <span class="comment">//... 上传图片到阿里云...</span></span><br><span class="line">        <span class="comment">//... 返回图片在阿里云上的地址 (url)...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Image <span class="title function_">download</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> generateAccessToken();</span><br><span class="line">        <span class="comment">//... 从阿里云下载图片...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createBucketIfNotExisting</span><span class="params">(String bucketName)</span> &#123;</span><br><span class="line">        <span class="comment">// ... 创建 bucket...</span></span><br><span class="line">        <span class="comment">// ... 失败会抛出异常..</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateAccessToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ... 根据 accesskey/secrectkey 等生成 access token</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 上传下载流程改变：私有云不需要支持 access token</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivateImageStore</span> <span class="keyword">implements</span> <span class="title class_">ImageStore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(Image image, String bucketName)</span> &#123;</span><br><span class="line">    createBucketIfNotExisting(bucketName);</span><br><span class="line">        <span class="comment">//... 上传图片到私有云...</span></span><br><span class="line">        <span class="comment">//... 返回图片的 url...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Image <span class="title function_">download</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="comment">//... 从私有云下载图片...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createBucketIfNotExisting</span><span class="params">(String bucketName)</span> &#123;</span><br><span class="line">        <span class="comment">// ... 创建 bucket...</span></span><br><span class="line">        <span class="comment">// ... 失败会抛出异常..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ImageStore 的使用举例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageProcessingJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUCKET_NAME</span> <span class="operator">=</span> <span class="string">&quot;ai_images_bucket&quot;</span>;</span><br><span class="line">    <span class="comment">//... 省略其他无关代码...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Image</span> <span class="variable">image</span> <span class="operator">=</span> ...;<span class="comment">// 处理图片，并封装为 Image 对象</span></span><br><span class="line">        <span class="type">ImageStore</span> <span class="variable">imageStore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrivateImageStore</span>(...);</span><br><span class="line">        imagestore.upload(image, BUCKET_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过此次抽象，可以很方便地将 ImageStore 换成其他的实现，但是代码里的实现类使用设计的还是不够完美，可以使用 <strong>配置文件+反射+工厂模式</strong></p><h2 id="组合与委托"><a href="#组合与委托" class="headerlink" title="组合与委托"></a>组合与委托</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Flyable</span> &#123; <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Tweetable</span> &#123; <span class="keyword">void</span> <span class="title function_">tweet</span><span class="params">()</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EggLayable</span> &#123; <span class="keyword">void</span> <span class="title function_">layEgg</span><span class="params">()</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ostrich</span> <span class="keyword">implements</span> <span class="title class_">Tweetable</span>, EggLayable &#123;<span class="comment">// 鸵鸟</span></span><br><span class="line">    <span class="comment">//... 省略其他属性和方法...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tweet</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">layEgg</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sparrow</span> impelents Flayable, Tweetable, EggLayable &#123;<span class="comment">// 麻雀</span></span><br><span class="line"><span class="comment">//... 省略其他属性和方法...</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tweet</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">layEgg</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过，接口只声明方法，不定义实现。也就是说，每个会下蛋的鸟都要实现一遍 layEgg() 方法，并且实现逻辑是一样的，这就会导致代码重复的问题。</p><p>我们可以针对三个接口再定义三个实现类，它们分别是：实现了 fly() 方法的 FlyAbility<br>类、实现了 tweet() 方法的 TweetAbility 类、实现了 layEgg() 方法的 EggLayAbility 类。<br>然后，通过组合和委托技术来消除代码重复。具体的代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Flyable</span> &#123; <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span>； &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlyAbility</span> <span class="keyword">implements</span> <span class="title class_">Flyable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fly</span><span class="params">()</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 省略 Tweetable/TweetAbility/EggLayable/EggLayAbility</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ostrich</span> <span class="keyword">implements</span> <span class="title class_">Tweetable</span>, EggLayable &#123;<span class="comment">// 鸵鸟</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TweetAbility</span> <span class="variable">tweetAbility</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TweetAbility</span>(); <span class="comment">// 组合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">EggLayAbility</span> <span class="variable">eggLayAbility</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EggLayAbility</span>(); <span class="comment">// 组合</span></span><br><span class="line">    <span class="comment">//... 省略其他属性和方法 ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tweet</span><span class="params">()</span> &#123;</span><br><span class="line">        tweetAbility.tweet(); <span class="comment">// 委托</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">layEgg</span><span class="params">()</span> &#123;</span><br><span class="line">        eggLayAbility.layEgg(); <span class="comment">// 委托</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们知道继承主要有三个作用：表示 is-a 关系，支持多态特性，代码复用。而这三个作用都可以通过其他技术手段来达成。比如 is-a 关系，我们可以通过组合和接口的 has-a 关系来替代；多态特性我们可以利用接口来实现；代码复用我们可以通过组合和委托来实现。所以，从理论上讲，通过组合、接口、委托三个技术手段，我们完全可以替换掉继承，在项目中不用或者少用继承关系，特别是一些复杂的继承关系。</p><h2 id="贫血模型与充血模型"><a href="#贫血模型与充血模型" class="headerlink" title="贫血模型与充血模型"></a>贫血模型与充血模型</h2><p>我们平时开发 Web 后端项目的时候，基本上都是这么组织代码的。其中，UserEntity 和 UserRepository 组成了数据访问层，UserBo 和 UserService 组成了业务逻辑层，UserVo 和 UserController 在这里属于接口层。</p><p>从代码中，我们可以发现，UserBo 是一个纯粹的数据结构，只包含数据，不包含任何业务逻辑。业务逻辑集中在 UserService 中。我们通过 UserService 来操作 UserBo。换句话说，Service 层的数据和业务逻辑，被分割为 BO 和 Service 两个类中。像 UserBo 这样， 只包含数据，不包含业务逻辑的类，就叫作贫血模型（Anemic Domain Model）。同理，UserEntity、UserVo 都是基于贫血模型设计的。这种贫血模型将数据与操作分离，破坏了面向对象的封装特性，是一种典型的面向过程的编程风格。</p><p>刚刚我们讲了基于贫血模型的传统的开发模式。现在我们再讲一下，另外一种最近更加被推崇的开发模式：基于充血模型的 DDD 开发模式。</p><p>在贫血模型中，数据和业务逻辑被分割到不同的类中。充血模型（Rich Domain Model）正好相反，数据和对应的业务逻辑被封装到同一个类中。因此，这种充血模型满足面向对象的封装特性，是典型的面向对象编程风格。</p><p>领域驱动设计，即 DDD，主要是用来指导如何解耦业务系统，划分业务模块，定义业务领域模型及其交互。领域驱动设计这个概念并不新颖，早在 2004 年就被提出了，到现在已经有十几年的历史了。不过，它被大众熟知，还是基于另一个概念的兴起，那就是微服务。</p><p>我们知道，除了监控、调用链追踪、API 网关等服务治理系统的开发之外，微服务还有另外一个更加重要的工作，那就是针对公司的业务，合理地做微服务拆分。而领域驱动设计恰好就是用来指导划分服务的。所以，微服务加速了领域驱动设计的盛行。</p><p>实际上，基于充血模型的 DDD 开发模式实现的代码，也是按照 MVC 三层架构分层的。Controller 层还是负责暴露接口，Repository 层还是负责数据存取，Service 层负责核心业务逻辑。它跟基于贫血模型的传统开发模式的区别主要在 Service 层。</p><p>在基于贫血模型的传统开发模式中，Service 层包含 Service 类和 BO 类两部分，BO 是贫血模型，只包含数据，不包含具体的业务逻辑。业务逻辑集中在 Service 类中。在基于充血模型的 DDD 开发模式中，Service 层包含 Service 类和 Domain 类两部分。Domain 就相当于贫血模型中的 BO。不过，Domain 与 BO 的区别在于它是基于充血模型开发的，既包含数据，也包含业务逻辑。而 Service 类变得非常单薄。总结一下的话就是，基于贫血模型的传统的开发模式，重 Service 轻 BO；基于充血模型的 DDD 开发模式，轻 Service 重 Domain。</p><h3 id="贫血案例"><a href="#贫血案例" class="headerlink" title="贫血案例"></a>贫血案例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualWalletController</span> &#123;</span><br><span class="line">    <span class="comment">// 通过构造函数或者 IOC 框架注入</span></span><br><span class="line">    <span class="keyword">private</span> VirtualWalletService virtualWalletService;</span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">(Long walletId)</span> &#123; ... &#125; <span class="comment">// 查询余额</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123; ... &#125; <span class="comment">// 出账</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">credit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123; ... &#125; <span class="comment">// 入账</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Long fromWalletId, Long toWalletId, BigDecimal amount)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualWalletBo</span> &#123;<span class="comment">// 省略 getter/setter/constructor 方法</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long createTime;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualWalletService</span> &#123;</span><br><span class="line">    <span class="comment">// 通过构造函数或者 IOC 框架注入</span></span><br><span class="line">    <span class="keyword">private</span> VirtualWalletRepository walletRepo;</span><br><span class="line">    <span class="keyword">private</span> VirtualWalletTransactionRepository transactionRepo;</span><br><span class="line">    <span class="keyword">public</span> VirtualWalletBo <span class="title function_">getVirtualWallet</span><span class="params">(Long walletId)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">VirtualWalletBo</span> <span class="variable">walletBo</span> <span class="operator">=</span> convert(walletEntity);</span><br><span class="line">        <span class="keyword">return</span> walletBo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">(Long walletId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> virtualWalletRepo.getBalance(walletId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">balance</span> <span class="operator">=</span> walletEntity.getBalance();</span><br><span class="line">        <span class="keyword">if</span> (balance.compareTo(amount) &lt; <span class="number">0</span>) </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSufficientBalanceException</span>(...);</span><br><span class="line">        walletRepo.updateBalance(walletId, balance.subtract(amount));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">credit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">balance</span> <span class="operator">=</span> walletEntity.getBalance();</span><br><span class="line">        walletRepo.updateBalance(walletId, balance.add(amount));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Long fromWalletId, Long toWalletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletTransactionEntity</span> <span class="variable">transactionEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VirtualWalletTransac</span></span><br><span class="line">        transactionEntity.setAmount(amount);</span><br><span class="line">        transactionEntity.setCreateTime(System.currentTimeMillis());</span><br><span class="line">        transactionEntity.setFromWalletId(fromWalletId);</span><br><span class="line">        transactionEntity.setToWalletId(toWalletId);</span><br><span class="line">        transactionEntity.setStatus(Status.TO_BE_EXECUTED);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">transactionId</span> <span class="operator">=</span> transactionRepo.saveTransaction(transactionEntity);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            debit(fromWalletId, amount);</span><br><span class="line">            credit(toWalletId, amount);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InsufficientBalanceException e) &#123;</span><br><span class="line">            transactionRepo.updateStatus(transactionId, Status.CLOSED);</span><br><span class="line">            <span class="comment">// ...rethrow exception e...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            transactionRepo.updateStatus(transactionId, Status.FAILED);</span><br><span class="line">            <span class="comment">// ...rethrow exception e...</span></span><br><span class="line">        &#125;</span><br><span class="line">        transactionRepo.updateStatus(transactionId, Status.EXECUTED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service 和 BO 负责核心业务逻辑，Repository 和 Entity 负责数据存取。Repository 这一<br>层的代码实现比较简单，不是我们讲解的重点，所以我也省略掉了。Service 层的代码如下<br>所示。注意，这里我省略了一些不重要的校验代码，比如，对 amount 是否小于 0、钱包<br>是否存在的校验等等。</p><h3 id="充血改造"><a href="#充血改造" class="headerlink" title="充血改造"></a>充血改造</h3><p>基于充血模型的 DDD 开发模式，跟基于贫血模型的传统开发模式的主要区别就在 Service 层，Controller 层和 Repository 层的代码基本上相同。所以，我们重点看一下，Service 层按照基于充血模型的 DDD 开发模式该如何来实现。</p><p>在这种开发模式下，我们把虚拟钱包 VirtualWallet 类设计成一个充血的 Domain 领域模型，并且将原来在 Service 类中的部分业务逻辑移动到 VirtualWallet 类中，让 Service 类的实现依赖 VirtualWallet 类。具体的代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualWallet</span> &#123; <span class="comment">// Domain 领域模型 (充血模型)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">createTime</span> <span class="operator">=</span> System.currentTimeMillis();;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">balance</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VirtualWallet</span><span class="params">(Long preAllocatedId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = preAllocatedId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">balance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.balance.compareTo(amount) &lt; <span class="number">0</span>) </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientBalanceException</span>(...);</span><br><span class="line">        <span class="built_in">this</span>.balance.subtract(amount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">credit</span><span class="params">(BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (amount.compareTo(BigDecimal.ZERO) &lt; <span class="number">0</span>) </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidAmountException</span>(...);</span><br><span class="line">        <span class="built_in">this</span>.balance.add(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualWalletService</span> &#123;</span><br><span class="line">    <span class="comment">// 通过构造函数或者 IOC 框架注入</span></span><br><span class="line">    <span class="keyword">private</span> VirtualWalletRepository walletRepo;</span><br><span class="line">    <span class="keyword">private</span> VirtualWalletTransactionRepository transactionRepo;</span><br><span class="line">    <span class="keyword">public</span> VirtualWallet <span class="title function_">getVirtualWallet</span><span class="params">(Long walletId)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">VirtualWallet</span> <span class="variable">wallet</span> <span class="operator">=</span> convert(walletEntity);</span><br><span class="line">        <span class="keyword">return</span> wallet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getBalance</span><span class="params">(Long walletId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> virtualWalletRepo.getBalance(walletId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">VirtualWallet</span> <span class="variable">wallet</span> <span class="operator">=</span> convert(walletEntity);</span><br><span class="line">        wallet.debit(amount);</span><br><span class="line">        walletRepo.updateBalance(walletId, wallet.balance());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">credit</span><span class="params">(Long walletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="type">VirtualWalletEntity</span> <span class="variable">walletEntity</span> <span class="operator">=</span> walletRepo.getWalletEntity(walletId);</span><br><span class="line">        <span class="type">VirtualWallet</span> <span class="variable">wallet</span> <span class="operator">=</span> convert(walletEntity);</span><br><span class="line">        wallet.credit(amount);</span><br><span class="line">        walletRepo.updateBalance(walletId, wallet.balance());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Long fromWalletId, Long toWalletId, BigDecimal amount)</span> &#123;</span><br><span class="line">        <span class="comment">// 与之前一样</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了上面的代码，你可能会说，领域模型 VirtualWallet 类很单薄，包含的业务逻辑很简单。相对于原来的贫血模型的设计思路，这种充血模型的设计思路，貌似并没有太大优势。你说得没错！这也是大部分业务系统都使用基于贫血模型开发的原因。不过，如果虚拟钱包系统需要支持更复杂的业务逻辑，那充血模型的优势就显现出来了。比如，我们要支持透支一定额度和冻结部分余额的功能。这个时候，我们可以在 VirtualWallet 类中添加更多功能。如果功能继续演进，我们可以增加更加细化的冻结策略、透支策略、支持钱包账号（VirtualWallet id 字段）自动生成的逻辑（不是通过构造函数经外部传入 ID，而是通过分布式 ID 生成算法来自动生成 ID）等等。VirtualWallet 类的业务逻辑会变得越来越复杂，也就很值得设计成充血模型了。</p><p>在基于充血模型的 DDD 开发模式中，将业务逻辑移动到 Domain 中，Service 类变得很薄，但在我们的代码设计与实现中，并没有完全将 Service 类去掉，这是因为：</p><ul><li>Service 类负责与 Repository 交流。在我的设计与代码实现中，VirtualWalletService 类负责与 Repository 层打交道，调用 Respository 类的方法，获取数据库中的数据，转化 成领域模型 VirtualWallet，然后由领域模型 VirtualWallet 来完成业务逻辑，最后调用 Repository 类的方法，将数据存回数据库。(这里我再稍微解释一下，之所以让 VirtualWalletService 类与 Repository 打交道，而不是让领域模型 VirtualWallet 与 Repository 打交道，那是因为我们想保持领域模型的独立性，不与任何其他层的代码（Repository 层的代码）或开发框架（比如 Spring、 MyBatis）耦合在一起，将流程性的代码逻辑（比如从 DB 中取数据、映射数据）与领域模型的业务逻辑解耦，让领域模型更加可复用。)</li><li>Service 类负责跨领域模型的业务聚合功能。VirtualWalletService 类中的 transfer() 转账函数会涉及两个钱包的操作，因此这部分业务逻辑无法放到 VirtualWallet 类中，所以，我们暂且把转账业务放到 VirtualWalletService 类中了。当然，虽然功能演进，使得转账业务变得复杂起来之后，我们也可以将转账业务抽取出来，设计成一个独立的领域模型。</li><li>Service 类负责一些非功能性及与三方系统交互的工作。比如幂等、事务、发邮件、发消息、记录日志、调用其他系统的 RPC 接口等，都可以放到 Service 类中。</li></ul><p>在基于充血模型的 DDD 开发模式中，尽管 Service 层被改造成了充血模型，但是 Controller 层和 Repository 层还是贫血模型，是否有必要也进行充血领域建模呢？</p><blockquote><p>答案是没有必要。Controller 层主要负责接口的暴露，Repository 层主要负责与数据库打交道，这两层包含的业务逻辑并不多，前面我们也提到了，如果业务逻辑比较简单，就没必要做充血建模，即便设计成充血模型，类也非常单薄，看起来也很奇怪。<br>就拿 Repository 的 Entity 来说，即便它被设计成贫血模型，违反面相对象编程的封装特性，有被任意代码修改数据的风险，但 Entity 的生命周期是有限的。一般来讲，我们把它传递到 Service 层之后，就会转化成 BO 或者 Domain 来继续后面的业务逻辑。Entity 的生命周期到此就结束了，所以也并不会被到处任意修改。 我们再来说说 Controller 层的 VO。实际上 VO 是一种 DTO（Data Transfer Object，数据传输对象）。它主要是作为接口的数据传输承载体，将数据发送给其他系统。从功能上来讲，它理应不包含业务逻辑、只包含数据。所以，我们将它设计成贫血模型也是比较合理的。</p></blockquote><h2 id="避免重构出错"><a href="#避免重构出错" class="headerlink" title="避免重构出错"></a>避免重构出错</h2><p>那如何保证重构不出错呢？你需要熟练掌握各种设计原则、思想、模式，还需要对所重构的业务和代码有足够的了解。除了这些个人能力因素之外，最可落地执行、最有效的保证重构不出错的手段应该就是<strong>单元测试</strong>(Unit Testing)了。当重构完成之后，如果新的代码仍然能通过单元测试，那就说明代码原有逻辑的正确性未被破坏，原有的外部可见行为未变，也就是说，此次重构是成功的。</p><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>单元测试由研发工程师自己来编写，用来测试自己写的代码的正确性。我们常常将它跟集成测试放到一块来对比。单元测试相对于集成测试（Integration Testing）来说，测试的粒度更小一些。集成测试的测试对象是整个系统或者某个功能模块，比如测试用户注册、登录功能是否正常，是一种端到端（end to end）的测试。而单元测试的测试对象是类或者函数，用来测试一个类和函数是否都按照预期的逻辑执行。这是代码层级的测试。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Text</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Text</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 将字符串转化成数字，忽略字符串中的首尾空格；</span></span><br><span class="line"><span class="comment">    * 如果字符串中包含除首尾空格之外的非数字字符，则返回 null。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">toNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (content == <span class="literal">null</span> || content.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//... 省略代码实现...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们要测试 Text 类中的 toNumber() 函数的正确性，应该如何编写单元测试呢？</p><p>实际上，写单元测试本身不需要什么高深技术。它更多的是考验程序员思维的缜密程度，看能否设计出覆盖各种正常及异常情况的测试用例，来保证代码在任何预期或非预期的情况下都能正确运行。</p><p>为了保证测试的全面性，针对 toNumber() 函数，我们需要设计下面这样几个测试用例：</p><ul><li>如果字符串只包含数字：“123”，toNumber() 函数输出对应的整数：123。</li><li>如果字符串是空或者 null，toNumber() 函数返回：null。</li><li>如果字符串包含首尾空格：“ 123”，“123 ”，“ 123 ”，toNumber() 返回对应的整数：123。</li><li>如果字符串包含多个首尾空格：“ 123 ”，toNumber() 返回对应的整数：123；</li><li>如果字符串包含非数字字符：“123a4”，“123 4”，toNumber() 返回 null；</li></ul><p>当我们设计好测试用例之后，剩下的就是将其翻译成代码了，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Assert</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">assertEquals</span><span class="params">(Integer expectedValue, Integer actualValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (actualValue != expectedValue) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> String.format(<span class="string">&quot;Test failed, expected: %d, actual: %d.&quot;</span>, expectedValue, expectedValue);</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Test succeeded.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">assertNull</span><span class="params">(Integer actualValue)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isNull</span> <span class="operator">=</span> actualValue == <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isNull) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Test succeeded.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Test failed, the value is not null:&quot;</span> + actualValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isNull;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCaseRunner</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Run testToNumber()&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextTest</span>().testToNumber();</span><br><span class="line">        System.out.println(<span class="string">&quot;Run testToNumber_nullorEmpty()&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextTest</span>().testToNumber_nullorEmpty();</span><br><span class="line">        System.out.println(<span class="string">&quot;Run testToNumber_containsLeadingAndTrailingSpaces()&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextTest</span>().testToNumber_containsLeadingAndTrailingSpaces();</span><br><span class="line">        System.out.println(<span class="string">&quot;Run testToNumber_containsMultiLeadingAndTrailingSpaces()&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextTest</span>().testToNumber_containsMultiLeadingAndTrailingSpaces();</span><br><span class="line">        System.out.println(<span class="string">&quot;Run testToNumber_containsInvalidCharaters()&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TextTest</span>().testToNumber_containsInvalidCharaters();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text.toNumber());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNumber_nullorEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="literal">null</span>);</span><br><span class="line">        Assert.assertNull(text1.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        Assert.assertNull(text2.toNumber());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNumber_containsLeadingAndTrailingSpaces</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot; 123&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text1.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;123 &quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text2.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot; 123 &quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text3.toNumber());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNumber_containsMultiLeadingAndTrailingSpaces</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot; 123&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text1.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;123 &quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text2.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot; 123 &quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">123</span>, text3.toNumber());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testToNumber_containsInvalidCharaters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;123a4&quot;</span>);</span><br><span class="line">        Assert.assertNull(text1.toNumber());</span><br><span class="line">        <span class="type">Text</span> <span class="variable">text2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(<span class="string">&quot;123 4&quot;</span>);</span><br><span class="line">        Assert.assertNull(text2.toNumber());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码的可测试性是评判代码质量的一个重要标准。对于一段代码，如果很难为其编写单元测试，或者单元测试写起来很吃力，需要依靠单元测试框架里很高级的特性才能完成，那往往就意味着代码设计得不够合理，比如，没有使用依赖注入、大量使用静态函数、全局变量、代码高度耦合等。</p><p>而代码的可测试性，主要包括这样几个问题：</p><ul><li>什么是代码的可测试性？</li><li>如何写出可测试的代码？</li><li>有哪些常见的不好测试的代码？</li></ul><p>例如，具体的被测试代码如下所示。其中，Transaction 是经过我抽象简化之后的一个电商系统的交易类，用来记录每笔订单交易的情况。Transaction 类中的 execute() 函数负责执行转账操作，将钱从买家的钱包转到卖家的钱包中。真正的转账操作是通过调用 WalletRpcService RPC 服务来完成的。除此之外，代码中还涉及一个分布式锁 DistributedLock 单例类，用来避免 Transaction 并发执行，导致用户的钱被重复转出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> Long buyerId;</span><br><span class="line">    <span class="keyword">private</span> Long sellerId;</span><br><span class="line">    <span class="keyword">private</span> Long productId;</span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="keyword">private</span> Long createTimestamp;</span><br><span class="line">    <span class="keyword">private</span> Double amount;</span><br><span class="line">    <span class="keyword">private</span> STATUS status;</span><br><span class="line">    <span class="keyword">private</span> String walletTransactionId;</span><br><span class="line">    <span class="comment">// ...get() methods...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Transaction</span><span class="params">(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (preAssignedId != <span class="literal">null</span> &amp;&amp; !preAssignedId.isEmpty()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = preAssignedId;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = IdGenerator.generateTransactionId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.id.startWith(<span class="string">&quot;t_&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = <span class="string">&quot;t_&quot;</span> + preAssignedId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.buyerId = buyerId;</span><br><span class="line">        <span class="built_in">this</span>.sellerId = sellerId;</span><br><span class="line">        <span class="built_in">this</span>.productId = productId;</span><br><span class="line">        <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">        <span class="built_in">this</span>.status = STATUS.TO_BE_EXECUTD;</span><br><span class="line">        <span class="built_in">this</span>.createTimestamp = System.currentTimestamp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> InvalidTransactionException &#123;</span><br><span class="line">        <span class="keyword">if</span> ((buyerId == <span class="literal">null</span> || (sellerId == <span class="literal">null</span> || amount &lt; <span class="number">0.0</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTransactionException</span>(...);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (status == STATUS.EXECUTED) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLocked</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isLocked = RedisDistributedLock.getSingletonIntance().lockTransction(id);</span><br><span class="line">            <span class="keyword">if</span> (!isLocked) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 锁定未成功，返回 false，job 兜底执行</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (status == STATUS.EXECUTED) <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// double check</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">executionInvokedTimestamp</span> <span class="operator">=</span> System.currentTimestamp();</span><br><span class="line">            <span class="keyword">if</span> (executionInvokedTimestamp - createdTimestap &gt; 14days) &#123;</span><br><span class="line">                <span class="built_in">this</span>.status = STATUS.EXPIRED;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">WalletRpcService</span> <span class="variable">walletRpcService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WalletRpcService</span>();</span><br><span class="line">            <span class="type">String</span> <span class="variable">walletTransactionId</span> <span class="operator">=</span> walletRpcService.moveMoney(id, buyerId, sellerId);</span><br><span class="line">            <span class="keyword">if</span> (walletTransactionId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.walletTransactionId = walletTransactionId;</span><br><span class="line">                <span class="built_in">this</span>.status = STATUS.EXECUTED;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.status = STATUS.FAILED;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">                RedisDistributedLock.getSingletonIntance().unlockTransction(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 Transaction 类中，主要逻辑集中在 execute() 函数中，所以它是我们测试的重点对象。为了尽可能全面覆盖各种正常和异常情况，针对这个函数，我设计了下面 6 个测试用例：</p><ol><li>正常情况下，交易执行成功，回填用于对账（交易与钱包的交易流水）用的 walletTransactionId，交易状态设置为 EXECUTED，函数返回 true。</li><li>buyerId、sellerId 为 null、amount 小于 0，返回 InvalidTransactionException。</li><li>交易已过期（createTimestamp 超过 14 天），交易状态设置为 EXPIRED，返回 false。</li><li>交易已经执行了（status&#x3D;&#x3D;EXECUTED），不再重复执行转钱逻辑，返回 true。</li><li>钱包（WalletRpcService）转钱失败，交易状态设置为 FAILED，函数返回 false。</li><li>交易正在执行着，不会被重复执行，函数直接返回 false。</li></ol><p>测试用例设计完了。现在看起来似乎一切进展顺利。但是，事实是，当我们将测试用例落实到具体的代码实现时，你就会发现有很多行不通的地方。对于上面的测试用例，第 2 个实现起来非常简单，我就不做介绍了。我们重点来看其中的 1 和 3。</p><p>现在，我们就来看测试用例 1 的代码实现。具体如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buyerId</span> <span class="operator">=</span> <span class="number">123L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sellerId</span> <span class="operator">=</span> <span class="number">234L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">productId</span> <span class="operator">=</span> <span class="number">345L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> <span class="number">456L</span>;</span><br><span class="line">    <span class="type">Transction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="literal">null</span>, buyerId, sellerId, productId,orderId);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">executedResult</span> <span class="operator">=</span> transaction.execute();</span><br><span class="line">    assertTrue(executedResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>execute() 函数的执行依赖两个外部的服务，一个是 RedisDistributedLock，一个 WalletRpcService。这就导致上面的单元测试代码存在下面几个问题：</p><ul><li>如果要让这个单元测试能够运行，我们需要搭建 Redis 服务和 Wallet RPC 服务。搭建和维护的成本比较高。</li><li>我们还需要保证将伪造的 transaction 数据发送给 Wallet RPC 服务之后，能够正确返回我们期望的结果，然而 Wallet RPC 服务有可能是第三方（另一个团队开发维护的）的服务，并不是我们可控的。换句话说，并不是我们想让它返回什么数据就返回什么。</li><li>Transaction 的执行跟 Redis、RPC 服务通信，需要走网络，耗时可能会比较长，对单元测试本身的执行性能也会有影响。</li><li>网络的中断、超时、Redis、RPC 服务的不可用，都会影响单元测试的执行。</li></ul><p>我们回到单元测试的定义上来看一下。单元测试主要是<strong>测试程序员自己编写的代码逻辑的正确性</strong>，并非是端到端的集成测试，它不需要测试所依赖的外部系统（分布式锁、Wallet RPC 服务）的逻辑正确性。所以，如果代码中依赖了外部系统或者不可控组件，比如，需要依赖数据库、网络通信、文件系统等，那我们就需要<strong>将被测代码与外部系统解依赖</strong>，而这种解依赖的方法就叫作“mock”。所谓的 mock 就是用一个“假”的服务替换真正的服务。mock 的服务完全在我们的控制之下，模拟输出我们想要的数据。</p><p>那如何来 mock 服务呢？mock 的方式主要有两种，手动 mock 和利用框架 mock。利用框架 mock 仅仅是为了简化代码编写，每个框架的 mock 方式都不大一样。我们这里只展示手动 mock。</p><p>我们通过继承 WalletRpcService 类，并且重写其中的 moveMoney() 函数的方式来实现 mock。具体的代码实现如下所示。通过 mock 的方式，我们可以让 moveMoney() 返回任意我们想要的数据，完全在我们的控制范围内，并且不需要真正进行网络通信。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MockWalletRpcServiceOne</span> <span class="keyword">extends</span> <span class="title class_">WalletRpcService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">moveMoney</span><span class="params">(Long id, Long fromUserId, Long toUserId, Double amounnt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;123bac&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MockWalletRpcServiceTwo</span> <span class="keyword">extends</span> <span class="title class_">WalletRpcService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">moveMoney</span><span class="params">(Long id, Long fromUserId, Long toUserId, Double amount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们再来看，如何用 MockWalletRpcServiceOne、MockWalletRpcServiceTwo 来替换代码中的真正的 WalletRpcService 呢？</p><p>因为 WalletRpcService 是在 execute() 函数中通过 new 的方式创建的，我们无法动态地对其进行替换。也就是说，Transaction 类中的 execute() 方法的可测试性很差，需要通过重构来让其变得更容易测试。要解决这个问题，我们需要使用依赖注入的方式，将 WalletRpcService 对象的创建反转给上层逻辑，在外部创建好之后，再注入到 Transaction 类中。重构之后的 Transaction 类的代码如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// 添加一个成员变量及其 set 方法</span></span><br><span class="line">    <span class="keyword">private</span> WalletRpcService walletRpcService;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWalletRpcService</span><span class="params">(WalletRpcService walletRpcService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.walletRpcService = walletRpcService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 删除下面这一行代码</span></span><br><span class="line">        <span class="comment">// WalletRpcService walletRpcService = new WalletRpcService();</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在，我们就可以在单元测试中，非常容易地将 WalletRpcService 替换成 MockWalletRpcServiceOne 或 WalletRpcServiceTwo 了。重构之后的代码对应的单元测试如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buyerId</span> <span class="operator">=</span> <span class="number">123L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sellerId</span> <span class="operator">=</span> <span class="number">234L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">productId</span> <span class="operator">=</span> <span class="number">345L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> <span class="number">456L</span>;</span><br><span class="line">    <span class="type">Transction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="literal">null</span>, buyerId, sellerId, productId, orderId);</span><br><span class="line">    <span class="comment">// 使用 mock 对象来替代真正的 RPC 服务</span></span><br><span class="line">    transaction.setWalletRpcService(<span class="keyword">new</span> <span class="title class_">MockWalletRpcServiceOne</span>());</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">executedResult</span> <span class="operator">=</span> transaction.execute();</span><br><span class="line">    assertTrue(executedResult);</span><br><span class="line">    assertEquals(STATUS.EXECUTED, transaction.getStatus());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WalletRpcService 的 mock 和替换问题解决了，我们再来看 RedisDistributedLock。它的 mock 和替换要复杂一些，主要是因为 RedisDistributedLock 是一个单例类。单例相当于一个全局变量，我们无法 mock（无法继承和重写方法），也无法通过依赖注入的方式来替换。</p><p>如果 RedisDistributedLock 是我们自己维护的，可以自由修改、重构，那我们可以将其改为非单例的模式，或者定义一个接口，比如 IDistributedLock，让 RedisDistributedLock 实现这个接口。这样我们就可以像前面 WalletRpcService 的替换方式那样，替换 RedisDistributedLock 为 MockRedisDistributedLock 了。但如果 RedisDistributedLock 不是我们维护的，我们无权去修改这部分代码，这个时候该怎么办呢？</p><p>我们可以对 transaction 上锁这部分逻辑重新封装一下。具体代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RedisDistributedLock.getSingletonIntance().lockTransction(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        RedisDistributedLock.getSingletonIntance().unlockTransction(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> TransactionLock lock;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTransactionLock</span><span class="params">(TransactionLock lock)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            isLocked = lock.lock();</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLocked) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>针对重构过的代码，我们的单元测试代码修改为下面这个样子。这样，我们就能在单元测试代码中隔离真正的 RedisDistributedLock 分布式锁这部分逻辑了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buyerId</span> <span class="operator">=</span> <span class="number">123L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sellerId</span> <span class="operator">=</span> <span class="number">234L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">productId</span> <span class="operator">=</span> <span class="number">345L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> <span class="number">456L</span>;</span><br><span class="line">    <span class="type">TransactionLock</span> <span class="variable">mockLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionLock</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String id)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Transction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="comment">/*...*/</span>);</span><br><span class="line">    transaction.setWalletRpcService(<span class="keyword">new</span> <span class="title class_">MockWalletRpcServiceOne</span>());</span><br><span class="line">    transaction.setTransactionLock(mockLock);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">executedResult</span> <span class="operator">=</span> transaction.execute();</span><br><span class="line">    assertTrue(executedResult);</span><br><span class="line">    assertEquals(STATUS.EXECUTED, transaction.getStatus());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，测试用例 1 就算写好了。我们通过依赖注入和 mock，让单元测试代码不依赖任何不可控的外部服务。你可以照着这个思路，自己写一下测试用例 4、5、6。</p><p>现在，我们再来看测试用例 3：交易已过期（createTimestamp 超过 14 天），交易状态设置为 EXPIRED，返回 false。针对这个单元测试用例，我们还是先把代码写出来，然后再来分析。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute_with_TransactionIsExpired</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buyerId</span> <span class="operator">=</span> <span class="number">123L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sellerId</span> <span class="operator">=</span> <span class="number">234L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">productId</span> <span class="operator">=</span> <span class="number">345L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> <span class="number">456L</span>;</span><br><span class="line">    <span class="type">Transction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="comment">/*...*/</span>);</span><br><span class="line">    transaction.setCreatedTimestamp(System.currentTimestamp() - 14days);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">actualResult</span> <span class="operator">=</span> transaction.execute();</span><br><span class="line">    assertFalse(actualResult);</span><br><span class="line">    assertEquals(STATUS.EXPIRED, transaction.getStatus());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码看似没有任何问题。我们将 transaction 的创建时间 createdTimestamp 设置为 14 天前，也就是说，当单元测试代码运行的时候，transaction 一定是处于过期状态。但是，如果在 Transaction 类中，并没有暴露修改 createdTimestamp 成员变量的 set 方法（也就是没有定义 setCreatedTimestamp() 函数）呢？</p><p>你可能会说，如果没有 createTimestamp 的 set 方法，我就重新添加一个呗！实际上，这违反了类的封装特性。在 Transaction 类的设计中，createTimestamp 是在交易生成时（也就是构造函数中）自动获取的系统时间，本来就不应该人为地轻易修改，所以，暴露 createTimestamp 的 set 方法，虽然带来了灵活性，但也带来了不可控性。因为，我们无法控制使用者是否会调用 set 方法重设 createTimestamp，而重设 createTimestamp 并非我们的预期行为。</p><p>那如果没有针对 createTimestamp 的 set 方法，那测试用例 3 又该如何实现呢？实际上，这是一类比较常见的问题，就是代码中包含跟“时间”有关的“未决行为”逻辑。我们一般的处理方式是将这种未决行为逻辑重新封装。针对 Transaction 类，我们只需要将交易是否过期的逻辑，封装到 isExpired() 函数中即可，具体的代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">executionInvokedTimestamp</span> <span class="operator">=</span> System.currentTimestamp();</span><br><span class="line">        <span class="keyword">return</span> executionInvokedTimestamp - createdTimestamp &gt; 14days;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> InvalidTransactionException &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span> (isExpired()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.status = STATUS.EXPIRED;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>针对重构之后的代码，测试用例 3 的代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute_with_TransactionIsExpired</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buyerId</span> <span class="operator">=</span> <span class="number">123L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">sellerId</span> <span class="operator">=</span> <span class="number">234L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">productId</span> <span class="operator">=</span> <span class="number">345L</span>;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> <span class="number">456L</span>;</span><br><span class="line">    <span class="type">Transction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="comment">/*...*/</span>) &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">actualResult</span> <span class="operator">=</span> transaction.execute();</span><br><span class="line">    assertFalse(actualResult);</span><br><span class="line">    assertEquals(STATUS.EXPIRED, transaction.getStatus());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过重构，Transaction 代码的可测试性提高了。之前罗列的所有测试用例，现在我们都顺利实现了。不过，Transaction 类的构造函数的设计还有点不妥。为了方便你查看，我把构造函数的代码重新 copy 了一份贴到这里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Transaction</span><span class="params">(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (preAssignedId != <span class="literal">null</span> &amp;&amp; !preAssignedId.isEmpty()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = preAssignedId;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = IdGenerator.generateTransactionId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.id.startWith(<span class="string">&quot;t_&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = <span class="string">&quot;t_&quot;</span> + preAssignedId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.buyerId = buyerId;</span><br><span class="line">    <span class="built_in">this</span>.sellerId = sellerId;</span><br><span class="line">    <span class="built_in">this</span>.productId = productId;</span><br><span class="line">    <span class="built_in">this</span>.orderId = orderId;</span><br><span class="line">    <span class="built_in">this</span>.status = STATUS.TO_BE_EXECUTD;</span><br><span class="line">    <span class="built_in">this</span>.createTimestamp = System.currentTimestamp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们发现，构造函数中并非只包含简单赋值操作。交易 id 的赋值逻辑稍微复杂。我们最好也要测试一下，以保证这部分逻辑的正确性。为了方便测试，我们可以把 id 赋值这部分逻辑单独抽象到一个函数中，具体的代码实现如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Transaction</span><span class="params">(<span class="comment">/*...*/</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    fillTransactionId(preAssignId);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">fillTransactionId</span><span class="params">(String preAssignedId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (preAssignedId != <span class="literal">null</span> &amp;&amp; !preAssignedId.isEmpty()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = preAssignedId;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = IdGenerator.generateTransactionId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.id.startWith(<span class="string">&quot;t_&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = <span class="string">&quot;t_&quot;</span> + preAssignedId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到此为止，我们一步一步将 Transaction 从不可测试代码重构成了测试性良好的代码。不过，你可能还会有疑问，Transaction 类中 isExpired() 函数就不用测试了吗？对于 isExpired() 函数，逻辑非常简单，肉眼就能判定是否有 bug，是可以不用写单元测试的。</p><p>实际上，可测试性差的代码，本身代码设计得也不够好，很多地方都没有遵守我们之前讲到的设计原则和思想，比如“基于接口而非实现编程”思想、依赖反转原则等。重构之后的代码，不仅可测试性更好，而且从代码设计的角度来说，也遵从了经典的设计原则和思想。这也印证了我们之前说过的，代码的可测试性可以从侧面上反应代码设计是否合理。除此之外，在平时的开发中，我们也要多思考一下，这样编写代码，是否容易编写单元测试，这也有利于我们设计出好的代码。</p><p>常见的测试不友好的代码有下面这 5 种：</p><ul><li>代码中包含未决行为逻辑：所谓的未决行为逻辑就是，代码的输出是随机或者说不确定的，比如，跟时间、随机数有关的代码。</li><li>滥用可变全局变量：当代码中含有全局变量，会导致并发执行测试用例时，全局变量属性发生变化，从而导致测试失败</li><li>滥用静态方法：通常情况下，静态方法很难 mock</li><li>使用复杂的继承关系：相比组合关系，继承关系的代码结构更加耦合、不灵活，更加不易扩展、不易维护。实际上，继承关系也更加难测试。如果父类需要 mock 某个依赖对象才能进行单元测试，那所有的子类、子类的子类……在编写单元测试的时候，都要 mock 这个依赖对象。</li><li>高度耦合的代码：如果一个类职责很重，需要依赖十几个外部对象才能完成工作，代码高度耦合，那我们在编写单元测试的时候，可能需要 mock 这十几个依赖的对象。不管是从代码设计的角度来说，还是从编写单元测试的角度来说，这都是不合理的。</li></ul><h2 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h2><p>软件设计与开发最重要的工作之一就是应对复杂性。人处理复杂性的能力是有限的。过于复杂的代码往往在可读性、可维护性上都不友好。那如何来控制代码的复杂性呢？手段有很多，我个人认为，最关键的就是解耦，保证代码松耦合、高内聚。如果说重构是保证代码质量不至于腐化到无可救药地步的有效手段，那么利用解耦的方法对代码重构，就是保证代码不至于复杂到无法控制的有效手段。</p><p>“高内聚、松耦合”是一个比较通用的设计思想，不仅可以指导细粒度的类和类之间关系的设计，还能指导粗粒度的系统、架构、模块的设计。相对于编码规范，它能够在更高层次上提高代码的可读性和可维护性。</p><p>不管是阅读代码还是修改代码，“高内聚、松耦合”的特性可以让我们聚焦在某一模块或类中，不需要了解太多其他模块或类的代码，让我们的焦点不至于过于发散，降低了阅读和修改代码的难度。而且，因为依赖关系简单，耦合小，修改代码不至于牵一发而动全身，代码改动比较集中，引入 bug 的风险也就减少了很多。同时，“高内聚、松耦合”的代码可测试性也更加好，容易 mock 或者很少需要 mock 外部依赖的模块或者类。</p><p>除此之外，代码“高内聚、松耦合”，也就意味着，代码结构清晰、分层和模块化合理、依赖关系简单、模块或类之间的耦合小，那代码整体的质量就不会差。即便某个具体的类或者模块设计得不怎么合理，代码质量不怎么高，影响的范围是非常有限的。我们可以聚焦于这个模块或者类，做相应的小型重构。而相对于代码结构的调整，这种改动范围比较集中的小型重构的难度就容易多了。</p><h3 id="代码是否需要“解耦”？"><a href="#代码是否需要“解耦”？" class="headerlink" title="代码是否需要“解耦”？"></a>代码是否需要“解耦”？</h3><p>那现在问题来了，我们该怎么判断代码的耦合程度呢？或者说，怎么判断代码是否符合“高内聚、松耦合”呢？再或者说，如何判断系统是否需要解耦重构呢？间接的衡量标准有很多，前面我们讲到了一些，比如，看修改代码会不会牵一发而动全身。</p><p>除此之外，还有一个直接的衡量标准，也是我在阅读源码的时候经常会用到的，那就是把模块与模块之间、类与类之间的依赖关系画出来，根据依赖关系图的复杂性来判断是否需要解耦重构。</p><p>如果依赖关系复杂、混乱，那从代码结构上来讲，可读性和可维护性肯定不是太好，那我们就需要考虑是否可以通过解耦的方法，让依赖关系变得清晰、简单。当然，这种判断还是有比较强的主观色彩，但是可以作为一种参考和梳理依赖的手段，配合间接的衡量标准一块来使用。</p><h3 id="如何给代码“解耦”？"><a href="#如何给代码“解耦”？" class="headerlink" title="如何给代码“解耦”？"></a>如何给代码“解耦”？</h3><p>前面我们能讲了解耦的重要性，以及如何判断是否需要解耦，接下来，我们再来看一下，如何进行解耦。</p><h4 id="封装与抽象"><a href="#封装与抽象" class="headerlink" title="封装与抽象"></a>封装与抽象</h4><p>封装和抽象作为两个非常通用的设计思想，可以应用在很多设计场景中，比如系统、模块、lib、组件、接口、类等等的设计。封装和抽象可以有效地隐藏实现的复杂性，隔离实现的易变性，给依赖的模块提供稳定且易用的抽象接口。</p><p>比如，Unix 系统提供的 open() 文件操作函数，我们用起来非常简单，但是底层实现却非常复杂，涉及权限控制、并发控制、物理存储等等。我们通过将其封装成一个抽象的 open() 函数，能够有效控制代码复杂性的蔓延，将复杂性封装在局部代码中。除此之外，因为 open() 函数基于抽象而非具体的实现来定义，所以我们在改动 open() 函数的底层实现的时候，并不需要改动依赖它的上层代码，也符合我们前面提到的“高内聚、松耦合”代码的评判标准。</p><h4 id="中间层"><a href="#中间层" class="headerlink" title="中间层"></a>中间层</h4><p>引入中间层能简化模块或类之间的依赖关系。比如在引入数据存储中间层之前，A、B、C 三个模块都要依赖内存一级缓存、Redis 二级缓存、DB 持久化存储三个模块。在引入中间层之后，三个模块只需要依赖数据存储一个模块即可。</p><p>除此之外，我们在进行重构的时候，引入中间层可以起到过渡的作用，能够让开发和重构同步进行，不互相干扰。比如，某个接口设计得有问题，我们需要修改它的定义，同时，所有调用这个接口的代码都要做相应的改动。如果新开发的代码也用到这个接口，那开发就跟重构冲突了。为了让重构能小步快跑，我们可以分下面四个阶段来完成接口的修改：</p><ul><li>第一阶段：引入一个中间层，包裹老的接口，提供新的接口定义。</li><li>第二阶段：新开发的代码依赖中间层提供的新接口。</li><li>第三阶段：将依赖老接口的代码改为调用新接口。</li><li>第四阶段：确保所有的代码都调用新接口之后，删除掉老的接口。</li></ul><p>这样，每个阶段的开发工作量都不会很大，都可以在很短的时间内完成。重构跟开发冲突的概率也变小了。</p><h4 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h4><p>很多大型软件（比如 Windows）之所以能做到几百、上千人有条不紊地协作开发，就是归功于模块化做得好。不同的模块之间通过 API 来进行通信，每个模块之间耦合很小，每个小的团队聚焦于一个独立的高内聚模块来开发，最终像搭积木一样将各个模块组装起来，构建成一个超级复杂的系统。</p><p>我们再聚焦到代码层面。合理地划分模块能有效地解耦代码，提高代码的可读性和可维护性。所以，我们在开发代码的时候，一定要有模块化意识，将每个模块都当作一个独立的 lib 一样来开发，只提供封装了内部实现细节的接口给其他模块使用，这样可以减少不同模块之间的耦合度。</p><p>实际上，从刚刚的讲解中我们也可以发现，模块化的思想无处不在，像 SOA、微服务、lib 库、系统内模块划分，甚至是类、函数的设计，都体现了模块化思想。如果追本溯源，模块化思想更加本质的东西就是分而治之。</p><h2 id="如何发现代码问题？"><a href="#如何发现代码问题？" class="headerlink" title="如何发现代码问题？"></a>如何发现代码问题？</h2><p>从大处着眼的话，我们可以参考之前讲过的代码质量评判标准，看这段代码是否可读、可扩展、可维护、灵活、简洁、可复用、可测试等等。落实到具体细节，我们可以从以下几个方面来审视代码。</p><ul><li>目录设置是否合理、模块划分是否清晰、代码结构是否满足“高内聚、松耦合”？</li><li>是否遵循经典的设计原则和设计思想（SOLID、DRY、KISS、YAGNI、LOD 等）？</li><li>设计模式是否应用得当？是否有过度设计？</li><li>代码是否容易扩展？如果要添加新功能，是否容易实现？</li><li>代码是否可以复用？是否可以复用已有的项目代码或类库？是否有重复造轮子？</li><li>代码是否容易测试？单元测试是否全面覆盖了各种正常和异常的情况？</li><li>代码是否易读？是否符合编码规范（比如命名和注释是否恰当、代码风格是否一致等）？</li></ul><p>以上是一些通用的关注点，可以作为常规检查项，套用在任何代码的重构上。除此之外，我们还要关注代码实现是否满足业务本身特有的功能和非功能需求。我罗列了一些比较有共性的问题，如下所示。这份列表可能还不够全面，剩下的需要你针对具体的业务、具体的代码去具体分析。</p><ul><li>代码是否实现了预期的业务需求？</li><li>逻辑是否正确？是否处理了各种异常情况？</li><li>日志打印是否得当？是否方便 debug 排查问题？</li><li>接口是否易用？是否支持幂等、事务等？</li><li>代码是否存在并发问题？是否线程安全？</li><li>性能是否有优化空间，比如，SQL、算法是否可以优化？</li><li>是否有安全漏洞？比如输入输出校验是否全面？</li></ul><h3 id="重构案例"><a href="#重构案例" class="headerlink" title="重构案例"></a>重构案例</h3><p>有如下ID生成器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(IdGenerator.classs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hostName</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostName();</span><br><span class="line">            String[] tokens = hostName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (tokens.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                hostName = tokens[tokens.length - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span>[] randomChars = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">8</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">randomAscii</span> <span class="operator">=</span> random.nextInt(<span class="number">122</span>);</span><br><span class="line">                <span class="keyword">if</span> (randomAscii &gt;= <span class="number">48</span> &amp;&amp; randomAscii &lt;= <span class="number">57</span>) &#123;</span><br><span class="line">                    randomChars[count] = (<span class="type">char</span>)(<span class="string">&#x27;0&#x27;</span> + (randomAscii - <span class="number">48</span>));</span><br><span class="line">                    count++;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (randomAscii &gt;= <span class="number">65</span> &amp;&amp; randomAscii &lt;= <span class="number">90</span>) &#123;</span><br><span class="line">                    randomChars[count] = (<span class="type">char</span>)(<span class="string">&#x27;A&#x27;</span> + (randomAscii - <span class="number">65</span>));</span><br><span class="line">                    count++;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (randomAscii &gt;= <span class="number">97</span> &amp;&amp; randomAscii &lt;= <span class="number">122</span>) &#123;</span><br><span class="line">                    randomChars[count] = (<span class="type">char</span>)(<span class="string">&#x27;a&#x27;</span> + (randomAscii - <span class="number">97</span>));</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            id = String.format(<span class="string">&quot;%s-%d-%s&quot;</span>, hostName,</span><br><span class="line">            System.currentTimeMillis(), <span class="keyword">new</span> <span class="title class_">String</span>(randomChars));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Failed to get the host name.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按之前的计划，此次重构将分成四轮：</p><ul><li>第一轮重构：提高代码的可读性</li><li>第二轮重构：提高代码的可测试性</li><li>第三轮重构：编写完善的单元测试</li><li>第四轮重构：所有重构完成之后添加注释</li></ul><h4 id="第一轮重构：提高代码的可读性"><a href="#第一轮重构：提高代码的可读性" class="headerlink" title="第一轮重构：提高代码的可读性"></a>第一轮重构：提高代码的可读性</h4><p>首先，我们要解决最明显、最急需改进的代码可读性问题。具体有下面几点：</p><ul><li>hostName 变量不应该被重复使用，尤其当这两次使用时的含义还不同的时候；</li><li>将获取 hostName 的代码抽离出来，定义为 getLastfieldOfHostName() 函数；</li><li>删除代码中的魔法数，比如，57、90、97、122；</li><li>将随机数生成的代码抽离出来，定义为 generateRandomAlphameric() 函数；</li><li>generate() 函数中的三个 if 逻辑重复了，且实现过于复杂，我们要对其进行简化；</li><li>对 IdGenerator 类重命名，并且抽象出对应的接口。</li></ul><p>重构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line">    String <span class="title function_">generate</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogTraceIdGenerator</span> <span class="keyword">extends</span> <span class="title class_">IdGenerator</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RandomIdGenerator.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> getLastfieldOfHostName();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomString</span> <span class="operator">=</span> generateRandomAlphameric(<span class="number">8</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s-%d-%s&quot;</span>, substrOfHostName, currentTimeMillis, randomString);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getLastfieldOfHostName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hostName</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostName();</span><br><span class="line">            String[] tokens = hostName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">            substrOfHostName = tokens[tokens.length - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Failed to get the host name.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateRandomAlphameric</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] randomChars = <span class="keyword">new</span> <span class="title class_">char</span>[length];</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">while</span> (count &lt; length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">maxAscii</span> <span class="operator">=</span> <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">randomAscii</span> <span class="operator">=</span> random.nextInt(maxAscii);</span><br><span class="line">            <span class="type">boolean</span> isDigit= randomAscii &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isUppercase= randomAscii &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isLowercase= randomAscii &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDigit|| isUppercase || isLowercase) &#123;</span><br><span class="line">                randomChars[count] = (<span class="type">char</span>) (randomAscii);</span><br><span class="line">                ++count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(randomChars);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//代码使用举例</span></span><br><span class="line"><span class="type">LogTraceIdGenerator</span> <span class="variable">logTraceIdGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomIdGenerator</span>();</span><br><span class="line">logTraceIdGenerator.generate();</span><br></pre></td></tr></table></figure><h3 id="第二轮重构：提高代码的可测试性"><a href="#第二轮重构：提高代码的可测试性" class="headerlink" title="第二轮重构：提高代码的可测试性"></a>第二轮重构：提高代码的可测试性</h3><p>关于代码可测试性的问题，主要包含下面两个方面：</p><ul><li>generate() 函数定义为静态函数，会影响使用该函数的代码的可测试性；</li><li>generate() 函数的代码实现依赖运行环境（本机名）、时间函数、随机函数，所以</li><li>generate() 函数本身的可测试性也不好。</li></ul><p>对于第一点，我们已经在第一轮重构中解决了。我们将 RandomIdGenerator 类中的 generate() 静态函数重新定义成了普通函数。调用者可以通过依赖注入的方式，在外部创建好 RandomIdGenerator 对象后注入到自己的代码中，从而解决静态函数调用影响代码可测试性的问题。</p><p>对于第二点，我们需要在第一轮重构的基础之上再进行重构。重构之后的代码如下所示，主要包括以下几个代码改动。</p><ul><li>从 getLastfieldOfHostName() 函数中，将逻辑比较复杂的那部分代码剥离出来，定义为 getLastSubstrSplittedByDot() 函数。因为 getLastfieldOfHostName() 函数依赖本地主机名，所以，剥离出主要代码之后这个函数变得非常简单，可以不用测试。我们重点测试 getLastSubstrSplittedByDot() 函数即可。</li><li>将 generateRandomAlphameric() 和 getLastSubstrSplittedByDot() 这两个函数的访问权限设置为 protected。这样做的目的是，可以直接在单元测试中通过对象来调用两个函数进行测试。</li><li>给 generateRandomAlphameric() 和 getLastSubstrSplittedByDot() 两个函数添加 Google Guava 的 annotation @VisibleForTesting。这个 annotation 没有任何实际的作用，只起到标识的作用，告诉其他人说，这两个函数本该是 private 访问权限的，之所以提升访问权限到 protected，只是为了测试，只能用于单元测试中。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RandomIdGenerator.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> getLastfieldOfHostName();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomString</span> <span class="operator">=</span> generateRandomAlphameric(<span class="number">8</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s-%d-%s&quot;</span>, substrOfHostName, currentTimeMillis, randomString);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getLastfieldOfHostName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hostName</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostName();</span><br><span class="line">            substrOfHostName = getLastSubstrSplittedByDot(hostName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Failed to get the host name.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getLastSubstrSplittedByDot</span><span class="params">(String hostName)</span> &#123;</span><br><span class="line">        String[] tokens = hostName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> tokens[tokens.length - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">generateRandomAlphameric</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] randomChars = <span class="keyword">new</span> <span class="title class_">char</span>[length];</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">while</span> (count &lt; length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">maxAscii</span> <span class="operator">=</span> <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">randomAscii</span> <span class="operator">=</span> random.nextInt(maxAscii);</span><br><span class="line">            <span class="type">boolean</span> isDigit= randomAscii &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isUppercase= randomAscii &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isLowercase= randomAscii &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDigit|| isUppercase || isLowercase) &#123;</span><br><span class="line">                randomChars[count] = (<span class="type">char</span>) (randomAscii);</span><br><span class="line">                ++count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(randomChars);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印日志的 Logger 对象被定义为 static final 的，并且在类内部创建，这是否影响到代码的可测试性？是否应该将 Logger 对象通过依赖注入的方式注入到类中呢？</p><p>依赖注入之所以能提高代码可测试性，主要是因为，通过这样的方式我们能轻松地用 mock 对象替换依赖的真实对象。那我们为什么要 mock 这个对象呢？这是因为，这个对象参与逻辑执行（比如，我们要依赖它输出的数据做后续的计算）但又不可控。对于 Logger 对象来说，我们只往里写入数据，并不读取数据，不参与业务逻辑的执行，不会影响代码逻辑的正确性，所以，我们没有必要 mock Logger 对象。</p><p>除此之外，一些只是为了存储数据的值对象，比如 String、Map、UseVo，我们也没必要通过依赖注入的方式来创建，直接在类中通过 new 创建就可以了。</p><h3 id="第三轮重构：编写完善的单元测试"><a href="#第三轮重构：编写完善的单元测试" class="headerlink" title="第三轮重构：编写完善的单元测试"></a>第三轮重构：编写完善的单元测试</h3><p>经过上面的重构之后，代码存在的比较明显的问题，基本上都已经解决了。我们现在为代码补全单元测试。RandomIdGenerator 类中有 4 个函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getLastfieldOfHostName</span><span class="params">()</span>;</span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">getLastSubstrSplittedByDot</span><span class="params">(String hostName)</span>;</span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">generateRandomAlphameric</span><span class="params">(<span class="type">int</span> length)</span>;</span><br></pre></td></tr></table></figure><p>我们先来看后两个函数。这两个函数包含的逻辑比较复杂，是我们测试的重点。而且，在上一步重构中，为了提高代码的可测试性，我们已经这两个部分代码跟不可控的组件（本机名、随机函数、时间函数）进行了隔离。所以，我们只需要设计完备的单元测试用例即可。具体的代码实现如下所示（注意，我们使用了 Junit 测试框架）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomIdGeneratorTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetLastSubstrSplittedByDot</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RandomIdGenerator</span> <span class="variable">idGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomIdGenerator</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualSubstr</span> <span class="operator">=</span> idGenerator.getLastSubstrSplittedByDot(<span class="string">&quot;field1.field2&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;field3&quot;</span>, actualSubstr);</span><br><span class="line">        actualSubstr = idGenerator.getLastSubstrSplittedByDot(<span class="string">&quot;field1&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;field1&quot;</span>, actualSubstr);</span><br><span class="line">        actualSubstr = idGenerator.getLastSubstrSplittedByDot(<span class="string">&quot;field1#field2$field3&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;field1#field2#field3&quot;</span>, actualSubstr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此单元测试会失败，因为我们在代码中没有处理hostName为null或空字符串的情况</span></span><br><span class="line">    <span class="comment">// 这部分优化留在第36、37节课中讲解</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetLastSubstrSplittedByDot_nullOrEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RandomIdGenerator</span> <span class="variable">idGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomIdGenerator</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualSubstr</span> <span class="operator">=</span> idGenerator.getLastSubstrSplittedByDot(<span class="literal">null</span>);</span><br><span class="line">        Assert.assertNull(actualSubstr);</span><br><span class="line">        actualSubstr = idGenerator.getLastSubstrSplittedByDot(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;&quot;</span>, actualSubstr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateRandomAlphameric</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RandomIdGenerator</span> <span class="variable">idGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomIdGenerator</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualRandomString</span> <span class="operator">=</span> idGenerator.generateRandomAlphameric(<span class="number">6</span>);</span><br><span class="line">        Assert.assertNotNull(actualRandomString);</span><br><span class="line">        Assert.assertEquals(<span class="number">6</span>, actualRandomString.length());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> c : actualRandomString.toCharArray()) &#123;</span><br><span class="line">            Assert.assertTrue((<span class="string">&#x27;0&#x27;</span> &lt; c &amp;&amp; c &gt; <span class="string">&#x27;9&#x27;</span>) || (<span class="string">&#x27;a&#x27;</span> &lt; c &amp;&amp; c &gt; <span class="string">&#x27;z&#x27;</span>) || (<span class="string">&#x27;A&#x27;</span> &lt; c &amp;&amp; c &gt; <span class="string">&#x27;A&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 此单元测试会失败，因为我们在代码中没有处理length&lt;=0的情况</span></span><br><span class="line">    <span class="comment">// 这部分优化留在第36、37节课中讲解</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateRandomAlphameric_lengthEqualsOrLessThanZero</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RandomIdGenerator</span> <span class="variable">idGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomIdGenerator</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">actualRandomString</span> <span class="operator">=</span> idGenerator.generateRandomAlphameric(<span class="number">0</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;&quot;</span>, actualRandomString);</span><br><span class="line">        actualRandomString = idGenerator.generateRandomAlphameric(-<span class="number">1</span>);</span><br><span class="line">        Assert.assertNull(actualRandomString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们再来看 generate() 函数。这个函数也是我们唯一一个暴露给外部使用的 public 函数。虽然逻辑比较简单，最好还是测试一下。但是，它依赖主机名、随机函数、时间函数，我们该如何测试呢？需要 mock 这些函数的实现吗？</p><p>实际上，这要分情况来看。我们前面讲过，写单元测试的时候，测试对象是函数定义的功能，而非具体的实现逻辑。这样我们才能做到，函数的实现逻辑改变了之后，单元测试用例仍然可以工作。那 generate() 函数实现的功能是什么呢？这完全是由代码编写者自己来定义的。</p><p>比如，针对同一份 generate() 函数的代码实现，我们可以有 3 种不同的功能定义，对应 3 种不同的单元测试。</p><ol><li>如果我们把 generate() 函数的功能定义为：“生成一个随机唯一 ID”，那我们只要测试多次调用 generate() 函数生成的 ID 是否唯一即可。</li><li>如果我们把 generate() 函数的功能定义为：“生成一个只包含数字、大小写字母和中划线的唯一 ID”，那我们不仅要测试 ID 的唯一性，还要测试生成的 ID 是否只包含数字、大小写字母和中划线。</li><li>如果我们把 generate() 函数的功能定义为：“生成唯一 ID，格式为：{主机名 substr}-{时间戳}-{8 位随机数}。在主机名获取失败时，返回：null-{时间戳}-{8 位随机数}”，那我们不仅要测试 ID 的唯一性，还要测试生成的 ID 是否完全符合格式要求。</li></ol><p>总结一下，单元测试用例如何写，关键看你如何定义函数。针对 generate() 函数的前两种定义，我们不需要 mock 获取主机名函数、随机函数、时间函数等，但对于第 3 种定义，我们需要 mock 获取主机名函数，让其返回 null，测试代码运行是否符合预期。</p><p>最后，我们来看下 getLastfieldOfHostName() 函数。实际上，这个函数不容易测试，因为它调用了一个静态函数（InetAddress.getLocalHost().getHostName();），并且这个静态函数依赖运行环境。但是，这个函数的实现非常简单，肉眼基本上可以排除明显的 bug，所以我们可以不为其编写单元测试代码。毕竟，我们写单元测试的目的是为了减少代码 bug，而不是为了写单元测试而写单元测试。</p><h2 id="函数出错应该返回什么？"><a href="#函数出错应该返回什么？" class="headerlink" title="函数出错应该返回什么？"></a>函数出错应该返回什么？</h2><p>对于函数出错返回数据类型，我总结了 4 种情况，它们分别是：错误码、NULL 值、空对象、异常对象。</p><h3 id="返回错误码"><a href="#返回错误码" class="headerlink" title="返回错误码"></a>返回错误码</h3><p>C 语言没有异常这样的语法机制，返回错误码便是最常用的出错处理方式。而 Java、Python 等比较新的编程语言中，大部分情况下，我们都用异常来处理函数出错的情况，极少会用到错误码。</p><h3 id="返回-NULL-值"><a href="#返回-NULL-值" class="headerlink" title="返回 NULL 值"></a>返回 NULL 值</h3><p>在多数编程语言中，我们用 NULL 来表示“不存在”这种语义。对于查找函数来说，数据不存在并非一种异常情况，是一种正常行为，所以返回表示不存在语义的 NULL 值比返回异常更加合理。</p><h3 id="返回空对象"><a href="#返回空对象" class="headerlink" title="返回空对象"></a>返回空对象</h3><p>返回 NULL 值有各种弊端，对此有一个比较经典的应对策略，那就是应用空对象设计模式。当函数返回的数据是字符串类型或者集合类型的时候，我们可以用空字符串或空集合替代 NULL 值，来表示不存在的情况。这样，我们在使用函数的时候，就可以不用做 NULL 值判断。</p><h3 id="抛出异常对象"><a href="#抛出异常对象" class="headerlink" title="抛出异常对象"></a>抛出异常对象</h3><p>尽管前面讲了很多函数出错的返回数据类型，但是，最常用的函数出错处理方式是抛出异常。异常有两种类型：受检异常和非受检异常。</p><p>对于应该用受检异常还是非受检异常，网上的争论有很多，但也并没有一个非常强有力的理由，说明一个就一定比另一个更好。所以，我们只需要根据团队的开发习惯，在同一个项目中，制定统一的异常处理规范即可。对于函数抛出的异常，我们有三种处理方法：直接吞掉、直接往上抛出、包裹成新的异常抛出。</p><h3 id="对-ID-生成器再次重构"><a href="#对-ID-生成器再次重构" class="headerlink" title="对 ID 生成器再次重构"></a>对 ID 生成器再次重构</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RandomIdGenerator.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为防止生成有异常的 Id，这里最好是明确地将异常告知给调用者，因此这里使用受检异常</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 从代码封装的角度来讲，我们不希望将 UnknownHostException 这个比较底层的异常，暴露给更上层的代码</span></span><br><span class="line"><span class="comment">     * 也就是调用 generate() 函数的代码。而且，调用者拿到这个异常的时候</span></span><br><span class="line"><span class="comment">     * 并不能理解这个异常到底代表了什么，也不知道该如何处理。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * UnknownHostException 异常跟 generate() 函数，在业务概念上没有相关性。所以这里不直接将 UnknownHostException 抛出</span></span><br><span class="line"><span class="comment">     * 而是新包装了一个受检异常：IdGenerationFailureException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generate</span><span class="params">()</span> <span class="keyword">throws</span> IdGenerationFailureException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            substrOfHostName = getLastFiledOfHostName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IdGenerationFailureException</span>(<span class="string">&quot;...&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTimeMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomString</span> <span class="operator">=</span> generateRandomAlphameric(<span class="number">8</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s-%d-%s&quot;</span>, substrOfHostName, currentTimeMillis, randomString);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * UnknownHostException 异常表示主机名获取失败，两者算是业务相关，</span></span><br><span class="line"><span class="comment">     * 所以可以直接将 UnknownHostException 抛出，不需要重新包裹成新的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getLastFiledOfHostName</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hostName</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostName();</span><br><span class="line">        <span class="keyword">if</span> (hostName == <span class="literal">null</span> || hostName.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownHostException</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        substrOfHostName = getLastSubstrSplittedByDot(hostName);</span><br><span class="line">        <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加参数校验，由于此方法不会给外部使用，我们在内部调用时，就应该保证参数不会出错</span></span><br><span class="line"><span class="comment">     * 但为了测试，这里直接抛出异常即可</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getLastSubstrSplittedByDot</span><span class="params">(String hostName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hostName == <span class="literal">null</span> || hostName.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] tokens = hostName.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">substrOfHostName</span> <span class="operator">=</span> tokens[tokens.length - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">return</span> substrOfHostName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * length &lt; 0 时，生成一个长度为负值的随机字符串是不符合常规逻辑的，是一种异常行为。</span></span><br><span class="line"><span class="comment">     * 所以，当传入的参数 length &lt; 0 的时候，我们抛出 IllegalArgumentException 异常。</span></span><br><span class="line"><span class="comment">     * length = 0 时，我们既可以把它定义为一种异常行为，抛出 IllegalArgumentException 异常，也可以</span></span><br><span class="line"><span class="comment">     * 把它定义为一种正常行为，让函数在入参 length = 0 的情况下，直接返回空字符串。不管</span></span><br><span class="line"><span class="comment">     * 选择哪种处理方式，最关键的一点是，要在函数注释中，明确告知 length = 0 的情况下，会返回什么样的数据。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">generateRandomAlphameric</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>[] randomChars = <span class="keyword">new</span> <span class="title class_">char</span>[length];</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">while</span> (count &lt; length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">maxAscii</span> <span class="operator">=</span> <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">randomAscii</span> <span class="operator">=</span> random.nextInt(maxAscii);</span><br><span class="line">            <span class="type">boolean</span> isDigit= randomAscii &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isUppercase= randomAscii &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">            <span class="type">boolean</span> isLowercase= randomAscii &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; randomAscii &lt;= <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDigit|| isUppercase || isLowercase) &#123;</span><br><span class="line">                randomChars[count] = (<span class="type">char</span>) (randomAscii);</span><br><span class="line">                ++count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(randomChars);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><h2 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h2><p>远程连接出现 CredSSP 加密数据库修正的问题时，管理员运行命令行，输入如下命令即可：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">New-Item -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System -Name CredSSP -Force</span><br><span class="line">New-Item -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP -Name Parameters -Force</span><br><span class="line">Get-Item -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters | New-ItemProperty -Name AllowEncryptionOracle -Value 2 -PropertyType DWORD -Force</span><br></pre></td></tr></table></figure><br><h2 id="VS-比例打开"><a href="#VS-比例打开" class="headerlink" title="VS 比例打开"></a>VS 比例打开</h2><p>注册表：</p><p>计算机\HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Layers</p><p>新建字符串值</p><p>数值名称为 devenv.exe 的绝对路径</p><p>根据你使用的Visual Studio版本，使用不同的值（对应更改2017&#x2F;2019，C&#x2F;D盘等等）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\IDE\devenv.exe</span><br><span class="line">C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Common7\IDE\devenv.exe</span><br><span class="line">C:\Program Files (x86)\Microsoft Visual Studio\2017\Professional\Common7\IDE\devenv.exe</span><br></pre></td></tr></table></figure><p>填写数值数据：<code>DPIUNAWARE</code></p><h1 id="C-1"><a href="#C-1" class="headerlink" title="C#"></a>C#</h1><h2 id="自定义控件属性"><a href="#自定义控件属性" class="headerlink" title="自定义控件属性"></a>自定义控件属性</h2><p>在开发自定义控件件时，有好些 Design 属性是要使用的，如ToolboxItem, ToolboxBitmap, Category, Description等等，不知道这些属性其实也可以将控件搞出来，不过，知道了，会令事件更加简单，令控件更加专业和实用。有时，不知道用法，会令到项目的其他同事好烦，因为这个控件是你提供的。下面对一些常用的Design属性做一个简单的生产介绍。</p><h3 id="ToolboxItem"><a href="#ToolboxItem" class="headerlink" title="ToolboxItem"></a>ToolboxItem</h3><p>有没有试过写一个用户控件后，想它不出现在工具箱中，当然有，有时候是控件的Designer部分没有写好或没写，有时候是控件一拖出来就报错，有时候是内部使用的控件，不想别人一引用DLL就出现控件。其它设置方法可以很简单。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ToolboxItem(false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyPanel</span> : <span class="title">UserControl</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就可以了。“可恶”的用户控件就自动隐藏了，不出现在工具箱中。不过，如果你不知道这样的话，可以会引来一大堆的烦事。</p><h3 id="ToolboxBitmap"><a href="#ToolboxBitmap" class="headerlink" title="ToolboxBitmap"></a>ToolboxBitmap</h3><p>写好一个用户控件后，在工具箱中出来的是一个蓝色的齿轮，这就不是很漂亮了，也不能够直观地表达自己的意图。如果更不幸的你的控件的名称好难认的话，其它的开发者会很麻烦的。怎样才能让用户控件在工具箱中显示不同的图标呢?</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ToolboxBitmap(typeof(System.Windows.Forms.Panel))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyPanel</span> : <span class="title">UserControl</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就可以了，表示你所做的用户控件使用的图标是Panel的图标。如果不想用系统的图标，要使用自己的图标，可以这样：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ToolboxBitmap(typeof(MyPanel), <span class="string">&quot;WindowsApplication1.Images.MyPanel.bmp&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyPanel</span> : <span class="title">UserControl</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Category-与-Description"><a href="#Category-与-Description" class="headerlink" title="Category 与 Description"></a>Category 与 Description</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Category(<span class="string">&quot;Appearance&quot;</span>), Description(<span class="string">&quot;阴影色&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> System.Drawing.Color ShadowColor &#123; <span class="keyword">get</span> &#123; …&#125; <span class="keyword">set</span> &#123; …&#125; &#125;</span><br></pre></td></tr></table></figure><p>这两个是经常都会写在一起的属性，Category表示类型，如属性框中所显示的外观，布局等，当然，你可以自己写一个，叫“自定义属性”，而Description就是这个属性的描述，用来说明属性有什么用途。这两个的设置相对都比较简单，可以说，一看就知道，不过提一下，Appearance是特殊的词，在属性面板中，它就是外观一栏。</p><h3 id="DefaultValue"><a href="#DefaultValue" class="headerlink" title="DefaultValue"></a>DefaultValue</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DefaultValue(typeof(Color), <span class="string">&quot;DarkGray&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> System.Drawing.Color ShadowColor &#123; <span class="keyword">get</span> &#123; …&#125; <span class="keyword">set</span> &#123; …&#125; &#125;</span><br></pre></td></tr></table></figure><p>用于设置默认的值，对于string,bool,int，可以直接写出来，如<code>[DefaultValue(10)]</code>，这是可以的，不过，不是这三种类型的话，就比较麻烦，一定要先转化为string才能设置成功。如上面的DarkGray，这是系统定义的颜色，这还是比较好处理的。不过，如果是一些自定义的颜色，如颜色是128,0,128，你应该将128转为16进制，写成0x800080，前缀0x是一定要加的。最后就这样 <code>[DefaultValue(typeof(Color), &quot;0x800080&quot;)]</code></p><h3 id="Browsable"><a href="#Browsable" class="headerlink" title="Browsable"></a>Browsable</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MyTextBox</span> : <span class="title">TextBox</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTextBox</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> s = DefaultText;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Browsable(true)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DefaultText &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>表示，将在属性面板中显示这个属性。</p><p>如果设置为false，将不会显示（但是仍然会在对应的*.Designer.cs中进行序列化）</p><h3 id="DesignerSerializationVisibility"><a href="#DesignerSerializationVisibility" class="headerlink" title="DesignerSerializationVisibility"></a>DesignerSerializationVisibility</h3><p>表示，是否在*.Designer.cs文件中将设置的代码写出来，也就是是否要实现序列化。默认为<br><code>[DesignerSerializationVisibility(DesignerSerializationVisibility.Visible)]</code>表示需要实现序列化。</p><p>如果设置为hidden：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden)</span>]</span><br><span class="line"><span class="keyword">public</span> List&lt;Person&gt; Persons &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure><p>将不会被序列化</p><p>如果自定义控件中有些属性不需要显示在属性面板或者不需要序列化时，建议 hidden 掉。</p><h2 id="Region"><a href="#Region" class="headerlink" title="Region"></a>Region</h2><p>自定义控件时，使用 Region 来添加不透明区域，其他区域则是透明的</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnPaint</span>(<span class="params">PaintEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnPaint(e);</span><br><span class="line">    Region rgn = <span class="keyword">new</span> Region();</span><br><span class="line">    GraphicsPath path = <span class="keyword">new</span> GraphicsPath();</span><br><span class="line">    rgn.MakeEmpty();</span><br><span class="line">    path.AddEllipse(<span class="number">0</span>, <span class="number">0</span>, Width, Height);</span><br><span class="line">    rgn.Union(path);</span><br><span class="line">    Region = rgn;</span><br><span class="line">    path.Reset();</span><br><span class="line"></span><br><span class="line">    Graphics g = e.Graphics;</span><br><span class="line">    g.FillEllipse(Brushes.Black, <span class="number">0</span>, <span class="number">0</span>, Width, Height);</span><br><span class="line">    g.FillEllipse(<span class="keyword">new</span> SolidBrush(BackColor), <span class="number">1</span>, <span class="number">1</span>, Width - <span class="number">2</span>, Height - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    path.Dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意：在画带边框圆形时，黑边框填充区域与 Region 保持一致，背景色填充区域需往内部收缩一个像素<br>在画带边框矩形时无需填充黑边框，画的黑边框区域起始坐标相同，长与宽收缩一个像素即可</p></blockquote><h2 id="发送按键"><a href="#发送按键" class="headerlink" title="发送按键"></a>发送按键</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/system.windows.forms.sendkeys?view=netframework-4.6.1">https://learn.microsoft.com/en-us/dotnet/api/system.windows.forms.sendkeys?view=netframework-4.6.1</a></p><p>如：发送 <code>alt + tab</code></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SendKeys.Send(<span class="string">&quot;%+&#123;TAB&#125;&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="winform-窗口不显示在任务栏"><a href="#winform-窗口不显示在任务栏" class="headerlink" title="winform 窗口不显示在任务栏"></a>winform 窗口不显示在任务栏</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.ShowInTaskbar = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><h2 id="winform-窗口-alt-tab-不显示"><a href="#winform-窗口-alt-tab-不显示" class="headerlink" title="winform 窗口 alt + tab 不显示"></a>winform 窗口 alt + tab 不显示</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 让程序不显示在alt+Tab视图窗体中</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">override</span> CreateParams CreateParams</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">int</span> WS_EX_APPWINDOW = <span class="number">0x40000</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">int</span> WS_EX_TOOLWINDOW = <span class="number">0x80</span>;</span><br><span class="line">        CreateParams cp = <span class="keyword">base</span>.CreateParams;</span><br><span class="line">        cp.ExStyle &amp;= (~WS_EX_APPWINDOW);</span><br><span class="line">        cp.ExStyle |= WS_EX_TOOLWINDOW;</span><br><span class="line">        <span class="keyword">return</span> cp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="hex转double"><a href="#hex转double" class="headerlink" title="hex转double"></a>hex转double</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">double</span> <span class="title">hex2double</span>(<span class="params"><span class="built_in">string</span> hex</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">byte</span>[] t = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i; i &lt; hex.Length/<span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 小端hex</span></span><br><span class="line">        b[<span class="number">8</span>-i<span class="number">-1</span>] = Convert.ToByte(hex.Substring(i*<span class="number">2</span>,<span class="number">2</span>), <span class="number">16</span>);</span><br><span class="line">        <span class="comment">// 大端hex</span></span><br><span class="line">        <span class="comment">//b[i] = Convert.ToByte(hex.Substring(i*2,2), 16);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BitConverter.ToDouble(t, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Base64-编码与解码"><a href="#Base64-编码与解码" class="headerlink" title="Base64 编码与解码"></a>Base64 编码与解码</h2><p>编码：<br>byte[] bytes&#x3D;Encoding.Default.GetBytes(“要转换的字符串”);<br>Convert.ToBase64String(bytes);<br>解码：<br>&#x2F;&#x2F;“ztKwrsTj”是“我爱你”的base64编码<br>byte[] outputb &#x3D; Convert.FromBase64String(“ztKwrsTj”);<br>string orgStr&#x3D; Encoding.Default.GetString(outputb);</p><h2 id="Chart"><a href="#Chart" class="headerlink" title="Chart"></a>Chart</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">chart1.Series.Clear();</span><br><span class="line"></span><br><span class="line">Series Speed = <span class="keyword">new</span> Series(<span class="string">&quot;速度&quot;</span>);</span><br><span class="line"></span><br><span class="line">Speed.ChartType = SeriesChartType.Spline;</span><br><span class="line">Speed.IsValueShownAsLabel = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标题</span></span><br><span class="line"><span class="comment">// chart1.Titles.Add(&quot;主标题&quot;);</span></span><br><span class="line"><span class="comment">// chart1.Titles[0].ForeColor = Color.Blue;</span></span><br><span class="line"><span class="comment">// chart1.Titles[0].Font = new Font(&quot;宋体&quot;, 12f, FontStyle.Regular);</span></span><br><span class="line"><span class="comment">// chart1.Titles[0].Alignment = ContentAlignment.TopCenter;</span></span><br><span class="line"><span class="comment">// chart1.Titles.Add(&quot;右标题&quot;);</span></span><br><span class="line"><span class="comment">// chart1.Titles[1].ForeColor = Color.Blue;</span></span><br><span class="line"><span class="comment">// chart1.Titles[1].Font = new Font(&quot;宋体&quot;, 8f, FontStyle.Regular);</span></span><br><span class="line"><span class="comment">// chart1.Titles[1].Alignment = ContentAlignment.TopRight;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 控件背景</span></span><br><span class="line">chart1.BackColor = Color.Transparent;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图表区背景</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].BackColor = Color.LightGray;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].BorderColor = Color.LightGray;</span><br><span class="line"></span><br><span class="line"><span class="comment">// X轴网络线条</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.MajorGrid.Enabled = <span class="literal">true</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.MajorGrid.Interval = <span class="number">100</span>; <span class="comment">//网格间隔</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.MajorGrid.LineColor = Color.White; <span class="comment">// 网格颜色</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.MajorGrid.LineDashStyle = ChartDashStyle.Dash; <span class="comment">//设置网格类型为虚线</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// X轴标签间距</span></span><br><span class="line"><span class="comment">// chart1.ChartAreas[0].AxisX.Interval = 500;</span></span><br><span class="line"><span class="comment">// chart1.ChartAreas[0].AxisX.LabelStyle.IsStaggered = true;</span></span><br><span class="line"><span class="comment">// chart1.ChartAreas[0].AxisX.LabelStyle.Angle = -30;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// X坐标轴颜色</span></span><br><span class="line"><span class="comment">//chart1.ChartAreas[0].AxisX.LineColor = ColorTranslator.FromHtml(&quot;#808080&quot;);</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.LabelStyle.ForeColor = Color.Black;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.LabelStyle.Font = <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10f</span>, FontStyle.Regular);</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.IsLabelAutoFit = <span class="literal">false</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.Maximum = <span class="number">3000</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.Minimum = <span class="number">-3000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// X坐标轴标题</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.Title = <span class="string">&quot;[mm]&quot;</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.TitleFont = <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10f</span>, FontStyle.Regular);</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.TitleForeColor = Color.Black;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisX.TextOrientation = TextOrientation.Horizontal;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Y坐标轴颜色</span></span><br><span class="line"><span class="comment">//chart1.ChartAreas[0].AxisY.LineColor = ColorTranslator.FromHtml(&quot;#808080&quot;);</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.LabelStyle.ForeColor = Color.Black;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.LabelStyle.Font = <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10f</span>, FontStyle.Regular);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Y坐标轴标题</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.Title = <span class="string">&quot;[um]&quot;</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.ToolTip = <span class="string">&quot;[um]&quot;</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.TitleFont = <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">10f</span>, FontStyle.Regular);</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.TitleForeColor = Color.Black;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.TextOrientation = TextOrientation.Rotated270;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Y轴网格线条</span></span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.MajorGrid.Enabled = <span class="literal">true</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.MajorGrid.LineColor = Color.White;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.MinorGrid.Interval = <span class="number">50</span>;</span><br><span class="line">chart1.ChartAreas[<span class="number">0</span>].AxisY.MajorGrid.LineDashStyle = ChartDashStyle.Dash; <span class="comment">//网格Y轴线类型</span></span><br><span class="line"><span class="comment">//chart1.ChartAreas[0].AxisY.MajorGrid.LineColor = ColorTranslator.FromHtml(&quot;#E6E6FA&quot;);</span></span><br><span class="line"><span class="comment">//chart1.ChartAreas[0].AxisY2.LineColor = Color.Transparent;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 背景渐变</span></span><br><span class="line"><span class="comment">//chart1.ChartAreas[0].BackGradientStyle = GradientStyle.None;</span></span><br><span class="line"></span><br><span class="line">Speed.Points.DataBindXY(x, y);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把 series 添加到 chart 上</span></span><br><span class="line">chart1.Series.Add(Speed);</span><br></pre></td></tr></table></figure><h1 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h1><h2 id="定时清理索引-1"><a href="#定时清理索引-1" class="headerlink" title="定时清理索引 1"></a>定时清理索引 1</h2><p>背景：由于 ES 的日志索引每天都在增长，很快缓存就吃不消了， 需要定期清理一下过期不用的索引， 在此使用定期删除索引的方法</p><p>脚本 delete_es_indices_over_15_day.sh</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除早于15天的ES集群的索引</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">delete_indices</span></span>() &#123;</span><br><span class="line">  param=$(<span class="built_in">echo</span> <span class="variable">$1</span>)</span><br><span class="line">  <span class="comment">#截取索引的日期部分（用于下面的日期比较是否小于15日），我的索引是com-字符串后面的部分为日期， 比如: www.test.com-2020.08.08</span></span><br><span class="line">  dateValue=$(<span class="built_in">echo</span> <span class="variable">$&#123;param#*com-&#125;</span>)</span><br><span class="line">  <span class="comment">#截取日期的前部分作为索引的名称（后续需要替换-为.， 然后和日期拼接起来成为一个真正的索引名称，用于删除）</span></span><br><span class="line">  name=$(<span class="built_in">echo</span> <span class="variable">$&#123;param%-$dateValue*&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;name=<span class="variable">$name</span> date=<span class="variable">$dateValue</span>&quot;</span> </span><br><span class="line">  comp_date=`<span class="built_in">date</span> -d <span class="string">&quot;15 day ago&quot;</span> +<span class="string">&quot;%Y-%m-%d&quot;</span>`</span><br><span class="line">  date1=<span class="string">&quot;<span class="variable">$dateValue</span> 00:00:00&quot;</span></span><br><span class="line">  date2=<span class="string">&quot;<span class="variable">$comp_date</span> 00:00:00&quot;</span></span><br><span class="line"></span><br><span class="line">  t1=`<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$date1</span>&quot;</span> +%s` </span><br><span class="line">  t2=`<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$date2</span>&quot;</span> +%s`</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$t1</span> -le <span class="variable">$t2</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span>时间早于<span class="variable">$comp_date</span>，进行索引删除&quot;</span></span><br><span class="line">    <span class="comment">#转换一下格式，将类似www-test-com格式转化为www.test.com</span></span><br><span class="line">    format_name=`<span class="built_in">echo</span> <span class="variable">$name</span>| sed <span class="string">&#x27;s/-/\./g&#x27;</span>`</span><br><span class="line"></span><br><span class="line">    <span class="comment">#转换一下格式，将类似2020-10-01格式转化为2020.10.01</span></span><br><span class="line">    format_date=`<span class="built_in">echo</span> <span class="variable">$dateValue</span>| sed <span class="string">&#x27;s/-/\./g&#x27;</span>`</span><br><span class="line">    <span class="comment">#拼接成索引名称</span></span><br><span class="line">    indexName=<span class="string">&quot;<span class="variable">$format_name</span>-<span class="variable">$format_date</span>&quot;</span></span><br><span class="line">    <span class="comment">#删除索引</span></span><br><span class="line">    curl -XDELETE http://localhost:9200/<span class="variable">$indexName</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$indexName</span>删除成功&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意， 由于我的日志都是包含有&quot;com-&quot;的字符串，故使用该字符串模糊查询索引列表</span></span><br><span class="line">curl -XGET http://localhost:9200/_cat/indices | awk -F<span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>|grep com- | <span class="built_in">uniq</span> | sed <span class="string">&#x27;s/\./-/g&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> LINE</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment">#调用索引删除函数， 结果打印到日志</span></span><br><span class="line">delete_indices <span class="variable">$LINE</span> &gt;&gt; /home/logs/delete_indices.log</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>crontab 定时配置,每天1点定时删除</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /home/delete_es_indices_over_15_day.sh</span><br></pre></td></tr></table></figure><h2 id="定时清理索引-2"><a href="#定时清理索引-2" class="headerlink" title="定时清理索引 2"></a>定时清理索引 2</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################</span></span><br><span class="line"><span class="comment">#删除早于十天的ES集群的索引</span></span><br><span class="line"><span class="comment">###################################</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">delete_indices</span></span>() &#123;</span><br><span class="line">    comp_date=`<span class="built_in">date</span> -d <span class="string">&quot;10 day ago&quot;</span> +<span class="string">&quot;%Y-%m-%d&quot;</span>`</span><br><span class="line">    date1=<span class="string">&quot;<span class="variable">$1</span> 00:00:00&quot;</span></span><br><span class="line">    date2=<span class="string">&quot;<span class="variable">$comp_date</span> 00:00:00&quot;</span></span><br><span class="line"></span><br><span class="line">    t1=`<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$date1</span>&quot;</span> +%s` </span><br><span class="line">    t2=`<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$date2</span>&quot;</span> +%s` </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$t1</span> -le <span class="variable">$t2</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span>时间早于<span class="variable">$comp_date</span>，进行索引删除&quot;</span></span><br><span class="line">        <span class="comment">#转换一下格式，将类似2017-10-01格式转化为2017.10.01</span></span><br><span class="line">        format_date=`<span class="built_in">echo</span> <span class="variable">$1</span>| sed <span class="string">&#x27;s/-/\./g&#x27;</span>`</span><br><span class="line">        curl -XDELETE http://127.0.0.1:9200/*<span class="variable">$format_date</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">curl -XGET http://127.0.0.1:9200/_cat/indices | awk -F<span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | awk -F<span class="string">&quot;-&quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | egrep <span class="string">&quot;[0-9]*\.[0-9]*\.[0-9]*&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span>  | sed <span class="string">&#x27;s/\./-/g&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> LINE</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment">#调用索引删除函数</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;delete indexes...&quot;</span></span><br><span class="line">    delete_indices <span class="variable">$LINE</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;deleted success&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><br><h1 id="linux-1"><a href="#linux-1" class="headerlink" title="linux"></a>linux</h1><h2 id="字符集编码"><a href="#字符集编码" class="headerlink" title="字符集编码"></a>字符集编码</h2><p><code>locale -a</code> 查看所有字符集</p><p>然后将 LANG 环境变量设置为里面有的即可</p><p>如 LANG&#x3D;”C.UTF-8”，或在 docker-compose.yml 里：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">LANG:</span> <span class="string">C.UTF-8</span></span><br></pre></td></tr></table></figure><h2 id="参数替换-xargs"><a href="#参数替换-xargs" class="headerlink" title="参数替换 xargs"></a>参数替换 xargs</h2><p>由于很多命令不支持管道|来传递参数，xargs 用于产生某个命令的参数，xargs 可以读入 stdin 的数据，并且以空格符或回车符将 stdin 的数据分隔成为参数</p><p>另外，许多命令不能接受过多参数，命令执行可能会失败，xargs 可以解决</p><p>注意：文件名或者是其他意义的名词内含有空格符的情况</p><p>find 经常和 xargs 命令进行组合,形式如下：<code>find | xargs COMMAND</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示10个数字</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#seq 10 | xargs</span></span><br><span class="line">&gt;&gt;&gt; 1 2 3 4 5 6 7 8 9 10</span><br><span class="line"><span class="comment">#删除当前目录下的大量文件</span></span><br><span class="line"><span class="built_in">ls</span> | xargs   <span class="built_in">rm</span> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line">find  -name <span class="string">&quot;*.sh&quot;</span> | xargs <span class="built_in">ls</span> -Sl</span><br><span class="line">[root@centos8 data]<span class="comment">#echo &#123;1..10&#125; |xargs </span></span><br><span class="line">1 2 3 4 5 6 7 8 9 10</span><br><span class="line"></span><br><span class="line">[root@centos8 data]<span class="comment">#echo &#123;1..10&#125; |xargs -n1 </span></span><br><span class="line">[root@centos8 data]<span class="comment">#echo &#123;1..10&#125; |xargs -n2</span></span><br><span class="line">&gt;&gt;&gt; 1 2</span><br><span class="line">&gt;&gt;&gt; 3 4</span><br><span class="line">&gt;&gt;&gt; 5 6</span><br><span class="line">&gt;&gt;&gt; 7 8</span><br><span class="line">&gt;&gt;&gt; 9 10</span><br><span class="line"></span><br><span class="line"><span class="comment">#批量创建和删除用户</span></span><br><span class="line"><span class="built_in">echo</span> user&#123;1..10&#125; |xargs -n1 useradd </span><br><span class="line"><span class="built_in">echo</span> user&#123;1..100&#125; | xargs -n1 userdel -r</span><br><span class="line"><span class="comment">#这个命令是错误的</span></span><br><span class="line">find /sbin/ -perm /700 | <span class="built_in">ls</span> -l       </span><br><span class="line"><span class="comment">#查找有特殊权限的文件，并排序</span></span><br><span class="line">find /bin/ -perm /7000 | xargs <span class="built_in">ls</span> -Sl  </span><br><span class="line"><span class="comment">#此命令和上面有何区别？</span></span><br><span class="line">find /bin/ -perm -7000 | xargs <span class="built_in">ls</span> -Sl  </span><br><span class="line"><span class="comment">#以字符nul分隔</span></span><br><span class="line">find -<span class="built_in">type</span> f -name <span class="string">&quot;*.txt&quot;</span> -print0 | xargs -0 <span class="built_in">rm</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#并发执行多个进程</span></span><br><span class="line"><span class="built_in">seq</span> 100 |xargs -i -P10 wget -P /data   http://10.0.0.8/&#123;&#125;.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#并行下载bilibili视频</span></span><br><span class="line">yum install python3-pip -y</span><br><span class="line">pip3 install you-get</span><br><span class="line"><span class="built_in">seq</span> 10 | xargs -i -P3 you-get https://www.bilibili.com/video/BV1HZ4y1p7Bf?p=&#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="创建目录并进入"><a href="#创建目录并进入" class="headerlink" title="创建目录并进入"></a>创建目录并进入</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> cmake-test &amp;&amp; <span class="built_in">cd</span> <span class="variable">$_</span></span><br></pre></td></tr></table></figure><h2 id="PROMPT-COMMAND"><a href="#PROMPT-COMMAND" class="headerlink" title="PROMPT_COMMAND"></a>PROMPT_COMMAND</h2><p>PROMPT_COMMAND 为环境变量，如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROMPT_COMMAND=<span class="string">&#x27;ls; &#x27;</span></span><br></pre></td></tr></table></figure><p>此时在 bash 中每次执行命令后都会执行 <code>ls</code></p><h2 id="u盘"><a href="#u盘" class="headerlink" title="u盘"></a>u盘</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">modprobe usb-storage</span><br><span class="line">lsblk</span><br><span class="line">mount /mnt/usb /dev/sdb1</span><br></pre></td></tr></table></figure><h2 id="rhel"><a href="#rhel" class="headerlink" title="rhel"></a>rhel</h2><p>原因：redhat自带的插件subscription-manager。这个插件的作用就是Red Hat Subscription Manager订阅管理器，就是它让你一直register</p><p>解决办法：将配置文件subscription-manager.conf中的enable注释掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# vi /etc/yum/pluginconf.d/subscription-manager.conf</span><br><span class="line"></span><br><span class="line">[main]</span><br><span class="line">#enabled=1</span><br></pre></td></tr></table></figure><h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">command: command [-pVv] command [arg ...]</span><br><span class="line">    Execute a simple command or display information about commands.</span><br><span class="line"></span><br><span class="line">    Runs COMMAND with ARGS suppressing  shell function lookup, or display</span><br><span class="line">    information about the specified COMMANDs.  Can be used to invoke commands</span><br><span class="line">    on disk when a function with the same name exists.</span><br><span class="line"></span><br><span class="line">    Options:</span><br><span class="line">      -p    use a default value for PATH that is guaranteed to find all of</span><br><span class="line">            the standard utilities</span><br><span class="line">      -v    print a description of COMMAND similar to the `type&#x27; builtin</span><br><span class="line">      -V    print a more verbose description of each COMMAND</span><br><span class="line"></span><br><span class="line">    Exit Status:</span><br><span class="line">    Returns exit status of COMMAND, or failure if COMMAND is not found.</span><br></pre></td></tr></table></figure><h2 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h2><p><code>java -jar app.jar &amp;&gt; /dev/null &amp;</code></p><h2 id="shell-嵌入-python"><a href="#shell-嵌入-python" class="headerlink" title="shell 嵌入 python"></a>shell 嵌入 python</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python3 - <span class="string">&quot;<span class="variable">$@</span>&quot;</span> &lt;&lt;<span class="string">END</span></span><br><span class="line"><span class="string">#!/usr/bin/python3</span></span><br><span class="line"><span class="string">import sys</span></span><br><span class="line"><span class="string">if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="string">    print(len(sys.argv[1].split(&quot;,&quot;)))</span></span><br><span class="line"><span class="string">END</span></span><br></pre></td></tr></table></figure><h2 id="find-命令"><a href="#find-命令" class="headerlink" title="find 命令"></a>find 命令</h2><p>查找当前目录下的以 .log 结尾的文件或目录，并移动到 test 目录下（<strong>注意应先有 test 目录</strong>）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -name <span class="string">&quot;*.log&quot;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; <span class="built_in">test</span> \;</span><br></pre></td></tr></table></figure><p>递归修改目录权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -type d -exec chmod 755 &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>递归修改文件权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -type f -exec chmod 644 &#123;&#125; \;</span><br></pre></td></tr></table></figure><h2 id="目录相关命令"><a href="#目录相关命令" class="headerlink" title="目录相关命令"></a>目录相关命令</h2><ul><li><code>dirname</code>：显示某个文件或目录的上级所有目录</li><li><code>basename</code>：显示某个文件或目录的名称</li></ul><h2 id="安装-Docker-CE"><a href="#安装-Docker-CE" class="headerlink" title="安装 Docker CE"></a>安装 Docker CE</h2><p>官网：<a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p><p>授于当前用户以 root 权限运行Docker CLI<br><code>sudo usermod -aG docker $USER</code></p><h2 id="挂载相关"><a href="#挂载相关" class="headerlink" title="挂载相关"></a>挂载相关</h2><p>单次挂载：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o loop /data/ISO/CentOS-8.5.2111-x86_64-dvd1.iso /mnt/cdrom</span><br></pre></td></tr></table></figure><p>开机自动挂载：<br>fstab</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/ISO/CentOS-8.5.2111-x86_64-dvd1.iso /mnt/cdrom iso9660 defaults,ro,loop 0</span><br></pre></td></tr></table></figure><h2 id="autofs"><a href="#autofs" class="headerlink" title="autofs"></a>autofs</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#rpm -q autofs || yum -y install autofs</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl enable --now autofs</span></span><br><span class="line"><span class="comment">#Ubuntu</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># apt install autofs -y</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># vim /etc/auto.master</span></span><br><span class="line">/misc   /etc/auto.misc</span><br><span class="line">root@ubuntu2004:~<span class="comment"># systemctl restart autofs</span></span><br></pre></td></tr></table></figure><p>开启 autofs 后，光盘会自动挂载到 &#x2F;misc 目录下</p><h1 id="vue"><a href="#vue" class="headerlink" title="vue"></a>vue</h1><h2 id="节流与防抖"><a href="#节流与防抖" class="headerlink" title="节流与防抖"></a>节流与防抖</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; throttle, debounce &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttledFn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 处理函数逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> throttled = <span class="title function_">throttle</span>(throttledFn, <span class="number">1000</span>); <span class="comment">// 控制1秒内只能执行一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 防抖函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debouncedFn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 处理函数逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> debounced = <span class="title function_">debounce</span>(debouncedFn, <span class="number">1000</span>); <span class="comment">// 只有在1秒内没有再次触发时才会执行</span></span><br></pre></td></tr></table></figure><h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><h2 id="Pip"><a href="#Pip" class="headerlink" title="Pip"></a>Pip</h2><p>如果出现 pip 无法使用的情况，执行如下命令重装 pip：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install -U pip</span><br></pre></td></tr></table></figure><h2 id="oracle"><a href="#oracle" class="headerlink" title="oracle"></a>oracle</h2><p>pip install cx_Oracle</p><p><a target="_blank" rel="noopener" href="https://www.oracle.com/database/technologies/instant-client/downloads.html">https://www.oracle.com/database/technologies/instant-client/downloads.html</a></p><h1 id="记录一些有趣的特殊字符"><a href="#记录一些有趣的特殊字符" class="headerlink" title="记录一些有趣的特殊字符"></a>记录一些有趣的特殊字符</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌─┬─┐</span><br><span class="line">├─┼─┤</span><br><span class="line">└─┴─┘</span><br></pre></td></tr></table></figure><h1 id="temp"><a href="#temp" class="headerlink" title="temp"></a>temp</h1><p><a target="_blank" rel="noopener" href="http://ip:20030/x_program_center/jest/list.html">http://ip:20030/x_program_center/jest/list.html</a></p><p><a target="_blank" rel="noopener" href="http://ip:20020/x_organization_assemble_authentication/jaxrs/authentication">http://ip:20020/x_organization_assemble_authentication/jaxrs/authentication</a></p><p>OA OAuth2<br><a target="_blank" rel="noopener" href="http://localhost:8090/x_desktop/oauth2.html?redirect_uri=$%7Bredirect_uri%7D&amp;response_type=code&amp;client_id=$%7Bclient_id%7D">http://localhost:8090/x_desktop/oauth2.html?redirect_uri=${redirect_uri}&amp;response_type=code&amp;client_id=${client_id}</a></p><p><a target="_blank" rel="noopener" href="http://localhost:20020/x_organization_assemble_authentication/jaxrs/oauth/token">http://localhost:20020/x_organization_assemble_authentication/jaxrs/oauth/token</a></p><p>SSO 客户端<br><a target="_blank" rel="noopener" href="http://127.0.0.1:8090/x_desktop/sso.html?client=Jira&amp;xtoken=AUWZHInN6nlfYypSxtmVsduQJYPaBA5Ep3PR350NiF4&amp;redirect=$%7Bredirect%7D">http://127.0.0.1:8090/x_desktop/sso.html?client=Jira&amp;xtoken=AUWZHInN6nlfYypSxtmVsduQJYPaBA5Ep3PR350NiF4&amp;redirect=${redirect}</a></p><p>OA SSO POST<br><a target="_blank" rel="noopener" href="http://localhost:20020/x_organization_assemble_authentication/jaxrs/sso">http://localhost:20020/x_organization_assemble_authentication/jaxrs/sso</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST BODY(JSON)</span><br><span class="line">&#123;</span><br><span class="line">    &quot;client&quot;:&quot;OA 配置名称&quot;,</span><br><span class="line">    &quot;token&quot;:&quot;生成的 TOKEN&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GET<br><a target="_blank" rel="noopener" href="http://localhost:20020/x_organization_assemble_authentication/jaxrs/sso/client/%7Bclient%7D/token/%7Btoken%7D">http://localhost:20020/x_organization_assemble_authentication/jaxrs/sso/client/{client}/token/{token}</a></p><h1 id="软件破解"><a href="#软件破解" class="headerlink" title="软件破解"></a>软件破解</h1><h2 id="StarUML5"><a href="#StarUML5" class="headerlink" title="StarUML5"></a>StarUML5</h2><p>安装编译工具【asar】：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g asar</span><br></pre></td></tr></table></figure><p>反编译，<code>C:\Program Files\StarUML\resources</code> 目录下找到 app.asar，将其复制出来，执行如下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar extract app.asar app</span><br></pre></td></tr></table></figure><p>然后打开 <code>app\src\engine\license-manager.js</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改验证许可的方法，使其验证成功，不提示</span></span><br><span class="line">checkLicenseValidity () &#123;</span><br><span class="line">  <span class="keyword">if</span> (packageJSON.<span class="property">config</span>.<span class="property">setappBuild</span>) &#123;</span><br><span class="line">    <span class="title function_">setStatus</span>(<span class="variable language_">this</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">validate</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setStatus</span>(<span class="variable language_">this</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setStatus</span>(<span class="variable language_">this</span>,<span class="literal">true</span>)               <span class="comment">// 原本是false,改成true</span></span><br><span class="line">      <span class="comment">// UnregisteredDialog.showDialog() // 注释掉</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>禁用版本自动更新：<br>修改 <code>app/src/app-context.js</code> 中的 appReady 方法，注释部分代码。代码在713行。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">setappBuild</span>) &#123;</span><br><span class="line">    <span class="comment">/* 禁用自动更新，注释掉此处if语句块</span></span><br><span class="line"><span class="comment">        if (this.preferences.get(&#x27;checkUpdate.checkUpdateOnStart&#x27;)) &#123;</span></span><br><span class="line"><span class="comment">        ipcRenderer.send(&#x27;check-update&#x27;)</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改了源码，需要重新打包源码。生效修改的部分。运行以下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asar pack app app.asar</span><br></pre></td></tr></table></figure><p>重新打开 StarUML，【不提示需要注册和没有 Unregistered 标识】则表示破解成功。</p><h2 id="jira"><a href="#jira" class="headerlink" title="jira"></a>jira</h2><p>jira 破解：<code>java -jar atlassian-agent.jar -p jira -m aaa@bbb.com -n my_name -o JRPJZ -s ABCD-1234-EFGH-5678</code></p><h2 id="confluence"><a href="#confluence" class="headerlink" title="confluence"></a>confluence</h2><p>confluence 破解：<code>java -jar atlassian-agent.jar -p conf -m aaa@bbb.com -n my_name -o JRPJZ -s ABCD-1234-EFGH-5678</code></p><h1 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h1><h3 id="vimrc1"><a href="#vimrc1" class="headerlink" title="vimrc1"></a>vimrc1</h3><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 功能函数<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 获取当前目录<br>func GetPWD()<br>return substitute(getcwd(), “”, “”, “g”)<br>endf</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 多语言环境<br>“ 默认为 UTF-8 编码<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>if has(“multi_byte”)<br>set encoding&#x3D;utf-8<br>“ English messages only<br>“language messages zh_CN.utf-8</p><pre><code>if has(&#39;win32&#39;)
    language english
    let &amp;termencoding=&amp;encoding
endif

set fencs=utf-8,gbk,chinese,latin1
set formatoptions+=mM
set nobomb &quot; 不使用 Unicode 签名

if v:lang =~? &#39;^\(zh\)\|\(ja\)\|\(ko\)&#39;
    set ambiwidth=double
endif
</code></pre><p>else<br>echoerr “Sorry, this version of (g)vim was not compiled with +multi_byte”<br>endif</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 环境配置<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><p>“ 保留历史记录<br>set history&#x3D;400</p><p>“ 命令行于状态行<br>set ch&#x3D;1<br>set stl&#x3D;\ [File]\ %F%m%r%h%y[%{&amp;fileformat},%{&amp;fileencoding}]\ %w\ \ [PWD]\ %r%{GetPWD()}%h\ %&#x3D;\ [Line]\ %l,%c\ %&#x3D;\ %P<br>set ls&#x3D;2 “ 始终显示状态行</p><p>“ 行控制<br>set linebreak<br>set nocompatible<br>set textwidth&#x3D;80<br>set wrap</p><p>“ 控制台响铃<br>:set noerrorbells<br>:set novisualbell<br>:set t_vb&#x3D; “close visual bell</p><p>“ 插入模式下使用<bs>、<del><c-w><c-u><br>set backspace&#x3D;indent,eol,start</c-u></c-w></del></bs></p><p>“ 自动重新读入<br>set autoread</p><p>“代码折叠<br>“设置折叠模式<br>set foldcolumn&#x3D;4<br>“光标遇到折叠，折叠就打开<br>“set foldopen&#x3D;all<br>“移开折叠时自动关闭折叠<br>“set foldclose&#x3D;all<br>“zf zo zc zd zr zm zR zM zn zi zN<br>“依缩进折叠<br>“ manual 手工定义折叠<br>“ indent 更多的缩进表示更高级别的折叠<br>“ expr 用表达式来定义折叠<br>“ syntax 用语法高亮来定义折叠<br>“ diff 对没有更改的文本进行折叠<br>“ marker 对文中的标志折叠<br>set foldmethod&#x3D;syntax<br>“启动时不要自动折叠代码<br>set foldlevel&#x3D;100<br>“依标记折叠<br>set foldmethod&#x3D;marker</p><p>“语法高亮<br>syntax enable<br>syntax on</p><p>“设置配色<br>set guifont&#x3D;Courier\ New:h12<br>colorscheme desert</p><p>“设定文件浏览器目录为当前目录<br>set bsdir&#x3D;buffer</p><p>“ 自动切换到文件当前目录<br>set autochdir</p><p>“显示匹配的括号<br>set showmatch</p><p>“增强模式中的命令行自动完成操作<br>set wildmenu</p><p>“使PHP识别EOT字符串<br>hi link phpheredoc string<br>“php语法折叠<br>let php_folding &#x3D; 1<br>“允许在有未保存的修改时切换缓冲区<br>set hidden</p><p>“实现全能补全功能，需要打开文件类型检测<br>“filetype plugin indent on<br>“打开vim的文件类型自动检测功能<br>“filetype on</p><p>“保存文件的格式顺序<br>set fileformats&#x3D;dos,unix<br>“置粘贴模式，这样粘贴过来的程序代码就不会错位了。<br>set paste</p><p>“在所有模式下都允许使用鼠标，还可以是n,v,i,c等<br>set mouse&#x3D;a</p><p>“ 恢复上次文件打开位置<br>set viminfo&#x3D;’10,&quot;100,:20,%,n~&#x2F;.viminfo<br>au BufReadPost * if line(“‘&quot;“) &gt; 0|if line(“‘&quot;“) &lt;&#x3D; line(“$”)|exe(“norm ‘&quot;“)|else|exe “norm $”|endif|endif</p><p>“取得光标处的匹配<br>function! GetPatternAtCursor(pat)<br>let col &#x3D; col(‘.’) - 1<br>let line &#x3D; getline(‘.’)<br>let ebeg &#x3D; -1<br>let cont &#x3D; match(line, a:pat, 0)<br>while (ebeg &gt;&#x3D; 0 || (0 &lt;&#x3D; cont) &amp;&amp; (cont &lt;&#x3D; col))<br>let contn &#x3D; matchend(line, a:pat, cont)<br>if (cont &lt;&#x3D; col) &amp;&amp; (col &lt; contn)<br>let ebeg &#x3D; match(line, a:pat, cont)<br>let elen &#x3D; contn - ebeg<br>break<br>else<br>let cont &#x3D; match(line, a:pat, contn)<br>endif<br>endwh<br>if ebeg &gt;&#x3D; 0<br>return strpart(line, ebeg, elen)<br>else<br>return “”<br>endif<br>endfunction</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 图形界面<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>if has(‘gui_running’)<br>“ 只显示菜单<br>set guioptions&#x3D;mcr</p><pre><code>&quot; 高亮光标所在的行
set cursorline

&quot; 编辑器配色
colorscheme desert
&quot;colorscheme zenburn
&quot;colorscheme dusk

if has(&quot;win32&quot;)
    &quot; Windows 兼容配置
    source $VIMRUNTIME/vimrc_example.vim
    source $VIMRUNTIME/mswin.vim

    &quot;设置鼠标运行模式为WINDOWS模式
    behave mswin

    &quot; f11 最大化
    map &lt;f11&gt; :call libcallnr(&#39;fullscreen.dll&#39;, &#39;ToggleFullScreen&#39;, 0)&lt;cr&gt;

    &quot; 字体配置
    exec &#39;set guifont=&#39;.iconv(&#39;Courier_New&#39;, &amp;enc, &#39;gbk&#39;).&#39;:h12:cANSI&#39;
    &quot;exec &#39;set guifontwide=&#39;.iconv(&#39;微软雅黑&#39;, &amp;enc, &#39;gbk&#39;).&#39;:h12&#39;
endif

if has(&quot;unix&quot;) &amp;&amp; !has(&#39;gui_macvim&#39;)
    set guifont=Courier\ 10\ Pitch\ 11
    set guifontwide=YaHei\ Consolas\ Hybrid\ 11
endif

if has(&quot;mac&quot;) || has(&quot;gui_macvim&quot;)
    set guifont=Courier\ New:h16.00
    &quot;set guifontwide=YaHei\ Consolas\ Hybrid:h16.00
    &quot;set guifont=Monaco:h16
    &quot;set guifont=Droid\ Sans\ Mono:h14
    set guifontwide=YouYuan:h14
    if has(&quot;gui_macvim&quot;)
        &quot;set transparency=4
        set lines=200 columns=142

        let s:lines=&amp;lines
        let s:columns=&amp;columns
        func! FullScreenEnter()
            set lines=999 columns=999
            set fu
        endf

        func! FullScreenLeave()
            let &amp;lines=s:lines
            let &amp;columns=s:columns
            set nofu
        endf

        func! FullScreenToggle()
            if &amp;fullscreen
                call FullScreenLeave()
            else
                call FullScreenEnter()
            endif
        endf
    endif
endif
</code></pre><p>endif</p><p>“ Under the Mac(MacVim)<br>if has(“gui_macvim”)</p><pre><code>&quot; Mac 下，按 \ff 切换全屏
map &lt;Leader&gt;&lt;Leader&gt;  :call FullScreenToggle()&lt;cr&gt;

&quot; Set input method off
set imdisable

&quot; Set QuickTemplatePath
let g:QuickTemplatePath = $HOME.&#39;/.vim/templates/&#39;

lcd ~/Desktop/

&quot; 自动切换到文件当前目录
set autochdir

&quot; Set QuickTemplatePath
let g:QuickTemplatePath = $HOME.&#39;/.vim/templates/&#39;
</code></pre><p>endif</p><p>“设置VIM状态栏<br>set laststatus&#x3D;2 “显示状态栏(默认值为1, 无法显示状态栏)<br>set statusline&#x3D; “[%F]%y%r%m%<em>%&#x3D;[Line:%l&#x2F;%L,Column:%c][%p%%]<br>set statusline+&#x3D;%2</em>%-3.3n%0<em>\ “ buffer number<br>set statusline+&#x3D;%f\ “ file name<br>set statusline+&#x3D;%h%1</em>%m%r%w%0* “ flag<br>set statusline+&#x3D;[<br>if v:version &gt;&#x3D; 600<br>set statusline+&#x3D;%{strlen(&amp;ft)?&amp;ft:’none’}, “ filetype<br>set statusline+&#x3D;%{&amp;fileencoding}, “ encoding<br>endif<br>set statusline+&#x3D;%{&amp;fileformat}] “ file format<br>set statusline+&#x3D;%&#x3D; “ right align<br>“set statusline+&#x3D;%2*0x%-8B\ “ current char<br>set statusline+&#x3D;0x%-8B\ “ current char<br>set statusline+&#x3D;%-14.(%l,%c%V%)\ %&lt;%P “ offset<br>if filereadable(expand(“~&#x2F;vimfiles&#x2F;plugin&#x2F;vimbuddy.vim”))<br>set statusline+&#x3D;\ %{VimBuddy()} “ vim buddy<br>endif</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 插件<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>filetype plugin indent on</p><p>“html自动输入匹配标签，输入&gt;之后自动完成匹配标签<br>au FileType xhtml,xml so ~&#x2F;.vim&#x2F;plugin&#x2F;html_autoclosetag.vim</p><p>“Auto completion using the TAB key “ 自动补全括号，引号<br>“This function determines, wether we are on<br>“the start of the line text(then tab indents)<br>“or if we want to try auto completion<br>function! InsertTabWrapper()<br>let col&#x3D;col(‘.’)-1<br>if !col || getline(‘.’)[col-1] !~ ‘\k’<br>return “&lt;TAB&gt;”<br>else<br>return “&lt;C-N&gt;”<br>endif<br>endfunction</p><p>“Remap the tab key to select action with InsertTabWrapper<br>inoremap<tab><c-r>&#x3D;InsertTabWrapper()<cr></cr></c-r></tab></p><p>:inoremap ( ()<esc>i<br>:inoremap )<c-r>&#x3D;ClosePair(‘)’)<cr><br>:inoremap { {}<esc>i<br>:inoremap }<c-r>&#x3D;ClosePair(‘}’)<cr><br>:inoremap [ []<esc>i<br>:inoremap ]<c-r>&#x3D;ClosePair(‘]’)<cr><br>:inoremap &lt; &lt;&gt;<esc>i<br>:inoremap &gt;<c-r>&#x3D;ClosePair(‘&gt;’)<cr><br>:inoremap “ “”<esc>i<br>:inoremap ‘ ‘’<esc>i<br>function! ClosePair(char)<br>if getline(‘.’)[col(‘.’) - 1] &#x3D;&#x3D; a:char<br>return “&lt;Right&gt;”<br>else<br>return a:char<br>endif<br>endf<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ AutoCmd<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>if has(“autocmd”)<br>filetype plugin indent on</esc></esc></cr></c-r></esc></cr></c-r></esc></cr></c-r></esc></cr></c-r></esc></p><pre><code>&quot; 括号自动补全
func! AutoClose()
    :inoremap ( ()&lt;ESC&gt;i
    &quot;:inoremap &quot; &quot;&quot;&lt;ESC&gt;i
    &quot;:inoremap &#39; &#39;&#39;&lt;ESC&gt;i
    :inoremap &#123; &#123;&#125;&lt;ESC&gt;i
    :inoremap [ []&lt;ESC&gt;i
    :inoremap ) &lt;c-r&gt;=ClosePair(&#39;)&#39;)&lt;CR&gt;
    :inoremap &#125; &lt;c-r&gt;=ClosePair(&#39;&#125;&#39;)&lt;CR&gt;
    :inoremap ] &lt;c-r&gt;=ClosePair(&#39;]&#39;)&lt;CR&gt;
endf

func! ClosePair(char)
    if getline(&#39;.&#39;)[col(&#39;.&#39;) - 1] == a:char
        return &quot;\&lt;Right&gt;&quot;
    else
        return a:char
    endif
endf

augroup vimrcEx
    au!
    autocmd FileType text setlocal textwidth=80
    autocmd BufReadPost *
                \ if line(&quot;&#39;\&quot;&quot;) &gt; 0 &amp;&amp; line(&quot;&#39;\&quot;&quot;) &lt;= line(&quot;$&quot;) |
                \   exe &quot;normal g`\&quot;&quot; |
                \ endif
augroup END

&quot;auto close quotation marks for PHP, Javascript, etc, file
au FileType php,c,python,javascript exe AutoClose()

&quot; Auto Check Syntax
au BufWritePost,FileWritePost *.js,*.php call CheckSyntax(1)

&quot; JavaScript 语法高亮
au FileType html,javascript let g:javascript_enable_domhtmlcss = 1

&quot; 给 Javascript 文件添加 Dict
if has(&#39;gui_macvim&#39;) || has(&#39;unix&#39;)
    au FileType javascript setlocal dict+=~/.vim/dict/javascript.dict
else 
    au FileType javascript setlocal dict+=$VIM/vimfiles/dict/javascript.dict
endif

&quot; 格式化 JavaScript 文件
&quot;au FileType javascript map &lt;f12&gt; :call g:Jsbeautify()&lt;cr&gt;
au FileType javascript set omnifunc=javascriptcomplete#CompleteJS

&quot; 给 CSS 文件添加 Dict
if has(&#39;gui_macvim&#39;) || has(&#39;unix&#39;)
    au FileType css setlocal dict+=~/.vim/dict/css.dict
else
    au FileType css setlocal dict+=$VIM/vimfiles/dict/css.dict
endif

&quot; 增加 ActionScript 语法支持
au BufNewFile,BufRead *.as setf actionscript 

&quot; 自动最大化窗口
if has(&#39;gui_running&#39;)
    if has(&quot;win32&quot;)
        au GUIEnter * simalt ~x
    &quot;elseif has(&quot;unix&quot;)
        &quot;au GUIEnter * winpos 0 0
        &quot;set lines=999 columns=999
    endif
endif
</code></pre><p>endif</p><p>let g:SuperTabDefaultCompletionType &#x3D; ‘<c-x><c-u>‘<br>let g:SuperTabDefaultCompletionType &#x3D; “context”<br>let g:SuperTabRetainCompletionType&#x3D;2<br>“ Disable AutoComplPop.<br>let g:acp_enableAtStartup &#x3D; 0</c-u></c-x></p><p>“ Use neocomplcache.<br>let g:neocomplcache_enable_at_startup &#x3D; 1<br>“ Use smartcase.<br>let g:neocomplcache_enable_smart_case &#x3D; 1<br>“ Use camel case completion.<br>let g:neocomplcache_enable_camel_case_completion &#x3D; 1<br>“ Use underbar completion.<br>let g:neocomplcache_enable_underbar_completion &#x3D; 1<br>“ Set minimum syntax keyword length.<br>let g:neocomplcache_min_syntax_length &#x3D; 3<br>let g:neocomplcache_lock_buffer_name_pattern &#x3D; ‘*ku*‘</p><p>“ Define dictionary.<br>let g:neocomplcache_dictionary_filetype_lists &#x3D; {<br>\ ‘default’ : ‘’,<br>\ ‘css’ : ‘<del>&#x2F;.vim&#x2F;dist&#x2F;css.dic’,<br>\ ‘php’ : ‘</del>&#x2F;.vim&#x2F;dict&#x2F;php.dic’,<br>\ ‘javascript’ : ‘<del>&#x2F;.vim&#x2F;dict&#x2F;javascript.dic’,<br>\ ‘vimshell’ : $HOME.’&#x2F;.vimshell_hist’,<br>\ ‘scheme’ : $HOME.’&#x2F;.gosh_completions’<br>\ }<br>let g:neocomplcache_snippets_dir&#x3D;”</del>&#x2F;.vim&#x2F;snippets”<br>inoremap<expr><tab>pumvisible() ? “&lt;C-n&gt;” : “&lt;TAB&gt;”<br>inoremap<expr><s-tab>pumvisible() ? “&lt;C-p&gt;” : “&lt;TAB&gt;”</s-tab></expr></tab></expr></p><p>“ Define keyword.<br>if !exists(‘g:neocomplcache_keyword_patterns’)<br>let g:neocomplcache_keyword_patterns &#x3D; {}<br>endif<br>let g:neocomplcache_keyword_patterns[‘default’] &#x3D; ‘\h\w*’</p><p>“ Plugin key-mappings.<br>imap<c-k><plug>(neocomplcache_snippets_expand)<br>smap<c-k><plug>(neocomplcache_snippets_expand)<br>inoremap<expr><c-g>neocomplcache#undo_completion()<br>inoremap<expr><c-l>neocomplcache#complete_common_string()</c-l></expr></c-g></expr></plug></c-k></plug></c-k></p><p>“ Recommended key-mappings.<br>“<cr>: close popup and save indent.<br>inoremap<expr><cr>neocomplcache#smart_close_popup() . “&lt;CR&gt;”<br>“<tab>: completion.<br>inoremap<expr><tab>pumvisible() ? “&lt;C-n&gt;” : “&lt;TAB&gt;”<br>“<c-h>,<bs>: close popup and delete backword char.<br>inoremap<expr><c-h>neocomplcache#smart_close_popup().”&lt;C-h&gt;”<br>inoremap<expr><bs>neocomplcache#smart_close_popup().”&lt;C-h&gt;”<br>inoremap<expr><c-y>neocomplcache#close_popup()<br>inoremap<expr><c-e>neocomplcache#cancel_popup()</c-e></expr></c-y></expr></bs></expr></c-h></expr></bs></c-h></tab></expr></tab></cr></expr></cr></p><p>“ AutoComplPop like behavior.<br>“let g:neocomplcache_enable_auto_select &#x3D; 1</p><p>“ Shell like behavior(not recommended).<br>“set completeopt+&#x3D;longest<br>let g:neocomplcache_enable_auto_select &#x3D; 1<br>let g:neocomplcache_disable_auto_complete &#x3D; 1<br>inoremap<expr><tab>pumvisible() ? “&lt;Down&gt;” : “&lt;TAB&gt;”<br>inoremap<expr><cr>neocomplcache#smart_close_popup() . “&lt;CR&gt;”</cr></expr></tab></expr></p><p>“ Enable omni completion.<br>autocmd FileType css setlocal omnifunc&#x3D;csscomplete#CompleteCSS<br>autocmd FileType html,markdown setlocal omnifunc&#x3D;htmlcomplete#CompleteTags<br>autocmd FileType javascript setlocal omnifunc&#x3D;javascriptcomplete#CompleteJS<br>autocmd FileType python setlocal omnifunc&#x3D;pythoncomplete#Complete<br>autocmd FileType xml setlocal omnifunc&#x3D;xmlcomplete#CompleteTags</p><p>“ Enable heavy omni completion.<br>if !exists(‘g:neocomplcache_omni_patterns’)<br>let g:neocomplcache_omni_patterns &#x3D; {}<br>endif<br>let g:neocomplcache_omni_patterns.ruby &#x3D; ‘[^. <em>\t].\w</em>|\h\w*::’<br>“autocmd FileType ruby setlocal omnifunc&#x3D;rubycomplete#Complete<br>let g:neocomplcache_omni_patterns.php &#x3D; ‘[^. \t]-&gt;\h\w<em>|\h\w</em>::’<br>let g:neocomplcache_omni_patterns.c &#x3D; ‘%(.|-&gt;)\h\w*’<br>let g:neocomplcache_omni_patterns.cpp &#x3D; ‘\h\w<em>%(.|-&gt;)\h\w</em>|\h\w*::’</p><p>“”””””””””””””””””””””””””””””<br>“ Tag list (ctags)<br>“”””””””””””””””””””””””””””””<br>if has(“win32”) “设定windows系统中ctags程序的位置<br>let Tlist_Ctags_Cmd &#x3D; ‘ctags’<br>elseif has(“linux”) “设定linux系统中ctags程序的位置<br>let Tlist_Ctags_Cmd &#x3D; ‘&#x2F;usr&#x2F;bin&#x2F;ctags’<br>endif<br>let Tlist_Show_One_File &#x3D; 1 “不同时显示多个文件的tag，只显示当前文件的<br>let Tlist_Exit_OnlyWindow &#x3D; 1 “如果taglist窗口是最后一个窗口，则退出vim<br>let Tlist_Use_Right_Window &#x3D; 1 “在右侧窗口中显示taglist窗口</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ 快捷键<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>map cal :Calendar<cr><br>map cse :ColorSchemeExplorer<br>“&#x3D;&#x3D;&#x3D;&#x3D; F3 NERDTree 切换 &#x3D;&#x3D;&#x3D;&#x3D;<br>let NERDTreeWinSize&#x3D;22<br>“map ntree :NERDTree<cr><br>“map nk :NERDTreeClose<cr><br>“map<leader>n :NERDTreeToggle<cr><br>map<f3>:NERDTreeToggle<cr><br>imap<f3><esc>:NERDTreeToggle<cr><br>“&#x3D;&#x3D;&#x3D;&#x3D; F4 Tag list 切换 &#x3D;&#x3D;&#x3D;&#x3D;<br>map<silent><f4>:TlistToggle<cr></cr></f4></silent></cr></esc></f3></cr></f3></cr></leader></cr></cr></cr></p><p>“ 标签相关的快捷键 Ctrl<br>map tn :tabnext<cr><br>map tp :tabprevious<cr><br>map tc :tabclose<cr><br>map<c-t>:tabnew<cr><br>map<c-p>:tabprevious<cr><br>map<c-n>:tabnext<cr><br>map<c-k>:tabclose<cr><br>map<c-tab>:tabnext<cr></cr></c-tab></cr></c-k></cr></c-n></cr></c-p></cr></c-t></cr></cr></cr></p><p>“ 新建 XHTML 、PHP、Javascript 文件的快捷键<br>nmap<c-c><c-h>:NewQuickTemplateTab xhtml<cr><br>nmap<c-c><c-p>:NewQuickTemplateTab php<cr><br>nmap<c-c><c-j>:NewQuickTemplateTab javascript<cr><br>nmap<c-c><c-c>:NewQuickTemplateTab css<cr></cr></c-c></c-c></cr></c-j></c-c></cr></c-p></c-c></cr></c-h></c-c></p><p>“ 在文件名上按gf时，在新的tab中打开<br>map gf :tabnew<cfile><cr></cr></cfile></p><p>“jquery 配色<br>au BufRead,BufNewFile *.js set syntax&#x3D;jquery</p><p>“ jsLint for Vim<br>let g:jslint_highlight_color &#x3D; ‘#996600’<br>“ 指定 jsLint 调用路径，通常不用更改<br>let g:jslint_command &#x3D; $HOME . ‘/.vim/jsl/jsl’<br>“ 指定 jsLint 的启动参数，可以指定相应的配置文件<br>let g:jslint_command_options &#x3D; ‘-nofilelisting -nocontext -nosummary -nologo -process’</p><p>“缺省不产生备份文件<br>set nobackup<br>set nowritebackup</p><p>“ autoload _vimrc<br>autocmd! bufwritepost _vimrc source %</p><p>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“ plugin list<br>“ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br>“Color Scheme Explorer<br>“jsbeauty \ff<br>“NERDTree<br>“Calendar<br>“conquer_term<br>“nerd_commenter</p><p>“&#x2F;*&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<em><br>“ 常用指令收集<br>“*&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</em>&#x2F;<br>“ 系统时间<br>“ :map<f7>a<c-r>&#x3D;strftime(“%c”)<cr><esc><br>“ :s&#x2F;<strong>date</strong>&#x2F;=strftime(“%c”)&#x2F;</esc></cr></c-r></f7></p><p>“&#x2F;*—————————————<em><br>“ 基础命令<br>“&#x2F;</em>—————————————*<br>“ ctrl+q 可以联合复制，粘贴，替换用 行操作<br>“ ctrl+w+j ctrl+w+k (:bn :bp :bd)</p><p>“ ‘. 它移动光标到上一次的修改行<br>“ &#96;. 它移动光标到上一次的修改点<br>“ . 重复上次命令<br>“<c-o>: 依次沿着你的跳转记录向回跳 (从最近的一次开始)<br>“<c-i>: 依次沿着你的跳转记录向前跳<br>“ ju(mps) : 列出你跳转的足迹<br>“ :history : 列出历史命令记录<br>“ :his c : 命令行命令历史<br>“ :his s : 搜索命令历史<br>“ q&#x2F; : 搜索命令历史的窗口<br>“ q: : 命令行命令历史的窗口<br>“ g ctrl+g 计算文件字符<br>“ {,} 前进至上一段落前进至后一段落<br>“ gg,G(2G) 文件首<br>“ gd dw gf ga(进制转化)<br>“ gg&#x3D;G 全篇自动缩进 , &#x3D;G 单行缩进</c-i></c-o></p><p>“* ci[ 删除一对 [] 中的所有字符并进入插入模式<br>“* ci( 删除一对 () 中的所有字符并进入插入模式<br>“* ci&lt; 删除一对 &lt;&gt; 中的所有字符并进入插入模式<br>“* ci{ 删除一对 {} 中的所有字符并进入插入模式<br>“* cit 删除一对 HTML&#x2F;XML 的标签内部的所有字符并进入插入模式<br>“* ci” ci’ ci<code>删除一对引号字符 (” 或 ‘ 或</code>) 中所有字符并进入插入模式<br>“<br>“* vi[ 选择一对 [] 中的所有字符<br>“* vi( 选择一对 () 中的所有字符<br>“* vi&lt; 选择一对 &lt;&gt; 中的所有字符<br>“* vi{ 选择一对 {} 中的所有字符<br>“* vit 选择一对 HTML&#x2F;XML 的标签内部的所有字符<br>“* vi” vi’ vi<code>选择一对引号字符 (” 或 ‘ 或</code>) 中所有字符</p><p>“ crl+] 函数原型处 crl+t 回 ( ctags )<br>“ ctl+p 自动补全( 编辑状态 )<br>“ :X 加密保存( 要输入密码 )<br>“ ? &#x2F; (N n)<br>“ f(F,t) 查找字符<br>“ w(e) 移动光标到下一个单词.<br>“ 5fx 表示查找光标后第 5 个 x 字符.<br>“ 5w(e) 移动光标到下五个单词.</p><p>“ b 移动光标到上一个单词.<br>“ 0 移动光标到本行最开头.<br>“ ^ 移动光标到本行最开头的字符处.<br>“ $ 移动光标到本行结尾处.<br>“ H 移动光标到屏幕的首行.<br>“ M 移动光标到屏幕的中间一行.<br>“ L 移动光标到屏幕的尾行.</p><p>“ c-f (即 ctrl 键与 f 键一同按下)<br>“ c-b (即 ctrl 键与 b 键一同按下) 翻页<br>“ c-d (下半页) c-u(上半页) c-e (一行滚动)<br>“ zz 让光标所在的行居屏幕中央<br>“ zt 让光标所在的行居屏幕最上一行<br>“ zb 让光标所在的行居屏幕最下一行</p><p>“ 在 vi 中 y 表示拷贝, d 表示删除, p 表示粘贴. 其中拷贝与删除是与光标移动命令<br>“ yw 表示拷贝从当前光标到光标所在单词结尾的内容.<br>“ dw 表示删除从当前光标到光标所在单词结尾的内容.<br>“ y0 表示拷贝从当前光标到光标所在行首的内容.<br>“ d0 表示删除从当前光标到光标所在行首的内容.<br>“ y$(Y) 表示拷贝从当前光标到光标所在行尾的内容.<br>“ d$(D) 表示删除从当前光标到光标所在行尾的内容.<br>“ yfa 表示拷贝从当前光标到光标后面的第一个a字符之间的内容.<br>“ dfa 表示删除从当前光标到光标后面的第一个a字符之间的内容.<br>“ s(S),a(A),x(X),D<br>“ yy 表示拷贝光标所在行.<br>“ dd 表示删除光标所在行.</p><p>“ 5yy 表示拷贝光标以下 5 行.<br>“ 5dd 表示删除光标以下 5 行.<br>“ y2fa 表示拷贝从当前光标到光标后面的第二个a字符之间的内容.<br>“ :12,24y 表示拷贝第12行到第24行之间的内容.<br>“ :12,y 表示拷贝第12行到光标所在行之间的内容.<br>“ :,24y 表示拷贝光标所在行到第24行之间的内容. 删除类似.<br>“ TAB 就是制表符, 单独拿出来做一节是因为这个东西确实很有用.<br>“ &lt;&lt; 输入此命令则光标所在行向左移动一个 tab.<br>“ &gt;&gt; 输入此命令则光标所在行向右移动一个 tab.<br>“ 5&gt;&gt; 输入此命令则光标后 5 行向右移动一个 tab.<br>“ :5&gt;&gt;(&gt;&gt;&gt;) :&gt;&gt;(&gt;&gt;&gt;)5<br>“ :12,24&gt; 此命令将12行到14行的数据都向右移动一个 tab.<br>“ :12,24&gt;&gt; 此命令将12行到14行的数据都向右移动两个 tab.<br>“ :set shiftwidth&#x3D;4 设置自动缩进 4 个空格, 当然要设自动缩进先.<br>“ :set sts&#x3D;4 即设置 softtabstop 为 4. 输入 tab 后就跳了 4 格.<br>“ :set tabstop&#x3D;4 实际的 tab 即为 4 个空格, 而不是缺省的 8 个.<br>“ :set expandtab 在输入 tab 后, vim 用恰当的空格来填充这个 tab.<br>“ :g&#x2F;^&#x2F;exec ‘s&#x2F;^&#x2F;‘.strpart(line(‘.’).’ ‘, 0, 4) 在行首插入行号<br>“ set ai 设置自动缩进<br>“ 5ia<esc>重复插入5个a字符</esc></p><p>“&#x2F;*—————————————<em><br>“ 替换命令<br>“&#x2F;</em>—————————————*<br>“ 替换文字 2009-02-34 —-&gt; 2009-02-34 00:00:00<br>“ :%s&#x2F;(\d{4}-\d{2}-\d{2})&#x2F;\1 00:00:00&#x2F;g</p><p>“ :s&#x2F;aa&#x2F;bb&#x2F;g 将光标所在行出现的所有包含 aa 的字符串中的 aa 替换为 bb<br>“ :s&#x2F;/bb&#x2F;g 将光标所在行出现的所有 aa 替换为 bb, 仅替换 aa 这个单词<br>“ :%s&#x2F;aa&#x2F;bb&#x2F;g 将文档中出现的所有包含 aa 的字符串中的 aa 替换为 bb<br>“ :12,23s&#x2F;aa&#x2F;bb&#x2F;g 将从12行到23行中出现的所有包含 aa 的字符串中的 aa 替换为 bb<br>“ :12,23s&#x2F;^&#x2F;#&#x2F; 将从12行到23行的行首加入 # 字符<br>“ :%s&#x2F;fred&#x2F;joe&#x2F;igc 一个常见的替换命令，修饰符igc和perl中一样意思<br>“ s&#x2F;dick&#x2F;joe&#x2F;igc则 对于这些满足条件的行进行替换</p><p>“ :g&#x2F;^\s*$&#x2F;d 空行(空格也不包含)删除.<br>“ :%s&#x2F;\r&#x2F;&#x2F;g 删除DOS方式的回车^M<br>“ :%s&#x2F; <em>$&#x2F;&#x2F; 删除行尾空白(%s&#x2F;\s</em>$&#x2F;&#x2F;g)<br>“ :g!&#x2F;^dd&#x2F;d 删除不含字符串’dd’开头的行<br>“ :v&#x2F;^dd&#x2F;d 同上,译释：v &#x3D;&#x3D; g!，就是不匹配！<br>“ :v&#x2F;.&#x2F;.,&#x2F;.&#x2F;-1join 压缩空行(多行空行合并为一行)<br>“ :g&#x2F;^$&#x2F;,&#x2F;.&#x2F;-j 压缩空行(多行空行合并为一行)<br>“ :g&#x2F;^&#x2F;pu _ 把文中空行扩增一倍 (pu &#x3D; put),原来两行间有一个空行，现在变成2个<br>“ :g&#x2F;^&#x2F;m0 按行翻转文章 (m &#x3D; move)<br>“ :g&#x2F;fred&#x2F;,&#x2F;joe&#x2F;d not line based (very powerfull)<br>“ :g&#x2F;&lt;input|&lt;form&#x2F;p 或者 要用|<br>“ :g&#x2F;fred&#x2F;t$ 拷贝行，从fred到文件末尾(EOF)</p><p>“ :%norm jdd 隔行删除,译释：%指明是对所有行进行操作,norm指出后面是normal模式的指令,j是下移一行，dd是删除行</p><p>“ :’a,’bg&#x2F;fred&#x2F;s&#x2F;dick&#x2F;joe&#x2F;igc (‘a,’b指定一个范围：mark a ~ mark b)<br>“ g&#x2F;&#x2F;用一个正则表达式指出了进行操作的行必须可以被fred匹配,g&#x2F;&#x2F;是一个全局显示命令</p><p>“ &#x2F;joe&#x2F;e 光标停留在匹配单词最后一个字母处<br>“ &#x2F;joe&#x2F;e+1 光标停留在匹配单词最后一个字母的下一个字母处<br>“ &#x2F;joe&#x2F;s 光标停留在匹配单词第一个字母处<br>“ &#x2F;^joe.*fred.*bill&#x2F; 标准正则表达式<br>“ &#x2F;^[A-J]+&#x2F; 找一个以A~J中一个字母重复两次或以上开头的行<br>“ &#x2F;forum(_.)<em>pent 多行匹配<br>“ &#x2F;fred_s</em>joe&#x2F;i 中间可以有任何空白，包括换行符\n<br>“ &#x2F;fred|joe 匹配FRED或JOE<br>“ &#x2F;&lt;fred&gt;&#x2F;i 匹配fred,fred必须是一个独立的单词，而不是子串<br>“ &#x2F;&lt;\d\d\d\d&gt; 匹配4个数字 &lt;\d{4}&gt;</p><p>“ 列，替换所有在第三列中的str1<br>“ :%s:((\w+\s+){2})str1:\1str2:<br>“ 交换第一列和最后一列 (共4列)<br>“ :%s:(\w+)(.*\s+)(\w+)$:\3\2\1:</p><p>“ 全局(global)显示命令，就是用 :g＋正则表达式<br>“ 译释： :g&#x2F;{pattern}&#x2F;{cmd} 就是全局找到匹配的,然后对这些行执行命令{cmd}<br>“ :g&#x2F;&lt;fred&gt;&#x2F; 显示所有能够为单词fred所匹配的行<br>“ :g&#x2F;<pattern>&#x2F;z#.5 显示内容，还有行号<br>“ :g&#x2F;<pattern>&#x2F;z#.5|echo ‘&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;’ 漂亮的显示</pattern></pattern></p><p>“&#x2F;*—————————————<em><br>“ 多文档操作 (基础)<br>“&#x2F;</em>—————————————*<br>“ 用 :ls! 可以显示出当前所有的buffer<br>“ :bn 跳转到下一个buffer<br>“ :bp 跳转到上一个buffer<br>“ :wn 存盘当前文件并跳转到下一个<br>“ :wp 存盘当前文件并跳转到上一个<br>“ :bd 把这个文件从buffer列表中做掉<br>“ :b 3 跳到第3个buffer<br>“ :b main 跳到一个名字中包含main的buffer</p><p>“&#x2F;*—————————————<em><br>“ 列复制<br>“&#x2F;</em>—————————————*<br>“ 译注：@#%&amp;^#*^%#$!<br>“ :%s&#x3D; [^ ]+$&#x3D;&amp;&amp;&#x3D; : 复制最后一列<br>“ :%s&#x3D; \f+$&#x3D;&amp;&amp;&#x3D; : 一样的功能<br>“ :%s&#x3D; \S+$&#x3D;&amp;&amp; : ft,还是一样<br>“ 反向引用，或称记忆<br>“ :s&#x2F;(.*):(.*)&#x2F;\2 : \1&#x2F; : 颠倒用:分割的两个字段<br>“ :%s&#x2F;^(.*)\n\1&#x2F;\1$&#x2F; : 删除重复行<br>“ 非贪婪匹配，{-}<br>“ :%s&#x2F;^.{-}pdf&#x2F;new.pdf&#x2F; : 只是删除第一个pdf<br>“ 跨越可能的多行<br>“ :%s&#x2F;&#x2F;&#x2F; : 又是删除多行注释（咦？为什么要说「又」呢？）<br>“ :help &#x2F;{-} : 看看关于 非贪婪数量符 的帮助<br>“ :s&#x2F;fred&#x2F;<c-r>a&#x2F;g : 替换fred成register a中的内容，呵呵<br>“ 写在一行里的复杂命令<br>“ :%s&#x2F;\f+.gif&gt;&#x2F;\r&amp;\r&#x2F;g | v&#x2F;.gif$&#x2F;d | %s&#x2F;gif&#x2F;jpg&#x2F;<br>“ 译注：就是用 | 管道啦</c-r></p><p>“&#x2F;*—————————————<em><br>“ 大小写转换<br>“&#x2F;</em>—————————————*<br>“ g~~ : 行翻转<br>“ vEU : 字大写(广义字)<br>“ vE~ : 字翻转(广义字)<br>“ ~ 将光标下的字母改变大小写<br>“ 3~ 将下3个字母改变其大小写<br>“ g~w 字翻转<br>“ U 将可视模式下的字母全改成大写字母<br>“ gUU 将当前行的字母改成大写<br>“ u 将可视模式下的字母全改成小写<br>“ guu 将当前行的字母全改成小写<br>“ gUw 将光标下的单词改成大写。<br>“ guw 将光标下的单词改成小写。</p><p>“ 文件浏览<br>“ :Ex : 开启目录浏览器，注意首字母E是大写的<br>“ :Sex : 在一个分割的窗口中开启目录浏览器<br>“ :ls : 显示当前buffer的情况<br>“ :cd .. : 进入父目录<br>“ :pwd<br>“ :args : 显示目前打开的文件<br>“ :lcd %:p:h : 更改到当前文件所在的目录<br>“ 译释：lcd是紧紧改变当前窗口的工作路径，% 是代表当前文件的文件名,<br>“ 加上 :p扩展成全名（就是带了路径），加上 :h析取出路径</p><p>“&#x2F;*&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<em><br>“ END<br>“*&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</em>&#x2F;</p><h3 id="vimrc2"><a href="#vimrc2" class="headerlink" title="vimrc2"></a>vimrc2</h3><p>source ~&#x2F;.vim&#x2F;bundles.vim</p><p>“ encoding dectection<br>set fileencodings&#x3D;utf-8,gb2312,gb18030,gbk,ucs-bom,cp936,latin1</p><p>“ enable filetype dectection and ft specific plugin&#x2F;indent<br>filetype plugin indent on</p><p>“ enable syntax hightlight and completion<br>syntax on</p><p>“——–<br>“ Vim UI<br>“——–<br>“ color scheme<br>set background&#x3D;dark<br>color solarized</p><p>“ highlight current line<br>au WinLeave * set nocursorline nocursorcolumn<br>au WinEnter * set cursorline cursorcolumn<br>set cursorline cursorcolumn</p><p>“ search<br>set incsearch<br>“set highlight “ conflict with highlight current line<br>set ignorecase<br>set smartcase</p><p>“ editor settings<br>set history&#x3D;1000<br>set nocompatible<br>set nofoldenable “ disable folding”<br>set confirm “ prompt when existing from an unsaved file<br>set backspace&#x3D;indent,eol,start “ More powerful backspacing<br>set t_Co&#x3D;256 “ Explicitly tell vim that the terminal has 256 colors “<br>set mouse&#x3D;a “ use mouse in all modes<br>set report&#x3D;0 “ always report number of lines changed “<br>set nowrap “ dont wrap lines<br>set scrolloff&#x3D;5 “ 5 lines above&#x2F;below cursor when scrolling<br>set number “ show line numbers<br>set showmatch “ show matching bracket (briefly jump)<br>set showcmd “ show typed command in status bar<br>set title “ show file in titlebar<br>set laststatus&#x3D;2 “ use 2 lines for the status bar<br>set matchtime&#x3D;2 “ show matching bracket for 0.2 seconds<br>set matchpairs+&#x3D;&lt;:&gt; “ specially for html<br>“ set relativenumber</p><p>“ Default Indentation<br>set autoindent<br>set smartindent “ indent when<br>set tabstop&#x3D;4 “ tab width<br>set softtabstop&#x3D;4 “ backspace<br>set shiftwidth&#x3D;4 “ indent width<br>“ set textwidth&#x3D;79<br>“ set smarttab<br>set expandtab “ expand tab to space</p><p>autocmd FileType php setlocal tabstop&#x3D;2 shiftwidth&#x3D;2 softtabstop&#x3D;2 textwidth&#x3D;120<br>autocmd FileType ruby setlocal tabstop&#x3D;2 shiftwidth&#x3D;2 softtabstop&#x3D;2 textwidth&#x3D;120<br>autocmd FileType php setlocal tabstop&#x3D;4 shiftwidth&#x3D;4 softtabstop&#x3D;4 textwidth&#x3D;120<br>autocmd FileType coffee,javascript setlocal tabstop&#x3D;2 shiftwidth&#x3D;2 softtabstop&#x3D;2 textwidth&#x3D;120<br>autocmd FileType python setlocal tabstop&#x3D;4 shiftwidth&#x3D;4 softtabstop&#x3D;4 textwidth&#x3D;120<br>autocmd FileType html,htmldjango,xhtml,haml setlocal tabstop&#x3D;2 shiftwidth&#x3D;2 softtabstop&#x3D;2 textwidth&#x3D;0<br>autocmd FileType sass,scss,css setlocal tabstop&#x3D;2 shiftwidth&#x3D;2 softtabstop&#x3D;2 textwidth&#x3D;120</p><p>“ syntax support<br>autocmd Syntax javascript set syntax&#x3D;jquery “ JQuery syntax support<br>“ js<br>let g:html_indent_inctags &#x3D; “html,body,head,tbody”<br>let g:html_indent_script1 &#x3D; “inc”<br>let g:html_indent_style1 &#x3D; “inc”</p><p>“—————–<br>“ Plugin settings<br>“—————–<br>“ Rainbow parentheses for Lisp and variants<br>let g:rbpt_colorpairs &#x3D; [<br>\ [‘brown’, ‘RoyalBlue3’],<br>\ [‘Darkblue’, ‘SeaGreen3’],<br>\ [‘darkgray’, ‘DarkOrchid3’],<br>\ [‘darkgreen’, ‘firebrick3’],<br>\ [‘darkcyan’, ‘RoyalBlue3’],<br>\ [‘darkred’, ‘SeaGreen3’],<br>\ [‘darkmagenta’, ‘DarkOrchid3’],<br>\ [‘brown’, ‘firebrick3’],<br>\ [‘gray’, ‘RoyalBlue3’],<br>\ [‘black’, ‘SeaGreen3’],<br>\ [‘darkmagenta’, ‘DarkOrchid3’],<br>\ [‘Darkblue’, ‘firebrick3’],<br>\ [‘darkgreen’, ‘RoyalBlue3’],<br>\ [‘darkcyan’, ‘SeaGreen3’],<br>\ [‘darkred’, ‘DarkOrchid3’],<br>\ [‘red’, ‘firebrick3’],<br>\ ]<br>let g:rbpt_max &#x3D; 16<br>autocmd Syntax lisp,scheme,clojure,racket RainbowParenthesesToggle</p><p>“ tabbar<br>let g:Tb_MaxSize &#x3D; 2<br>let g:Tb_TabWrap &#x3D; 1</p><p>hi Tb_Normal guifg&#x3D;white ctermfg&#x3D;white<br>hi Tb_Changed guifg&#x3D;green ctermfg&#x3D;green<br>hi Tb_VisibleNormal ctermbg&#x3D;252 ctermfg&#x3D;235<br>hi Tb_VisibleChanged guifg&#x3D;green ctermbg&#x3D;252 ctermfg&#x3D;white</p><p>“ easy-motion<br>let g:EasyMotion_leader_key &#x3D; ‘<leader>‘</leader></p><p>“ Tagbar<br>let g:tagbar_left&#x3D;1<br>let g:tagbar_width&#x3D;30<br>let g:tagbar_autofocus &#x3D; 1<br>let g:tagbar_sort &#x3D; 0<br>let g:tagbar_compact &#x3D; 1<br>“ tag for coffee<br>if executable(‘coffeetags’)<br>let g:tagbar_type_coffee &#x3D; {<br>\ ‘ctagsbin’ : ‘coffeetags’,<br>\ ‘ctagsargs’ : ‘’,<br>\ ‘kinds’ : [<br>\ ‘f:functions’,<br>\ ‘o:object’,<br>\ ],<br>\ ‘sro’ : “.”,<br>\ ‘kind2scope’ : {<br>\ ‘f’ : ‘object’,<br>\ ‘o’ : ‘object’,<br>\ }<br>\ }</p><p>let g:tagbar_type_markdown &#x3D; {<br>\ ‘ctagstype’ : ‘markdown’,<br>\ ‘sort’ : 0,<br>\ ‘kinds’ : [<br>\ ‘h:sections’<br>\ ]<br>\ }<br>endif</p><p>“ Nerd Tree<br>let NERDChristmasTree&#x3D;0<br>let NERDTreeWinSize&#x3D;30<br>let NERDTreeChDirMode&#x3D;2<br>let NERDTreeIgnore&#x3D;[‘~$’, ‘.pyc$’, ‘.swp$’]<br>“ let NERDTreeSortOrder&#x3D;[‘^__.py$’, ‘/$’, ‘*’, ‘.swp$’, ‘~$’]<br>let NERDTreeShowBookmarks&#x3D;1<br>let NERDTreeWinPos &#x3D; “right”</p><p>“ nerdcommenter<br>let NERDSpaceDelims&#x3D;1<br>“ nmap<d->:NERDComToggleComment<cr><br>let NERDCompactSexyComs&#x3D;1</cr></p><p>“ ZenCoding<br>let g:user_emmet_expandabbr_key&#x3D;’<c-j>‘</c-j></p><p>“ powerline<br>“let g:Powerline_symbols &#x3D; ‘fancy’</p><p>“ NeoComplCache<br>let g:neocomplcache_enable_at_startup&#x3D;1<br>let g:neoComplcache_disableautocomplete&#x3D;1<br>“let g:neocomplcache_enable_underbar_completion &#x3D; 1<br>“let g:neocomplcache_enable_camel_case_completion &#x3D; 1<br>let g:neocomplcache_enable_smart_case&#x3D;1<br>let g:neocomplcache_min_syntax_length &#x3D; 3<br>let g:neocomplcache_lock_buffer_name_pattern &#x3D; ‘*ku*‘<br>set completeopt-&#x3D;preview</p><p>imap<c-k><plug>(neocomplcache_snippets_force_expand)<br>smap<c-k><plug>(neocomplcache_snippets_force_expand)<br>imap<c-l><plug>(neocomplcache_snippets_force_jump)<br>smap<c-l><plug>(neocomplcache_snippets_force_jump)</plug></c-l></plug></c-l></plug></c-k></plug></c-k></p><p>“ Enable omni completion.<br>autocmd FileType css setlocal omnifunc&#x3D;csscomplete#CompleteCSS<br>autocmd FileType html,markdown setlocal omnifunc&#x3D;htmlcomplete#CompleteTags<br>autocmd FileType javascript setlocal omnifunc&#x3D;javascriptcomplete#CompleteJS<br>autocmd FileType python setlocal omnifunc&#x3D;pythoncomplete#Complete<br>autocmd FileType c setlocal omnifunc&#x3D;ccomplete#Complete<br>if !exists(‘g:neocomplcache_omni_patterns’)<br>let g:neocomplcache_omni_patterns &#x3D; {}<br>endif<br>let g:neocomplcache_omni_patterns.erlang &#x3D; ‘[a-zA-Z]|:’</p><p>“ SuperTab<br>“ let g:SuperTabDefultCompletionType&#x3D;’context’<br>let g:SuperTabDefaultCompletionType &#x3D; ‘<c-x><c-u>‘<br>let g:SuperTabRetainCompletionType&#x3D;2</c-u></c-x></p><p>“ ctrlp<br>set wildignore+&#x3D;<em>&#x2F;tmp&#x2F;</em>,<em>.so,</em>.o,<em>.a,</em>.obj,<em>.swp,</em>.zip,<em>.pyc,</em>.pyo,*.class,.DS_Store “ MacOSX&#x2F;Linux<br>let g:ctrlp_custom_ignore &#x3D; ‘.git$|.hg$|.svn$’</p><p>“ Keybindings for plugin toggle<br>nnoremap<f2>:set invpaste paste?<cr><br>set pastetoggle&#x3D;<f2><br>nmap<f5>:TagbarToggle<cr><br>nmap<f6>:NERDTreeToggle<cr><br>nmap<f3>:GundoToggle<cr><br>nmap<f4>:IndentGuidesToggle<cr><br>nmap<d->:<br>nnoremap<leader>a :Ack<br>nnoremap<leader>v V&#96;]</leader></leader></cr></f4></cr></f3></cr></f6></cr></f5></f2></cr></f2></p><p>“——————<br>“ Useful Functions<br>“——————<br>“ easier navigation between split windows<br>nnoremap<c-j><c-w>j<br>nnoremap<c-k><c-w>k<br>nnoremap<c-h><c-w>h<br>nnoremap<c-l><c-w>l</c-w></c-l></c-w></c-h></c-w></c-k></c-w></c-j></p><p>“ When editing a file, always jump to the last cursor position<br>autocmd BufReadPost *<br>\ if ! exists(“g:leave_my_cursor_position_alone”) |<br>\ if line(“‘&quot;“) &gt; 0 &amp;&amp; line (“‘&quot;“) &lt;&#x3D; line(“$”) |<br>\ exe “normal g’&quot;“ |<br>\ endif |<br>\ endif</p><p>“ w!! to sudo &amp; write a file<br>cmap w!! %!sudo tee &gt;&#x2F;dev&#x2F;null %</p><p>“ Quickly edit&#x2F;reload the vimrc file<br>nmap<silent><leader>ev :e $MYVIMRC<cr><br>nmap<silent><leader>sv :so $MYVIMRC<cr></cr></leader></silent></cr></leader></silent></p><p>“ sublime key bindings<br>nmap &lt;D-]&gt; &gt;&gt;<br>nmap &lt;D-[&gt; &lt;&lt;<br>vmap &lt;D-[&gt; &lt;gv<br>vmap &lt;D-]&gt; &gt;gv</p><p>“ eggcache vim<br>nnoremap ; :<br>:command W w<br>:command WQ wq<br>:command Wq wq<br>:command Q q<br>:command Qa qa<br>:command QA qa</p><p>“ for macvim<br>if has(“gui_running”)<br>set go&#x3D;aAce “ remove toolbar<br>“set transparency&#x3D;30<br>set guifont&#x3D;Monaco:h13<br>set showtabline&#x3D;2<br>set columns&#x3D;140<br>set lines&#x3D;40<br>noremap<d-m-left>:tabprevious<cr><br>noremap<d-m-right>:tabnext<cr><br>map<d-1>1gt<br>map<d-2>2gt<br>map<d-3>3gt<br>map<d-4>4gt<br>map<d-5>5gt<br>map<d-6>6gt<br>map<d-7>7gt<br>map<d-8>8gt<br>map<d-9>9gt<br>map<d-0>:tablast<cr><br>endif</cr></d-0></d-9></d-8></d-7></d-6></d-5></d-4></d-3></d-2></d-1></cr></d-m-right></cr></d-m-left></p><h3 id="vimrc3"><a href="#vimrc3" class="headerlink" title="vimrc3"></a>vimrc3</h3><p>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ 搜索和匹配<br>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ 高亮显示匹配的括号<br>set showmatch</p><p>“ 匹配括号高亮的时间（单位是十分之一秒）<br>set matchtime&#x3D;5</p><p>“ 在搜索的时候忽略大小写<br>set ignorecase</p><p>“ 不要高亮被搜索的句子（phrases）<br>set nohlsearch</p><p>“ 在搜索时，输入的词句的逐字符高亮（类似firefox的搜索）<br>set incsearch</p><p>“ 输入:set list命令是应该显示些啥？<br>set listchars&#x3D;tab:|\ ,trail:.,extends:&gt;,precedes:&lt;,eol:$</p><p>“ 光标移动到buffer的顶部和底部时保持3行距离<br>set scrolloff&#x3D;3</p><p>“ 总是显示状态行<br>set laststatus&#x3D;2</p><p>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ 文本格式和排版<br>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ 自动格式化<br>set formatoptions&#x3D;tcrqn</p><p>“ 继承前一行的缩进方式，特别适用于多行注释<br>set autoindent</p><p>“ 为C程序提供自动缩进<br>set smartindent</p><p>“ 使用C样式的缩进<br>set cindent</p><p>“ 制表符为4<br>set tabstop&#x3D;4</p><p>“ 统一缩进为4<br>set softtabstop&#x3D;4<br>set shiftwidth&#x3D;4</p><p>“ 不要用空格代替制表符<br>set noexpandtab</p><p>“ 不要换行<br>set nowrap</p><p>“ 在行和段开始处使用制表符<br>set smarttab</p><p>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ Autocommands<br>“””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””””<br>“ 只在下列文件类型被侦测到的时候显示行号，普通文本文件不显示</p><p>if has(“autocmd”)<br>autocmd FileType xml,html,c,cs,java,perl,shell,bash,cpp,python,vim,php,ruby set number<br>autocmd FileType xml,html vmap<c-o><esc>‘&lt;i<br>autocmd FileType java,c,cpp,cs vmap<c-o><esc>‘&lt;o<br>autocmd FileType html,text,php,vim,c,java,xml,bash,shell,perl,python setlocal textwidth&#x3D;100<br>autocmd Filetype html,xml,xsl source $VIMRUNTIME&#x2F;plugin&#x2F;closetag.vim<br>autocmd BufReadPost *<br>\ if line(“‘&quot;“) &gt; 0 &amp;&amp; line(“‘&quot;“) &lt;&#x3D; line(“$”) |<br>\ exe “ normal g&#96;&quot;“ |<br>\ endif<br>endif “has(“autocmd”)</esc></c-o></esc></c-o></p><p>“ F5编译和运行C程序，F6编译和运行C++程序<br>“ 请注意，下述代码在windows下使用会报错<br>“ 需要去掉.&#x2F;这两个字符</p><p>“ C的编译和运行<br>map<f5>:call CompileRunGcc()<cr><br>func! CompileRunGcc()<br>exec “w”<br>exec “!gcc % -o %&lt;”<br>exec “! .&#x2F;%&lt;”<br>endfunc</cr></f5></p><p>“ C++的编译和运行<br>map<f6>:call CompileRunGpp()<cr><br>func! CompileRunGpp()<br>exec “w”<br>exec “!g++ % -o %&lt;”<br>exec “! .&#x2F;%&lt;”<br>endfunc</cr></f6></p><p>“ 能够漂亮地显示.NFO文件<br>set encoding&#x3D;utf-8<br>function! SetFileEncodings(encodings)<br>let b:myfileencodingsbak&#x3D;&amp;fileencodings<br>let &amp;fileencodings&#x3D;a:encodings<br>endfunction<br>function! RestoreFileEncodings()<br>let &amp;fileencodings&#x3D;b:myfileencodingsbak<br>unlet b:myfileencodingsbak<br>endfunction</p><p>au BufReadPre *.nfo call SetFileEncodings(‘cp437’)|set ambiwidth&#x3D;single au BufReadPost *.nfo call RestoreFileEncodings()</p><p>“ 用空格键来开关折叠<br>set foldenable<br>set foldmethod&#x3D;manual<br>nnoremap<space>@&#x3D;((foldclosed(line(‘.’)) &lt; 0) ? ‘zc’:’zo’)<cr></cr></space></p></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Janvy Sun</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">154</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/janvysun" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:janvusun@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/lyrics/1f1e25e2-0756-4881-9cc2-b146d03c0ae6.html" title="世界が終るまでは…"><img src="/images/hexo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="世界が終るまでは…"></a><div class="content"><a class="title" href="/lyrics/1f1e25e2-0756-4881-9cc2-b146d03c0ae6.html" title="世界が終るまでは…">世界が終るまでは…</a><time datetime="2024-04-20T16:00:00.000Z" title="发表于 2024-04-21 00:00:00">2024-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/games/bdac0118-3bf7-43f9-9856-142e616b1ca4.html" title="我的世界攻略"><img src="/images/hexo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="我的世界攻略"></a><div class="content"><a class="title" href="/games/bdac0118-3bf7-43f9-9856-142e616b1ca4.html" title="我的世界攻略">我的世界攻略</a><time datetime="2024-03-31T16:00:00.000Z" title="发表于 2024-04-01 00:00:00">2024-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/elk/3d7c2057-e448-4b83-a185-8d98e973490e.html" title="Nginx 的安装与使用"><img src="/images/hexo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Nginx 的安装与使用"></a><div class="content"><a class="title" href="/elk/3d7c2057-e448-4b83-a185-8d98e973490e.html" title="Nginx 的安装与使用">Nginx 的安装与使用</a><time datetime="2024-03-10T16:00:00.000Z" title="发表于 2024-03-11 00:00:00">2024-03-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/games/967c02f7-0d5e-4dd8-a2e0-70c97840fc5d.html" title="真三国无双 7 攻略"><img src="/images/hexo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="真三国无双 7 攻略"></a><div class="content"><a class="title" href="/games/967c02f7-0d5e-4dd8-a2e0-70c97840fc5d.html" title="真三国无双 7 攻略">真三国无双 7 攻略</a><time datetime="2024-02-29T16:00:00.000Z" title="发表于 2024-03-01 00:00:00">2024-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/docker/4c765195-289e-4cc4-88fb-12d9bb5fed61.html" title="Docker Compose 使用"><img src="/images/hexo.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Docker Compose 使用"></a><div class="content"><a class="title" href="/docker/4c765195-289e-4cc4-88fb-12d9bb5fed61.html" title="Docker Compose 使用">Docker Compose 使用</a><time datetime="2023-12-31T16:00:00.000Z" title="发表于 2024-01-01 00:00:00">2024-01-01</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline"><i class="fas fa-folder-open"></i> <span>分类</span> <a class="card-more-btn" href="/categories/" title="查看更多"><i class="fas fa-angle-right"></i></a></div><ul class="card-category-list" id="aside-cat-list"><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/C/"><span class="card-category-list-name">C++</span><span class="card-category-list-count">22</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Database/"><span class="card-category-list-name">Database</span><span class="card-category-list-count">7</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/DesignPattern/"><span class="card-category-list-name">DesignPattern</span><span class="card-category-list-count">25</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Docker/"><span class="card-category-list-name">Docker</span><span class="card-category-list-count">7</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Games/"><span class="card-category-list-name">Games</span><span class="card-category-list-count">2</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Java/"><span class="card-category-list-name">Java</span><span class="card-category-list-count">21</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Linux/"><span class="card-category-list-name">Linux</span><span class="card-category-list-count">15</span></a></li><li class="card-category-list-item"><a class="card-category-list-link" href="/categories/Other/"><span class="card-category-list-name">Other</span><span class="card-category-list-count">7</span></a></li></ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Bash/" style="font-size:1.17em;color:#999ca0">Bash</a> <a href="/tags/C/" style="font-size:1.1em;color:#999">C++</a> <a href="/tags/CAS/" style="font-size:1.32em;color:#99a2ae">CAS</a> <a href="/tags/CMake/" style="font-size:1.25em;color:#999fa7">CMake</a> <a href="/tags/Clang-Format/" style="font-size:1.1em;color:#999">Clang-Format</a> <a href="/tags/Clion/" style="font-size:1.14em;color:#999a9c">Clion</a> <a href="/tags/DB2/" style="font-size:1.17em;color:#999ca0">DB2</a> <a href="/tags/Docker/" style="font-size:1.35em;color:#99a3b1">Docker</a> <a href="/tags/ELK/" style="font-size:1.17em;color:#999ca0">ELK</a> <a href="/tags/Exception/" style="font-size:1.1em;color:#999">Exception</a> <a href="/tags/Git/" style="font-size:1.32em;color:#99a2ae">Git</a> <a href="/tags/GitHub/" style="font-size:1.1em;color:#999">GitHub</a> <a href="/tags/IDEA/" style="font-size:1.14em;color:#999a9c">IDEA</a> <a href="/tags/Java/" style="font-size:1.5em;color:#99a9bf">Java</a> <a href="/tags/Linux/" style="font-size:1.46em;color:#99a8bc">Linux</a> <a href="/tags/Lyrics/" style="font-size:1.28em;color:#99a0aa">Lyrics</a> <a href="/tags/Markdown/" style="font-size:1.1em;color:#999">Markdown</a> <a href="/tags/Maven/" style="font-size:1.21em;color:#999da3">Maven</a> <a href="/tags/MongoDB/" style="font-size:1.1em;color:#999">MongoDB</a> <a href="/tags/MySQL/" style="font-size:1.1em;color:#999">MySQL</a> <a href="/tags/Nacos/" style="font-size:1.1em;color:#999">Nacos</a> <a href="/tags/Nginx/" style="font-size:1.1em;color:#999">Nginx</a> <a href="/tags/Python/" style="font-size:1.43em;color:#99a6b8">Python</a> <a href="/tags/QT/" style="font-size:1.14em;color:#999a9c">QT</a> <a href="/tags/Redis/" style="font-size:1.1em;color:#999">Redis</a> <a href="/tags/SQL/" style="font-size:1.1em;color:#999">SQL</a> <a href="/tags/STL/" style="font-size:1.17em;color:#999ca0">STL</a> <a href="/tags/Selenium/" style="font-size:1.1em;color:#999">Selenium</a> <a href="/tags/Spring-Boot/" style="font-size:1.39em;color:#99a5b5">Spring Boot</a> <a href="/tags/UML/" style="font-size:1.1em;color:#999">UML</a> <a href="/tags/Ubuntu/" style="font-size:1.1em;color:#999">Ubuntu</a> <a href="/tags/Vim/" style="font-size:1.32em;color:#99a2ae">Vim</a> <a href="/tags/Vue/" style="font-size:1.1em;color:#999">Vue</a> <a href="/tags/bash/" style="font-size:1.1em;color:#999">bash</a> <a href="/tags/html/" style="font-size:1.1em;color:#999">html</a> <a href="/tags/node-js/" style="font-size:1.1em;color:#999">node.js</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size:1.1em;color:#999">并发编程</a> <a href="/tags/%E6%8C%87%E9%92%88/" style="font-size:1.25em;color:#999fa7">指针</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:1.1em;color:#999">正则表达式</a> <a href="/tags/%E6%B3%A8%E9%87%8A/" style="font-size:1.1em;color:#999">注释</a></div></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">154</div></div><div class="webinfo-item"><div class="item-name">已运行时间 :</div><div class="item-count" id="runtimeshow" data-publishdate="2018-03-01T16:00:00.000Z"></div></div><div class="webinfo-item"><div class="item-name">本站总字数 :</div><div class="item-count">365.4k</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastpushdate="2024-08-10T13:15:46.197Z"></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2024 By Janvy Sun</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>